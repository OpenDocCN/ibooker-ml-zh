# 第九章：实践中的 MLOps：消费者信贷风险管理

在本书的最后几章中，我们探讨了三个 MLOps 在实践中可能的例子。我们明确选择了这三个例子，因为它们代表了机器学习的根本不同的用例，并展示了 MLOps 方法论如何根据业务需求和其机器学习模型生命周期实践的不同而不同。

# 背景：业务用例

当消费者申请贷款时，信贷机构必须决定是否批准贷款。根据具体情况，流程中的自动化程度可能有所不同。然而，决策很可能是基于估计贷款是否按预期偿还的分数而作出的。

分数通常在流程的不同阶段被常规使用：

+   在预筛选阶段，使用少量特征计算的分数允许机构快速丢弃一些申请。

+   在承保阶段，使用所有必要信息计算的分数为决策提供了更精确的依据。

+   在承保阶段，分数可以用来评估贷款组合中的风险。

几十年来，分析方法已被用来计算这些概率。例如，FICO 分数自 1995 年起在美国被广泛使用。考虑到它们直接影响机构的收入和客户的生活，这些预测模型一直受到严格审视。因此，流程、方法和技能已经被正式纳入高度监管的环境中，以确保模型的可持续性表现。

无论模型是基于专家制定的规则、传统统计模型，还是更近期的机器学习算法，它们都必须遵守类似的法规。因此，消费者信贷风险管理可以被视为 MLOps 的先驱：可以基于此用例分析与其他用例及最佳实践的类似之处。

在做出信贷决策时，通常可以获取客户历史和当前情况的信息。客户持有多少信贷？客户是否曾经未能偿还贷款（在信贷行话中，客户是否有逾期情况）？在一些国家，称为信用局的组织收集这些信息，并直接或通过分数的形式向债权人提供。

被预测的目标定义更加复杂。在信用风险建模中，顾客未如预期般偿还被视为“坏”结果。理论上，应该等到完全偿还才确定“好”结果，并等到损失核销确定“坏”结果。然而，获取这些最终数据可能需要很长时间，并且等待它们可能会阻碍对变化条件的反应。因此，通常会根据各种指标进行权衡，以在损失确凿之前宣布“坏”结果。

# 模型开发

历史上，信用风险建模基于一套规则（在现代机器学习术语中称为“手动特征工程”）和逻辑回归的混合。专家知识对于创建一个良好的模型至关重要。建立适应性客户分割以及研究每个变量及其之间的相互影响需要大量的时间和精力。结合像两阶段模型与偏移、基于 Tweedie 分布的高级广义线性模型或单调性约束等先进技术，以及金融风险管理技术，这使得该领域成为精算师的乐园。

梯度提升算法如 XGBoost 已经降低了构建良好模型的成本。然而，由于黑箱效应，验证它们变得更加复杂：很难感受到这些模型无论输入什么数据都能给出合理的结果。尽管如此，信用风险建模者已经学会使用和验证这些新型模型。他们已经开发了基于个体解释（如 Shapley 值）的新验证方法，以建立对模型的信任，这是 MLOps 的关键组成部分，正如我们在本书中所探讨的。

# 模型偏差考虑

模型构建者还必须考虑选择偏差，因为该模型不可避免地用于拒绝申请者。因此，贷款授予的人群并不代表申请人群。

通过在先前模型版本选择的人群上训练模型版本，数据科学家可能会使模型无法准确预测被拒绝的人群，因为这些人群在训练数据集中没有被充分代表，而这正是模型期望的情况。这种效应被称为樱桃拣选。因此，必须使用特殊方法，如基于申请人群的重新加权或基于外部数据校准模型。

用于风险评估而不仅仅是决定贷款授予的模型必须产生概率，而不仅仅是是/否结果。通常情况下，预测模型直接生成的概率并不准确。如果数据科学家应用阈值处理以获取二元分类，这不是问题，但他们通常需要一个称为*校准*的单调转换来恢复基于历史数据评估的“真实”概率。

对于这种用例，模型验证通常包括：

+   在训练数据集之后（或在某些情况下，甚至在之前），在样本外数据集上测试其性能。

+   不仅对整体性能进行调查，还对亚群体进行调查。亚群体通常基于收入进行客户细分，并随着负责任 AI 的兴起，根据当地法规的保护属性进行其他分段变量的分析，如性别或任何受保护属性。不这样做可能会导致严重的损害，就像苹果在 2019 年学到的那样，当其信用卡据称对申请信贷的女性[“存在性别歧视”](https://oreil.ly/iO3yj)。

# 准备生产环境

鉴于信用风险模型的重大影响，其验证过程涉及对生命周期建模部分的重要工作，并包括以下内容的完整文档：

+   使用的数据

+   建模和构建模型所做的假设

+   验证方法和验证结果

+   监控方法

在这种情况下，监控方法是双重的：数据漂移和性能漂移。由于预测与获得实际结果之间的延迟较长（通常为贷款期限加上几个月以考虑逾期付款），仅监控模型性能是不够的：还必须仔细监控数据漂移。

例如，如果发生经济衰退或商业政策改变，申请人群体可能会发生变化，使得模型的性能无法在没有进一步验证的情况下得到保证。数据漂移通常通过客户细分进行，使用通用统计指标来测量概率分布之间的距离（如 Kolmogorov-Smirnov 或 Wasserstein 距离），以及金融服务专用的指标，如人口稳定指数和特征稳定指数来进行监测。[性能漂移也经常使用通用指标（AUC）或特定指标（Kolmogorov-Smirnov、Gini）](https://oreil.ly/1-7kd) 对亚群体进行评估。

模型文档通常由 MRM 团队进行非常正式和独立的审查流程。这种独立审查是确保向模型开发团队提出正确问题的良好实践。在某些关键情况下，验证团队可能根据文档重新构建模型。在某些情况下，第二次实施采用替代技术，以确立对模型文档理解的信心，并突出原始工具集中未见的错误。

复杂且耗时的模型验证过程对整个 MLOps 生命周期有重要影响。这样漫长的质量保证过程不可能通过快速修复和迅速的模型迭代来解决，导致 MLOps 生命周期非常缓慢而审慎。

# 部署到生产环境

在典型的大型金融服务组织中，生产环境不仅与设计环境分离，而且可能基于不同的技术栈。用于关键操作（如交易验证，也可能是贷款验证）的技术栈将始终缓慢演变。

从历史上看，生产环境主要支持规则和线性模型，如逻辑回归。有些可以处理更复杂的模型，如 PMML 或 JAR 文件。对于较不关键的用例，可能可以通过 Docker 部署或通过集成的数据科学和机器学习平台进行部署。因此，模型的操作化可能涉及从点击按钮到根据 Microsoft Word 文档编写公式的操作。

部署模型的活动日志对于监控此类高价值用例中的模型性能至关重要。根据监控频率的不同，反馈循环可能是自动化的，也可能不是。例如，如果任务仅需每年一两次执行，并且大部分时间用于对数据提问，那么自动化可能是不必要的。另一方面，如果评估每周进行，如几个月的短期贷款可能的情况，自动化可能是至关重要的。

# 总结思考

多年来，金融服务业一直在开发预测模型验证和监控方案。他们能够不断适应像梯度提升方法这样的新建模技术。鉴于其重要影响，围绕这些模型的生命周期管理流程被良好形式化，甚至被整合到许多法规中。因此，它们可以成为其他领域 MLOps 最佳实践的源泉，尽管需要在其他业务中权衡健壮性与成本效益、价值时间以及团队沮丧之间的权衡。
