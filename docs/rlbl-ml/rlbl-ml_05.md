# 第四章：特征和训练数据

作者：Robbie Sedgewick 和 Todd Underwood

到这一点应该很明确，模型来自数据。本章讨论的是数据：它是如何创建、处理、标注、存储以及最终用于创建模型的。您将看到，管理和处理数据为可重复性、可管理性和可靠性带来了特定的挑战，我们将就如何应对这些挑战提出一些具体建议。如需背景知识，请确保参阅（如果尚未阅读）第二章和第三章。

本章涵盖了接收来自源头数据并为训练系统准备数据的基础设施。我们将讨论涉及此任务的三个基本功能子系统：特征系统、人类标注系统和元数据系统。我们在上一章节已经稍微讨论了特征；另一种思考方式是，它们是输入数据的特征，特别是我们确定与我们关心的某些事物有预测性的特征。标签是我们最终要训练的模型所需的特定输出案例。它们用作训练模型的示例。另一种思考标签的方式是，它们是模型将学习的特定数据实例的目标或“正确”值。标签可以通过将数据与另一个独立事件相关联的日志中提取，或者可以由人类生成。我们将讨论在规模上生成人类标签所需的系统，通常称为*标注*。最后，我们将简要介绍元数据系统，该系统跟踪其他系统的工作细节，并对使它们可重复和可靠至关重要。

这些系统的几个方面通常在特征和数据系统之间共享，尤其是元数据系统。由于*元数据*（关于我们正在收集和标注的数据的数据）在我们知道如何处理数据之后才能更好地理解，所以我们将在探讨了特征和标签系统的要求和特征之后讨论这些系统。

# 特征

数据就是数据。特征是使其对机器学习有用的因素。¹ *特征*是我们确定在实现模型目标中有用的数据的任何方面。这里，“我们”包括构建模型的人类，或者很多时候现在可以包括自动特征工程系统。换句话说，特征是数据的具体可测量的方面，或者是其功能。

特征用于构建模型。它们是将模型与用于组装模型的数据连接起来的结构。此前我们曾说过，模型是一组规则，它接受数据并用它来生成关于世界的预测。这对于模型架构和配置过的模型都是正确的。但是训练过的模型在很大程度上是一个组合特征的公式（基本上是用于从真实数据中提取特征值的特征定义——我们稍后在本章中更全面地讨论这个定义）。特征通常不仅仅是原始数据的片段，而是涉及某种预处理过程。

这些具体的特征示例应该能提供一些关于它们的直觉：

+   从网络日志中获取有关客户的信息（例如，浏览器类型）。

+   人类输入到应用程序中的文本中的单个词或词组。

+   图像中的所有像素集合，或其结构化子集。

+   加载页面时客户位置的当前天气情况。

+   任何特征的组合或变换本身也可以成为一种特征。

通常，特征包含从底层训练数据中提取的较小结构化数据部分。随着建模技术的不断发展，更多的特征可能开始类似于原始数据，而不是这些提取的元素。例如，当前在文本上进行训练的模型可能会训练单词或单词的组合，但我们预期未来会看到更多对段落甚至整篇文档的训练。当然，这对建模有重要影响，但是构建生产型 ML 系统的人员也应该意识到训练数据增加和结构变得更少对系统的影响。

在 YarnIt，我们有几个模型，其中一个模型是在客户在网站上购物时为不同或额外的产品提供建议。这个推荐模型在购物会话期间由网页应用程序调用，无论是客户正在查看单个产品的主产品页面，还是在购物车确认页面上，当客户刚刚将产品添加到购物车中时。Web 服务器调用模型询问在这些情况下应向该客户显示哪些附加产品，希望能够向客户展示他们可能需要或想要的其他东西，并增加我们对该客户的销售。

在这种情况下，我们可能会考虑以下一些有用的特征，我们希望模型在查询附加产品时能够使用这些特征：

+   产品页面或购物车确认页面。用户是在浏览还是购买？

+   用户当前查看的产品，包括来自当前产品名称、可能来自当前产品图片的信息，产品类别、制造商和价格的信息。

+   如果我们知道顾客的平均购买金额或每年的总购买量，这可能是顾客支出程度的指标。

+   编织者还是钩针者？有些顾客从不钩针，而其他人则只钩针。了解这一点可能有助于我们推荐正确的纱线、针和图案。我们可以让顾客自我确认这一特征，也可以根据之前的购买或浏览行为进行推断。

+   顾客的国家。某些产品可能只在某些地方流行。而且有些国家比其他国家更冷，这可能是一个信号。

这些只是一些想法，以体现特征可能的范围。重要的是要注意，在没有实际数据的情况下，我们不知道这些特征是否有用。它们看起来确实可能有帮助，但许多看似有效的特征实际上并不奏效。大多数情况下，这些特征只能稍微预测，并且它们预测的东西可能被我们已有的另一个特征更好地预测。在这些情况下，新特征只增加了成本和复杂性，但并没有增加任何价值。请记住，特征会在系统的许多部分增加维护成本，而这些成本会一直存在，直到特征被移除。我们应该谨慎添加新特征，特别是那些依赖于新数据源或数据源，现在必须被监控和维护的特征。

在我们进一步讨论之前，我们需要澄清“特征”这个术语的两个完全不同的用法及其区别：

特征定义

这是描述我们从底层数据中提取信息的代码（或算法或其他书面描述）。但它不是该数据被提取的任何特定实例。例如，“当前顾客的源国家由取得顾客的源 IP 地址并在地理位置数据服务中查找而获得”是一个特征定义。例如，“多米尼加共和国”或“俄罗斯”都不是特征定义。

特征值

这是应用于传入数据的特征定义的具体输出。在上述示例中，“多米尼加共和国”是一个特征值，可能是通过确定当前顾客的源 IP 地址最常用于该国而获得的。

这在目前还不是行业标准术语，但在本节中我们采纳它，以区分我们正在尝试从数据中提取信息的方法和我们到目前为止提取了什么。

## 特征选择和工程

*特征选择* 是我们确定将在模型中使用的数据特征的过程。*特征工程* 是我们从数据中提取这些特征并将其转换为可用状态的过程。换句话说，通过这些活动，我们找出了对我们尝试完成的机器学习任务重要的内容，以及不重要的内容。特征的构建和管理多年来发生了变化，并将继续发展，从完全手动的过程转变为大部分自动化的过程，甚至在某些情况下完全自动化。在本章中，我们将选择和转换特征的过程统称为*特征工程*。

在人驱动的特征工程中，该过程通常从基于对问题领域的理解或人类直觉出发，或至少与专家进行详细咨询开始。想象一下，试图构建一个关于* yarnit.ai *客户可能购买什么的预测模型，却不知道什么是纱线，或针，或编织，甚至更糟糕的是，根本不了解在线零售如何运作。理解潜在问题领域至关重要，而更具体的理解则更佳。之后，机器学习工程师会花时间与数据集和问题一起，并使用一套统计工具来评估特定特征，或多个特征组合在任务中是否有用。接下来，机器学习工程师通常进行头脑风暴，生成可能特征列表。范围非常广泛。一天中的时间可能是预测客户将购买哪些纱线的特征。当地的湿度可能是一个特征。价格可能是一个特征。在这三个特征中，有一个比其他的更有可能有用。人类利用机器学习平台和模型指标来生成和评估这些想法。

对于算法特征工程来说，有时作为自动机器学习的一部分，该过程相对自动化且与数据绑定紧密。自动机器学习在第三章中详细描述，不仅能够从已识别的特征中进行选择，还能够以编程方式应用常见的转换（如对数缩放或阈值处理）到现有特征上。还有其他方式可以通过算法学习数据的某些内容（如嵌入），而无需明确指定。然而，算法通常只能识别数据中存在的特征，而人类可以想象可能相关的新数据。微妙之处在于，但也许更重要的是，人类理解数据收集过程，包括任何可能的系统偏见。这可能会对数据的价值产生实质性影响。尽管如此，特别是在限定特定类型问题时，算法特征工程和评估可能比人工特征工程更为有效。这是一组不断发展的技术，我们应该预期人类与计算机之间的平衡在这方面会继续发展。

## 特征的生命周期

在考虑特征的生命周期时，特征定义与特征值之间的区别变得尤为重要。特征定义被创建来满足需求，根据该需求进行评估，并在模型被丢弃或找到更好的特征来实现相同目标时最终被丢弃。这里是特征生命周期的简化版本（包括定义和代表值）：

1\. 数据收集/创建

没有数据，我们就没有特征。我们需要收集或创建数据才能创建特征。

2\. 数据清洗/归一化/预处理

即使特征创建过程本身可以被视为某种数据归一化过程，这里我们指的是更粗粒度的预处理：消除明显格式错误的示例，将输入样本缩放到一组共同的值，并可能删除出于政策原因不应训练的特定数据。这可能看起来超出了特征工程的范畴，但在数据存在且处于可用形式之前，特征无法存在。数据归一化和预处理的话题非常广泛，超出了本书的范围，但建立基础设施以保持一致地进行该预处理并监控其执行是一个重要的责任领域。

3\. 候选特征定义创建

使用专业主题知识加上人类想象力或自动化工具，开发假设，确定哪些数据元素或其组合可能实现我们模型的目标。

4\. 特征值提取

我们需要编写代码来读取输入数据并从中提取我们需要的特征。在某些简单情况下，我们可能希望在训练过程中内联执行此操作。但是，如果我们预计会多次在相同数据上进行训练，最好是从原始数据中提取特征并将其存储以便后续高效且一致地读取。重要的是要记住，如果我们的应用涉及在线服务，我们需要这样一段代码的版本，以从提供的值中提取相同的特征，以便在我们的模型中执行推断。在理想情况下，相同的代码可以为训练和服务提取特征，但在服务中可能会有额外的约束条件，而这些约束条件在训练中是不存在的。

5\. 在特征存储中存储特征值

这就是我们保存特征的地方。特征存储只是一个地方，用于写入提取的特征值，以便在训练模型期间可以快速且一致地读取。这在 “特征存储” 中有详细介绍。

6\. 特征定义评估

一旦我们提取了一些特征，我们很可能会使用它们构建模型，或者将新特征添加到现有模型中，以评估它们的工作效果。特别是，我们将寻找证据表明这些特征是否提供了我们希望的价值。请注意，对特征定义的评估分为两个明确的阶段，二者相互关联。首先，我们需要确定该特征是否有用。这是一个粗粒度的评估；我们只是试图决定是否继续在模型集成该特征上工作。下一个阶段发生在我们决定保留该特征时。此时，我们需要一个过程来持续评估特征的质量和价值（与成本相比）。这将是必要的，以便我们能够确定它是否仍然按照预期工作，并在未来数年内提供我们预期的价值。

7\. 使用特征值进行模型训练和服务

这似乎是显而易见的，但拥有特征的整个目的是将它们用于训练模型，并使用生成的模型达到特定目的。

8\. （通常）更新特征定义

我们经常需要更新特征的定义，无论是修复错误还是简单地改进它们的某些方面。如果我们添加并跟踪特征定义的版本，这将更加容易。我们可以更新版本，然后选择性地重新处理旧数据，以为新版本创建新的特征值集。

9\. （有时）删除特征值

有时我们需要能够从特征存储中删除特征值。这可能是出于政策/治理原因；例如，我们可能不再被允许存储这些特征值，因为某人或政府已经撤销了该权限。这也可能是出于质量/效率原因：我们可能会认为这些值在某些方面有问题（损坏的、以偏见方式采样的，例如），或者仅仅是因为太旧而无用。

10\. （最终）终止特征定义

一切都有尽头，包括有用的特征。在模型生命周期的某个时刻，我们将找到更好的方式来提供这个特征定义提供的价值，或者发现世界已经发生足够的变化，以至于这个特征不再提供任何价值。最终，我们将决定彻底废弃特征定义（及其值）。我们需要删除任何引用该特征的服务代码，删除特征存储中的特征值，取消从数据中提取特征的代码，并继续删除特征代码。

## 特征系统

要成功管理数据流经我们系统的过程，并将数据转化为能被我们的训练系统使用和我们的建模人员管理的特征，我们需要将工作分解为几个子系统。

正如在本章节引言中提到的，其中一个系统将是一个元数据系统，用于跟踪有关数据、数据集、特征生成和标签的信息。由于在大多数情况下，这个系统将与任何标记系统共享，我们将在本章末尾讨论它。现在，让我们从原始数据开始，逐步讲解特征系统，最终以一种可供训练系统读取的格式存储特征。

### 数据摄取系统

我们将不得不编写软件，从原始数据中读取数据，将我们的特征提取代码应用于该数据，并将生成的特征值存储在特征存储中。在一次性提取的情况下，即使对于大量数据，这可能是一个相对临时的过程，设计的代码只需运行一次。但在许多情况下，提取数据的过程是一个独立的生产系统。

当我们有许多用户或数据摄取系统的重复使用时，它应该被构建为一个按需、可重复、监控的数据处理管道。就大多数管道而言，最大的变量是用户代码。我们需要一个系统，使特征作者能够编写代码来识别特征并将其提取存储到特征存储中。我们可以让特征作者自行运行其代码，这会给他们带来很大的运营负担，或者我们可以接受这一挑战并为他们提供开发工程环境。这有助于他们编写可靠的特征提取代码，以便我们可以在数据摄取系统中可靠地运行该代码。

我们需要构建一些系统来帮助特征作者编写可靠且正确的特征。首先，我们应该注意到特征应该是有版本的。随着时间的推移，我们可能会显著改变一个特征，也许是因为它与合并的数据或其他与我们正在收集的数据相关的因素的变化。在这些情况下，特征版本有助于保持过渡的清晰，并避免改变的意外后果。

接下来，我们需要一个测试系统，检查特征提取代码的基本正确性。然后，我们需要一个分段环境来运行提议的特征提取在一定数量的示例上，并将其提供给特征作者，以及基本的分析工具，以确保特征提取的内容符合预期。在这一点上，我们可能希望允许特征运行，或者可能希望进行额外的人工审查以解决可靠性问题（例如对外部数据的依赖）。我们在这里做的工作越多，特征作者的生产力就越高。

最后，重要的是要注意，一些标签可以在数据摄入时从我们已有的数据中有效计算或生成。在 YarnIt 中的一个很好的例子是建议产品和销售。我们建议产品以便销售更多。特征是产品的特性或关于客户的特征，而标签是客户是否购买它。只要我们能将建议日志与订单对接，我们在构建特征时就会有这个标签。在这种情况下，数据摄入系统还将为这些特征生成标签以及特征本身，并且两者可以一起存储在一个共同的数据存储中。我们将在《标签》章节中更详细地讨论标签系统。

### 特征存储

特征存储是一种设计用于存储提取的特征（和标签）值的存储系统，以便在训练模型期间甚至推断期间快速且一致地读取它们。大多数机器学习训练和服务系统都有某种特征存储，即使它不被称为特征存储²。然而，在更大、集中管理的服务中，特别是当特征（定义和值都是）被多个模型共享时，它们尤其有用。认识到将我们的特征和标签数据放在一个单一、良好管理的位置的重要性显著提高了工业中机器学习的生产就绪性。但特征存储并不能解决所有问题，很多人对它们的期望超过了它们能提供的。让我们回顾一下特征存储解决的问题以及它为您的训练系统提供的好处。

特征存储的最重要特性是其 API。不同的商业和开源特征存储具有不同的 API，但它们都应该提供一些基本功能能力：

存储特征定义

通常这些被存储为代码，该代码从原始数据格式中提取特征并以所需格式输出特征数据。

存储特征值本身

最终，我们需要以易于写入、易于阅读和易于使用的格式编写特征。这将在很大程度上由我们提议的用例决定，通常分为有序和无序数据，但我们在“生命周期访问模式”中涵盖了细微差别。

服务特征数据

在适合任务的性能水平上，快速高效地提供对特征数据的访问是必要的。我们绝对不希望昂贵的 CPU 或加速器因等待从特征存储中读取而停滞不前。这是浪费昂贵资源的无意义方式。

与元数据系统协调元数据写入

为了充分利用我们的特征存储，我们应该在元数据系统中保留有关存储数据的信息。这有助于模型构建者。注意，关于*特征*的元数据与管道运行的元数据略有不同，尽管两者在故障排除和问题再现中都很有用。特征元数据对于模型开发者最有用，而管道元数据对于 ML 可靠性或生产工程师最有用。

许多特征存储还提供数据摄取时的基本归一化，以及存储中数据的更复杂的转换。最常见的转换包括存储中的标准化分桶和内置特征转换[³]。

特征存储 API 需要根据使用情况进行精心校准。在思考我们在特征存储中需要什么时，我们应考虑以下问题：

+   我们是否按特定顺序读取数据（时间戳的日志行）或者读取顺序无关紧要（云存储系统中的大量图像集合）？

+   我们是否经常读取特征，或者只在训练新模型时读取？特别是，读取的字节/记录与写入的字节/记录的比率是多少？

+   特征数据是摄取一次，不追加且很少更新？还是数据经常追加，而旧数据不断删除？

+   特征值是否可以更新，还是仅追加存储？

+   我们存储的数据是否有特殊的隐私或安全要求？在大多数情况下，带有隐私和使用限制的数据集的提取特征也会有隐私和使用限制。

在考虑了这些问题之后，我们应该能够确定我们对特征存储系统的需求。如果幸运的话，我们可以使用市场上现有的商业或开源特征存储之一。如果没有，我们将不得不自己实现这些功能，无论是以不协调的方式还是作为更一致系统的一部分实现。

一旦我们明确了 API 的要求，并对我们的数据访问需求有了更清晰的理解，一般来说我们会发现我们的特征存储落入两个桶中之一：⁴

列

数据是结构化的，并可分解为列，其中并非所有列都会在所有模型中使用。通常，数据也按某种方式排序，通常是按时间排序。在这种情况下，面向列的存储方式是最灵活和高效的。

二进制大对象（Blobs）

这是*二进制大对象*的缩写，尽管常见的英文单词也有描述性的含义。在这种情况下，数据基本上是无序的，大部分是非结构化的，最好以更高效存储一堆字节的方式进行存储。

许多特征存储需要部分或完全复制，以便在训练和服务堆栈附近存储数据。由于 ML 计算需求通常相当大，我们通常喜欢将数据复制到能够以最佳性价比获取训练所需价值的地方或地方。将特征存储实现为服务有助于管理这种复制。

### 特征质量评估系统

随着我们开发新特征，我们需要评估这些特征与现有特征组合在一起对整体模型质量的贡献。这个话题在第五章中有详细介绍。此时需要了解的一般概念是，我们可以结合使用略有不同的模型、A/B 测试和模型质量评估系统的方法，有效评估正在开发中的每个新特征的益处。我们可以快速且成本相对较低地做到这一点。

一种常见的方法是通过使用单个附加特征重新训练现有模型。对于像 YarnIt 这样的 Web 应用程序，我们可以将一部分用户请求定向到新模型，并评估其在任务中的性能。例如，如果我们为模型添加了一个`用户所在国家`的特征，我们可以将 1% 的用户请求（无论是通过请求还是通过用户）定向到新模型。我们可以评估新模型是否更有可能推荐用户实际购买的产品，这样做可以决定是否保留新特征或取消它并尝试其他想法。

请记住，即使一个特征增加了价值，但其收集、处理、存储和维护成本可能并不值得。对于除了最微不足道的明显特征外的所有特征，计算每个新特征添加到系统中的大致投资回报率（ROI）是个好习惯。这将帮助我们避免有用的特征仍然比其添加的价值更昂贵的情况。

# 标签

虽然特征看起来是数据中最重要的部分，但有一件事更为重要：标签。到此为止，您应该对特征的作用以及在管理大量特征时应考虑的系统因素有了坚实的理解。但特别是在监督学习模型中，需要标签。

标签是用于训练机器学习模型的另一类主要数据。虽然特征用作模型的输入，标签则是正确模型输出的示例。它们在训练过程中用于设置（许多！）模型的内部参数，调整模型以便在推断时对其输入的特征产生期望的输出。保留样本和标签（未用于训练的标签）也用于模型评估，以理解模型质量。

正如我们之前讨论的那样，对于某些问题类别，例如我们的推荐系统，标签可以从系统日志数据中通过算法生成。这些特征几乎总是比人工标记的特征更一致和更准确。由于这些数据通常是从系统日志数据中生成的，并且通常与特征数据一起使用，这些标签通常存储在特征系统中用于模型的训练和评估。事实上，所有的标签都可以存储在特征存储中，尽管由人类生成的标签需要额外的系统来生成、验证和校正这些标签，然后再存储用于模型的训练和评估。我们将在下一节讨论这些系统。

# 人工生成的标签

因此，让我们把注意力转向需要人类注释以提供模型训练数据的大类问题。例如，构建一个分析和解释人类语音的系统需要人类注释来确保转录准确，并理解说话者的意图。图像分析和理解通常需要示例标注图像来解决图像分类或检测问题。在训练机器学习模型所需的规模上获得这些人类注释，从实施和成本的角度来看都是具有挑战性的。必须致力于设计高效的系统来生成这些注释。我们现在将专注于这些人类注释系统的主要组成部分。

举一个涉及我们虚构的毛线店 YarnIt 的具体例子，考虑一个先进新功能的情况，该功能可以根据毛线图像预测用于制作该图像的钩针钩法。这样的模型需要有人设计一组钩针钩法供模型预测，并由钩针专家标记大量的毛线图像，标记出用于制作这些图像的钩针钩法。利用这些专家标签，模型可以训练以对新的毛线图像进行分类并确定使用的钩针钩法。

这不是便宜的。人类需要在任务上接受培训，并且每张图片可能需要多次标注，以确保我们获得可信赖的结果。由于获取人工生成标签的成本巨大，训练系统应设计为尽可能充分利用它们。一种常用的技术是数据增强：对特征数据进行“模糊化”，改变特征但不改变标签的正确性。⁵ 例如，考虑我们的缝合分类问题。常见的图像操作如缩放、裁剪、添加图像噪声和改变色彩平衡不会改变图像中缝合的分类，但可以大幅增加模型训练所需的图像数量。类似的技术可以用于其他类别的问题中。然而，必须小心，不要在两个从同一源图像模糊化生成的图像上进行训练和测试，因此任何这种类型的数据增强都应由训练系统完成，而不是在标注系统中进行（或者不这样做，如果有充分的理由，比如非常昂贵的模糊算法）。

一个重要的注意事项是：尽管某些极为复杂的数据最好由人类进行标注，但另一些类型的数据绝对不能由人类来标注。通常这些是抽象数据，具有高维度，使得人类难以迅速确定正确答案。有时候，人类可以借助增强软件来辅助完成这些任务，但有时候他们只是进行标注的错误选择。

## 注释工作队

人工标注问题经常遇到的第一个问题是谁来进行标注。这是一个规模和公平性的问题。⁶ 对于简单模型，通常只需要少量数据来训练模型，通常是模型构建者自己进行标注，经常使用简陋的自制工具（并且有显著的偏见标签的可能性）。对于更复杂的模型，专门的注释团队则用来提供在其他情况下不可能的规模的人工标注。

这些专门的注释团队可以与模型构建者共同工作，也可以由第三方注释提供者远程提供。团队规模从一人到数百人不等，他们为单一模型生成注释数据。亚马逊的机械土耳其服务曾经是最初用于这一目的的平台，但自那以后，众包平台和服务数量激增。一些服务采用有薪志愿者，而另一些则使用员工团队来标注数据。

在选择标注时会产生成本、质量和一致性的权衡。众包标注通常需要额外的工作来验证质量和一致性，但支付的标注工作人员可能成本高昂。这些注释团队的成本往往可以轻易超过训练模型的计算成本。我们在第十三章中讨论了管理大型注释团队的一些组织挑战。

## 测量人类注释质量

由于任何模型的质量仅取决于用于训练模型的数据，因此必须从一开始就设计系统质量。随着注释团队规模的增长，这一点变得越来越重要。可以通过多种方式实现质量，具体取决于任务，但最常用的技术包括以下几种：

多次标注（也称为*共识标注*）

同一数据分配给多个标注者以检查他们之间的一致性。

黄金测试集问题

可信的标注者（或者模型构建者）生成一组测试问题，随机包含在未标注数据中，以评估生成标签的质量。

单独的质量保证步骤

一小部分标注数据由更可信的质量保证团队审查。（谁质量保证质量保证团队？也许是模型构建者，但根据情况，这可能是一个独立的质量保证团队、政策专家或其他具有领域专业知识的人。）

一旦进行测量，质量指标可以得到改进。管理注释团队时，最好怀着谦卑的态度，并理解到他们在拥有以下条件时将产生更高质量的结果：

+   更多的培训和文档

+   认可质量而不仅仅是吞吐量

+   工作日内的各种任务

+   易于使用的工具

+   具有平衡答案集的任务（没有大海捞针的任务）

+   提供工具和指导反馈的机会

通过这种方式管理的注释团队可以提供高质量的结果。然而，即使是最好的、最认真的标注者偶尔也会漏掉一些东西，因此应设计流程来检测或接受这些偶尔的错误。

## 注释平台

标注平台组织数据流以进行注释，并提供注释结果的质量和吞吐量指标。在其核心，这些系统主要是工作排队系统，用于在标注者之间分配注释工作。允许标注者查看数据并提供注释的实际标注工具应具有灵活性，以支持任何任意的注释任务。

对于同时处理多个模型的团队或组织，同一标注团队可以在多个标注项目之间共享。此外，每个标注员可能具有不同的技能集（例如语言能力或对钩织知识的了解），排队系统可能相对复杂，并需要仔细设计，以避免问题，如可伸缩性问题或队列饥饿。允许一个标注任务的输出作为另一个任务的输入的流水线对于复杂的工作流程非常有用。使用前面讨论过的技术进行质量测量应该从一开始就设计到系统中，这样项目所有者就可以了解他们所有标注任务的标注吞吐量和质量。

尽管历史上许多公司已经实现了他们自己的标注平台，并具备一整套这些功能，但现在有许多预构建的标注平台选项可供选择。主要的云服务提供商和许多较小的初创公司提供标注平台服务，可与任意注释工作队合作，并且许多注释工作队提供其自己的平台选项。这是一个变化迅速的领域，现有平台不断增加新功能。公开可用的工具已经超越了简单的排队系统，并开始提供用于常见任务的专用工具，包括 AI 辅助标注（请参阅下一节）。在决定任何新技术平台时，必须考虑数据安全性和集成成本，以及平台的能力。

如“特征存储”中所述，在许多情况下，将完成的标签存储在特征存储中是最明智的选择。通过将人工注释视为它们自己的列，我们可以利用特征存储提供的所有其他功能。

## 主动学习和 AI 辅助标注

主动学习技术可以将注释工作集中在模型和人工注释者意见不一致或模型最不确定的情况下，从而提高整体标签质量。例如，考虑一个图像检测问题，标注员必须在图像中注释特定对象的所有出现。主动学习标注工具可以使用现有模型预标注图像，并提出该对象的检测建议。标注员随后会批准正确的检测建议，拒绝错误的建议，并添加任何遗漏的检测。虽然这可以极大地提高标注员的吞吐量，但必须小心操作，以免为模型引入偏见。这种主动学习技术实际上可以提高整体标签质量，因为模型和人类往往在不同类型的输入数据上表现最佳。

半监督系统允许模型构建者使用不完美地预测某些数据标签的弱启发式函数来引导系统，然后利用人类训练模型，使这些不完美的启发式函数转变为高质量的训练数据。对于需要快速且频繁重新训练模型的复杂、频繁变化的类别定义问题，这类系统尤其有价值。

针对特别复杂的标注任务的高效标注技术是一个持续的研究领域。特别是在处理常见标注问题时，从云和标注提供商那里快速查看可用工具是值得花时间的，因为它们经常添加新的 AI 辅助标注功能。

## 标签员的文档和培训

文档和标签员培训系统是标注平台中常被忽视的部分之一。虽然标签指导通常起步简单，但随着数据的标注和各种特殊情况的发现，它们不可避免地变得更加复杂。继续我们之前的 YarnIt 示例，也许一些钩针编织没有在标签指导中提到，或者织物由多种不同的针法制成。即使是概念上简单的标注任务，比如“标记图像中的所有人”，最终也会有大量关于各种特殊情况的正确处理指令（如反射、人物照片、人物在汽车窗后面等）。

当发现新的特例时，应更新标注定义和指导方针，并通知标注和建模团队有关更改的信息。如果更改很大，可能需要重新标注以更正使用旧指导方针标注的数据。标注团队经常有较大的人员流动，因此投资于使用标注工具和理解标注指导方针的培训几乎总能带来标签质量和产量的显著提升。

# 元数据

特征系统和标注系统都受益于对元数据的有效跟踪。现在您对特征或标注系统提供的数据类型有了相对完整的理解，可以开始考虑在这些操作期间产生的元数据。

## 元数据系统概述

*元数据系统*的设计旨在跟踪我们正在做的事情。在特征和标签的情况下，它至少应该跟踪我们拥有的特征定义及每个模型定义和训练模型使用的版本。但是，值得暂停片刻并尝试展望未来：我们最终对元数据系统有什么期望，是否有办法提前预见？

大多数组织在构建其数据科学和机器学习基础设施时，没有一个坚实的元数据系统，只会在后来感到后悔。接下来最常见的方法是构建多个元数据系统，每个系统针对解决特定问题。这正是我们要做的：为跟踪特征定义和特征存储映射创建一个系统。即使在这本章节中，你将会看到我们需要存储关于标签的元数据，包括它们的规范以及何时将特定标签应用于特定的特征值。之后，我们还需要一个系统来将模型定义映射到训练好的模型，并包含有关负责这些模型的工程师或团队的数据。我们的模型服务系统还需要跟踪训练模型版本以及它们何时投入生产。任何模型质量或公平评估系统都需要从所有这些系统中读取数据，以便识别和跟踪影响模型质量变化或违反我们提出的公平度量的可能原因。

我们的元数据系统选择相对简单：

一个系统

建立一个系统来跟踪所有这些来源的元数据。这样可以简化跨多个子系统的相关性分析和报告。从数据架构的角度来看，设计这样一个大系统很难做到完美。当我们发现需要跟踪的数据时，我们将不断添加列（并在现有数据上回填这些列）。稳定这样的系统并使其可靠也将是困难的。从系统设计的角度来看，我们应确保我们的元数据系统永远不处于模型训练或模型服务的实时路径中。但是很难想象在没有功能的元数据系统的情况下进行特征工程或标注，因此它仍然可能给我们的从事这些任务的人员带来生产问题。

多个协同工作的系统

我们可以为每个识别出的任务构建单独的元数据系统。也许我们可以有一个用于特征和标签的系统，一个用于训练，一个用于服务，一个用于质量监控。解耦系统提供了解耦总是提供的标准优势和成本。它允许我们单独开发每个系统，而不必担心其他系统，使它们更灵活和更容易修改和扩展。此外，一个元数据系统的故障对其他系统的生产影响有限。但成本是增加了跨这些系统的分析和报告的难度。我们将需要在特征、标注、训练和服务系统之间联合数据的过程。多个系统应始终设计成允许它们的数据进行关联，这意味着创建和共享唯一标识符或建立一个跟踪数据字段关系的元元数据系统。

如果需求简单且易于理解，请优先选择单一系统。⁷ 如果领域发展迅速且我们的团队预计会继续扩展跟踪和工作方式，则多个系统将随着时间推移简化开发。

## 数据集元数据

关于特征和标签的元数据，以下是我们应确保包含的几个具体元素：

数据集溯源

数据来源何处？根据数据来源，我们可能有各种系统的日志查找表，外部数据提供者的关键数据及其下载日期，甚至是生成数据的代码引用。

数据集位置

对于某些数据集，我们将存储原始未处理数据。在这种情况下，我们应存储一个指向数据集存储位置的引用，以及可能关于数据来源的信息。我们定期为自己创建一些数据，例如系统日志，因此在这些情况下，应存储日志或数据存储引用，或者我们被允许从中读取的地方。

数据集负责人员或团队

我们应该追踪负责数据集的人员或团队。一般来说，这是选择下载或创建数据集的团队，或拥有生成数据的系统的团队。

数据集创建日期或版本日期

通常有必要知道特定数据集首次使用的日期。

数据集使用限制

许多数据集由于许可或治理限制而受到使用限制。我们应在元数据系统中记录这一点，以便日后进行简便的分析和遵从性检查。

## 特征元数据

跟踪我们特征定义的元数据是使我们能够可靠使用和维护这些特征的一部分。该元数据包括以下内容：

特征版本定义

特征定义是对代码或其他持久性描述的引用，用于说明特征读取什么数据以及如何处理数据以创建特征。应在每个更新版本的特征定义时更新此信息。正如前面所述，对这些定义进行版本控制（并限制使用的版本）将使最终的代码库更可预测和可维护。

特征定义负责人员或团队

存储这些信息有两个很好的用例：确定特征用途和找到能帮助解决可能导致特征故障的事件的人员。在这两种情况下，存储特征的作者或维护者信息非常有用。

特征定义创建日期或当前版本日期

这可能相当明显，但获取特征最近更新和最初创建的更改历史非常有用。

特征使用限制

这是重要的，但存储起来更为棘手。某些情况下可能限制特征的使用。例如，在某些司法管辖区可能会禁止使用特定特征。年龄和性别可能是汽车保险风险模型的合理预测因子，但保险业受到严格监管，我们可能不被允许考虑这些字段。对于特定用途禁止特定字段的实施和跟踪是困难的，但限制可能更加微妙。例如，年龄可能可以考虑，但只能使用特定的分桶（如`低于 25 岁`，`25-64 岁`，`65-79 岁`和`80 岁以上`）。在这种特定情况下，更容易定义一个基于`age`列的转换特征，满足这些分桶要求，并禁止一般的`age`特征用于保险目的，同时允许使用`insurance_bucketed_age`特征。但根据治理要求存储和应用特征限制的一般情况极为困难，目前尚无理想的设计或解决方案。

## 标签元数据

我们还应该跟踪有关标签的元数据。这旨在帮助维护和开发标签系统本身，但也可能被训练系统用于使用标签时：

标签定义版本

切换到与标签相关的元数据，类似于特征，我们必须存储任何标签定义的版本，以了解标签是使用哪些标签说明生成的。

标签集版本

除了标签定义的更改，由于修正错误标签或添加新标签，标签的更改也可能发生。如果数据集用于与旧模型比较，则可能希望使用旧版本的标签，以进行更为公正的比较。

标签来源

尽管通常不需要用于训练，但有时需要知道数据集中每个标签的来源。这可能是特定标签许可的来源，生成标签的人员（以及应用于标签的任何质量保证），或者如果使用了自动标记方法，则是生成标签的算法。

标签置信度

根据标签生成的方式，我们可能对不同标签的正确性置信度有不同的估计。例如，我们可能对由自动化方法生成的标签或由新的标签生成器生成的标签的置信度较低。使用这些标签的用户可能会选择不同的阈值来决定在训练模型时使用哪些标签。

## 流水线元数据

本节涵盖了一种我们不会花太多时间讨论的最终类型的元数据：关于管道过程本身的元数据。这是关于我们拥有的中间产物、它们来自哪些管道运行以及哪些二进制文件产生了它们的数据。这种类型的元数据由某些机器学习训练系统自动产生；例如，ML Metadata（MLMD）自动包含在 TensorFlow Extended（TFX）中，用于存储关于训练运行的工件。这些系统要么集成到这些系统中，要么稍后实现起来相对困难。因此，在这里我们不会过多涉及它们。

更普遍地说，元数据系统经常被忽视或降低优先级。但它们不应该被忽视。它们是机器学习系统中最有效和直接的数据利用贡献者之一。元数据释放了价值，应优先考虑。

# 数据隐私与公平性

特征和标记系统引发了深刻的隐私和伦理考虑。虽然这些主题在第六章中有更详尽的讨论，但在此明确指出一些特定的主题仍然值得一提。

## 隐私

我们接收的数据以及对数据的人工标注很可能包含 PII。虽然处理私人信息的最简单方法是简单地禁止私人或敏感信息进入我们的特征存储系统，但这通常不实际。

### PII 数据和特征

如果我们计划在特征中使用 PII 数据，我们希望至少提前计划执行以下三项任务：

+   最小化我们处理和存储的个人身份信息（PII）数据

+   限制和记录包含私有特征的特征存储器的访问

+   计划尽快删除私有特征

最好是提前规划正确处理 PII 数据的方式。在考虑收集 PII 数据之前，应建立明确的用户同意获取流程：用户应知道他们提供了哪些数据以及将如何使用。许多组织发现编写计划，详细说明将收集的数据、处理方式、存储位置以及可以访问和将被删除的情况非常有价值。这使得可以进行内部（可能最终是外部）审查程序，以确保符合相关法律法规。大多数组织将希望记录关于规划 PII 数据的程序，并定期对员工进行这些程序的培训。

请记住，从组织角度看，私人数据比资产更具有责任。因此，我们应完全确信包含私人数据的特征是必需的，即它们产生的价值足以抵消处理和存储私人数据的风险。正如总是情况一样，可以将不同的非私人数据组合在一起以创建私人数据元素。

### 私有数据与标记

人工注释 PII 数据如果处理不当，会引入一系列法律或声誉风险。如何正确管理这类数据用于人工注释系统是极其具体的情境，超出了本书的范围。通常，处理 PII 数据的最佳方式是将数据拆分，使得进行注释的人只能访问数据的非 PII 部分。这是特定问题的解决方案。任何标记 PII 数据都应该在项目领导层的高度关注和意识下谨慎进行。

使用人工注释者还会带来另一个风险，即模型无意中学习注释说明或团队本身的文化偏见。最好通过深思熟虑的文档记录和考虑潜在混淆领域、与注释团队的强有力沟通以及聘请多样化的注释团队来应对这种潜在偏见。积极的一面是，训练有素的注释团队可以是过滤具有潜在偏见的数据源、理解和消除偏见的最有效方法之一。

## 公平性

公平性是一个重要的主题，在第六章中有更广泛和更彻底的讨论。在考虑特征及其标签时，考虑公平性非常重要。选择确保生成的机器学习系统只能公平使用的特征和特征集合并不容易。虽然我们确实需要避免选择不具代表性和有偏见的特征和数据集，但仅此还不足以确保总体公平性。对于那些对公平性特别感兴趣的人来说，现在是阅读（或重新阅读）第六章的好时机。

# 结论

生产型机器学习系统需要有效和一致地管理训练数据的机制。训练数据几乎总是由特征组成的，因此拥有一个结构化的特征存储显著地促进了特征的编写、存储、读取和最终删除。许多机器学习系统还涉及人工注释数据的组件。进行数据注释的人类需要他们自己的系统来促进快速、准确和经过验证的注释，最终需要将其集成到特征存储中。

我们希望我们已经更清楚地解释了这些组件以及在选择或者在最坏情况下构建它们时应考虑的因素。

¹ 我们知道深度学习的一个承诺是有时可以使用原始数据训练模型，而无需明确识别特征。对于某些用例，这一承诺部分属实，但目前主要适用于感知数据，如图像、视频和音频。在这些情况下，我们可能不需要从底层数据中提取特定的特征，尽管我们仍然可能从元数据特征中获得良好的价值。对于其他情况，现在仍然需要特征化。因此，即使是深度学习建模者也将从对特征的理解中受益。

² 例如，在移动设备上进行的 ML 训练仍然需要对一些数据进行训练，但不需要有一个结构化的、受管理的特征存储，因为没有必要为其他设备上的用户调解数据。

³ 分桶只是将连续数据放入离散类别的过程。*转换特征*是计算得出的一个或多个其他特征的组合的结果特征。简单的例子包括在提供日期特征时返回星期几，或从存储地球上某点的纬度和经度的特征返回国家名称。更复杂的例子可能包括修复图片的色彩平衡或为 3D 数据选择特定的投影。也许最常见的例子之一是将 32 位数（整数或更糟的是浮点数）转换为 8 位数，以显著减少处理它们所需的空间和计算资源。

⁴ 有些例子将包含来自两个存储桶的特征。例如，图像中的图片是最好作为非结构化数据访问的大块，但是关于图像的元数据（拍摄它的相机、日期、曝光信息、位置信息）是结构化的，如果包括像`date`这样的字段，甚至可能是有序的。

⁵ 这也是一种通过算法扩展训练数据集的技术。

⁶ 组织需要确保人工标记者得到公平对待，并且为他们的工作支付合理的报酬。

⁷ 行业中存在许多具有多个元数据系统的组织，每个系统都认为自己是唯一的系统。如果需求简单且明确，可以优先选择一个系统，但应采取措施确保它是唯一的系统，除非你超出了它的需求。
