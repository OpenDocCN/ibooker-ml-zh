<html><head></head><body><section data-pdf-bookmark="Chapter 5. Putting It All Together: Content-Based Recommender" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch:pinterest-content">&#13;
<h1><span class="label">Chapter 5. </span>Putting It All Together: <span class="keep-together">Content-Based Recommender</span></h1>&#13;
&#13;
&#13;
<p>Throughout this part of the book, we’ve introduced some of the most basic components in a recommendation system. In this chapter, we’ll get hands-on. We’re going to design and implement a recommendation system for images from Pinterest. This chapter, along with the book’s other “Putting It All Together” chapters, will show you how to work with datasets by using open source tools. The material for this kind of chapter refers to code hosted on GitHub that you will need to download and play with in order to properly experience the content.</p>&#13;
&#13;
<p>Since this is the first practical hands-on chapter, here are some extra setup instructions for the<a data-primary="content-based recommender" data-secondary="development environment" data-type="indexterm" id="id476"/><a data-primary="environments" data-secondary="development environment" data-type="indexterm" id="id477"/> development environment. We developed this code on Windows running in a<a data-primary="Windows Subsystem for Linux (WSL)" data-type="indexterm" id="id478"/><a data-primary="WSL (Windows Subsystem for Linux)" data-type="indexterm" id="id479"/> Windows Subsystem for Linux (WSL) Ubuntu virtual machine. The code should run fine on Linux machines, with more technical adaptation for macOS and a lot more for Windows, in which case it would be better to run it on a WSL2 Ubuntu virtual machine. You can look at the setup for WSL in the <a href="https://oreil.ly/VWPhi">Microsoft documentation for Windows</a>. We picked Ubuntu for the image. You will also need <a href="https://oreil.ly/rnCw4">NVIDIA CUDA</a> and <a href="https://oreil.ly/LHa-I">cuDNN</a> if you have an NVIDIA GPU and want to use it.</p>&#13;
&#13;
<p>We<a data-primary="Shop the Look (STL) dataset" data-type="indexterm" id="id480"/><a data-primary="content-based recommender" data-secondary="dataset used" data-type="indexterm" id="id481"/> will be using the <a href="https://oreil.ly/PxfJn">Shop the Look (STL) dataset</a> from <a href="https://oreil.ly/2EDnZ">“Complete the Look: Scene-Based Complementary Product Recommendation”</a> by Wang-Cheng Kang et al.</p>&#13;
&#13;
<p>In this chapter, we will show you how to build a content-based recommender. Recall that a content-based recommender uses indirect, generalizable representations of the items you wish to represent. Imagine, for instance, that you want to recommend a cake but cannot use the name of a cake. Instead, you might use descriptions of the cake or its ingredients as the content features.</p>&#13;
&#13;
<p>With the STL dataset, we will try to match scenes, which are pictures of a person in a particular setting, with products that might go well with the scene. The training set contains pairs of scenes with single products, and we want to use the content recommender to extend recommendations to the entire catalog of products and sort them in some kind of ranking order. The content recommender, because it uses indirect content features to make recommendations, can be used to recommend new products that haven’t been in the recommendation system or to warm-start a recommendation system with manually curated data before users start using it and a feedback loop is established.&#13;
In the case of the STL dataset, we’ll focus on the visual appearance of the scene and the products.</p>&#13;
&#13;
<p>We will generate content embeddings via a convolutional neural network (CNN) architecture, and then train the embedding via a triplet loss and show how to create a content recommendation system.</p>&#13;
&#13;
<p>This chapter covers the following topics:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Revision control software</p>&#13;
</li>&#13;
<li>&#13;
<p>Python build systems</p>&#13;
</li>&#13;
<li>&#13;
<p>Random-item recommender</p>&#13;
</li>&#13;
<li>&#13;
<p>Obtaining the STL dataset images</p>&#13;
</li>&#13;
<li>&#13;
<p>Definition of CNN</p>&#13;
</li>&#13;
<li>&#13;
<p>Model training in JAX, Flax, and Optax</p>&#13;
</li>&#13;
<li>&#13;
<p>Input pipeline</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Revision Control Software" data-type="sect1"><div class="sect1" id="id43">&#13;
<h1>Revision Control Software</h1>&#13;
&#13;
<p><em>Revision control software</em> is<a data-primary="content-based recommender" data-secondary="revision control software" data-type="indexterm" id="id482"/><a data-primary="revision control software" data-type="indexterm" id="id483"/> a software system that keeps track of code changes. Think of it as a database that tracks versions of code you have written, while providing added functionality like showing the differences between each version of code and allowing you to revert to a previous version.</p>&#13;
&#13;
<p>There are many<a data-primary="GitHub/Git" data-type="indexterm" id="id484"/> kinds of revision control systems. We host the code for this book on <a href="https://oreil.ly/DsolH">GitHub</a>.</p>&#13;
&#13;
<p>The revision control software we use is called <a href="https://git-scm.com">Git</a>. Code changes are done in batches called a <em>patch</em>, and each patch is uploaded to a source control repository like GitHub so that it can be cloned and worked on by many people at the same time.</p>&#13;
&#13;
<p class="less_space pagebreak-before">You can use this command to clone the book code sample repository:</p>&#13;
&#13;
<pre data-type="programlisting">git clone git@github.com:BBischof/ESRecsys.git</pre>&#13;
&#13;
<p>For this chapter, look in the directory <em>ESRecsys/pinterest</em> for instructions on how to run the code in detail. This chapter will mostly focus on descriptions and pointers to the repository so that you’ll able to get a feel for these systems in practice.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python Build Systems" data-type="sect1"><div class="sect1" id="id44">&#13;
<h1>Python Build Systems</h1>&#13;
&#13;
<p>Python<a data-primary="content-based recommender" data-secondary="Python build systems" data-type="indexterm" id="id485"/><a data-primary="Python build systems" data-type="indexterm" id="id486"/><a data-primary="packages" data-type="indexterm" id="id487"/> <em>packages</em> are libraries that provide functionality beyond the standard Python libraries. These include ML packages such as TensorFlow and JAX but also more utilitarian packages like the absl flags library or machine learning operations (MLOps) libraries<a data-primary="Weights &amp; Biases" data-type="indexterm" id="id488"/> like <a href="https://wandb.ai">Weights &amp; Biases</a>.</p>&#13;
&#13;
<p>These<a data-primary="Python Package Index" data-type="indexterm" id="id489"/> packages are usually hosted on <a href="https://pypi.org">the Python Package Index</a>.</p>&#13;
&#13;
<p>Take a look at the file <em>requirements.txt</em>:</p>&#13;
&#13;
<pre data-type="programlisting">absl-py==1.1.0&#13;
tensorflow==2.9.1&#13;
typed-ast==1.5.4&#13;
typing_extensions==4.2.0&#13;
jax==0.3.25&#13;
flax==0.5.2&#13;
optax==0.1.2&#13;
wandb==0.13.4</pre>&#13;
&#13;
<p>You can see that we have picked a small set of Python packages to install for our dependencies. The format is package name, two equal signs, and then the version of the package.</p>&#13;
&#13;
<p>Other build systems that work with Python include the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/QNevQ">pip</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/3BdIC">Bazel</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/4z182">Anaconda</a></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>For this chapter, we will use pip.</p>&#13;
&#13;
<p>Before<a data-primary="Python virtual environments" data-type="indexterm" id="id490"/><a data-primary="environments" data-secondary="virtual environments" data-type="indexterm" id="id491"/> installing the packages, however, you might want to read up on <a href="https://oreil.ly/fnQKD">Python virtual environments</a>. Python virtual environments are a way to keep track of Python package dependencies per project so that if different projects use different versions of the same package, they won’t interfere with one another because each project has its own Python virtual environment to run in.</p>&#13;
&#13;
<p class="less_space pagebreak-before">You can create and activate a Python virtual environment by typing the following into a Unix shell:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">python<code class="w"> </code>-m<code class="w"> </code>venv<code class="w"> </code>pinterest_venv<code class="w"/>&#13;
<code class="nb">source</code><code class="w"> </code>pinterest_venv/bin/activate<code class="w"/></pre>&#13;
&#13;
<p>The first command creates a Python virtual environment, and the second one activates it. You will have to activate a virtual environment every time you open a new shell so that Python knows what environment to work in.</p>&#13;
&#13;
<p>After the virtual environment is created, you can then use pip to install packages into the virtual environment, and those newly installed packages will not affect the system-level packages.</p>&#13;
&#13;
<p>You can do this by running this command in the <em>ESRecsys/pinterest</em> directory:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">pip<code class="w"> </code>install<code class="w"> </code>-r<code class="w"> </code>requirements.txt<code class="w"/></pre>&#13;
&#13;
<p>This will install the specified packages and any subpackages that they might depend on into the virtual environment.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Random-Item Recommender" data-type="sect1"><div class="sect1" id="id45">&#13;
<h1>Random-Item Recommender</h1>&#13;
&#13;
<p>The<a data-primary="content-based recommender" data-secondary="random-item recommender" data-type="indexterm" id="CBRran05"/><a data-primary="random-item recommender" data-type="indexterm" id="randitem05"/> first program we will look at is a random-item recommender (<a data-type="xref" href="#example0501">Example 5-1</a>).</p>&#13;
<div data-type="example" id="example0501">&#13;
<h5><span class="label">Example 5-1. </span>Setting up flags</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">FLAGS</code> <code class="o">=</code> <code class="n">flags</code><code class="o">.</code><code class="n">FLAGS</code>&#13;
<code class="n">_INPUT_FILE</code> <code class="o">=</code> <code class="n">flags</code><code class="o">.</code><code class="n">DEFINE_string</code><code class="p">(</code>&#13;
  <code class="s2">"input_file"</code><code class="p">,</code> <code class="kc">None</code><code class="p">,</code> <code class="s2">"Input cat json file."</code><code class="p">)</code>&#13;
<code class="n">_OUTPUT_HTML</code> <code class="o">=</code> <code class="n">flags</code><code class="o">.</code><code class="n">DEFINE_string</code><code class="p">(</code>&#13;
  <code class="s2">"output_html"</code><code class="p">,</code> <code class="kc">None</code><code class="p">,</code> <code class="s2">"The output html file."</code><code class="p">)</code>&#13;
<code class="n">_NUM_ITEMS</code> <code class="o">=</code> <code class="n">flags</code><code class="o">.</code><code class="n">DEFINE_integer</code><code class="p">(</code>&#13;
  <code class="s2">"num_items"</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="s2">"Number of items to recommend."</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># Required flag.</code>&#13;
<code class="n">flags</code><code class="o">.</code><code class="n">mark_flag_as_required</code><code class="p">(</code><code class="s2">"input_file"</code><code class="p">)</code>&#13;
<code class="n">flags</code><code class="o">.</code><code class="n">mark_flag_as_required</code><code class="p">(</code><code class="s2">"output_html"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">read_catalog</code><code class="p">(</code><code class="n">catalog</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Dict</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="nb">str</code><code class="p">]:</code>&#13;
    <code class="sd">"""</code>&#13;
<code class="sd">      Reads in the product to category catalog.</code>&#13;
<code class="sd">    """</code>&#13;
    <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">catalog</code><code class="p">,</code> <code class="s2">"r"</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="n">f</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>&#13;
    <code class="n">result</code> <code class="o">=</code> <code class="n">json</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">result</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">dump_html</code><code class="p">(</code><code class="n">subset</code><code class="p">,</code> <code class="n">output_html</code><code class="p">:</code><code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="sd">"""</code>&#13;
<code class="sd">      Dumps a subset of items.</code>&#13;
<code class="sd">    """</code>&#13;
    <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">output_html</code><code class="p">,</code> <code class="s2">"w"</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>&#13;
        <code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="s2">"&lt;HTML&gt;</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code>&#13;
        <code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="s2">"""</code>&#13;
<code class="s2">        &lt;TABLE&gt;&lt;tr&gt;</code>&#13;
<code class="s2">        &lt;th&gt;Key&lt;/th&gt;</code>&#13;
<code class="s2">        &lt;th&gt;Category&lt;/th&gt;</code>&#13;
<code class="s2">        &lt;th&gt;Image&lt;/th&gt;</code>&#13;
<code class="s2">        &lt;/tr&gt;"""</code><code class="p">)</code>&#13;
        <code class="k">for</code> <code class="n">item</code> <code class="ow">in</code> <code class="n">subset</code><code class="p">:</code>&#13;
            <code class="n">key</code><code class="p">,</code> <code class="n">category</code> <code class="o">=</code> <code class="n">item</code>&#13;
            <code class="n">url</code> <code class="o">=</code> <code class="n">pin_util</code><code class="o">.</code><code class="n">key_to_url</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>&#13;
            <code class="n">img_url</code> <code class="o">=</code> <code class="s2">"&lt;img src=</code><code class="se">\"</code><code class="si">%s</code><code class="se">\"</code><code class="s2">&gt;"</code> <code class="o">%</code> <code class="n">url</code>&#13;
            <code class="n">out</code> <code class="o">=</code> <code class="s2">"&lt;tr&gt;&lt;td&gt;</code><code class="si">%s</code><code class="s2">&lt;/td&gt;&lt;td&gt;</code><code class="si">%s</code><code class="s2">&lt;/td&gt;&lt;td&gt;</code><code class="si">%s</code><code class="s2">&lt;/td&gt;&lt;/tr&gt;</code><code class="se">\n</code><code class="s2">"</code> <code class="o">%</code>&#13;
            <code class="p">(</code><code class="n">key</code><code class="p">,</code> <code class="n">category</code><code class="p">,</code> <code class="n">img_url</code><code class="p">)</code>&#13;
            <code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="n">out</code><code class="p">)</code>&#13;
        <code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="s2">"&lt;/TABLE&gt;&lt;/HTML&gt;"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">main</code><code class="p">(</code><code class="n">argv</code><code class="p">):</code>&#13;
    <code class="sd">"""</code>&#13;
<code class="sd">      Main function.</code>&#13;
<code class="sd">    """</code>&#13;
    <code class="k">del</code> <code class="n">argv</code>  <code class="c1"># Unused.</code>&#13;
&#13;
    <code class="n">catalog</code> <code class="o">=</code> <code class="n">read_catalog</code><code class="p">(</code><code class="n">_INPUT_FILE</code><code class="o">.</code><code class="n">value</code><code class="p">)</code>&#13;
    <code class="n">catalog</code> <code class="o">=</code> <code class="nb">list</code><code class="p">(</code><code class="n">catalog</code><code class="o">.</code><code class="n">items</code><code class="p">())</code>&#13;
    <code class="n">random</code><code class="o">.</code><code class="n">shuffle</code><code class="p">(</code><code class="n">catalog</code><code class="p">)</code>&#13;
    <code class="n">dump_html</code><code class="p">(</code><code class="n">catalog</code><code class="p">[:</code><code class="n">_NUM_ITEMS</code><code class="o">.</code><code class="n">value</code><code class="p">],</code> <code class="n">_OUTPUT_HTML</code><code class="o">.</code><code class="n">value</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Here we use the absl flags library to pass in arguments to the program such as the path to the JSON catalog file that contains the STL scene, and product pairs.</p>&#13;
&#13;
<p>Flags can have different types like string and integer, and you can mark them as required. If a required flag is not passed to the program, it will complain and stop running. Flags can be accessed via their value method.</p>&#13;
&#13;
<p>We load and parse the STL dataset by using the JSON Python library, and then we randomly shuffle the catalog and dump the top few results in HTML.</p>&#13;
&#13;
<p>You can run the random-item recommender via the following command:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">python3<code class="w"> </code>random_item_recommender.py<code class="w"/>&#13;
--input_file<code class="o">=</code>STL-Dataset/fashion-cat.json<code class="w"> </code>--output_html<code class="o">=</code>output.html<code class="w"/></pre>&#13;
&#13;
<p>After completion, you can open the <em>output.html</em> file with your web browser and see some random items from the catalog. <a data-type="xref" href="#random_item_figure">Figure 5-1</a> shows a sample.</p>&#13;
&#13;
<figure><div class="figure" id="random_item_figure">&#13;
<img alt="Random items from the Pinterest shop the look dataset" src="assets/brpj_0501.png"/>&#13;
<h6><span class="label">Figure 5-1. </span>Random-item recommender</h6>&#13;
</div></figure>&#13;
&#13;
<p>The <em>fashion-catalog.json</em> file contains descriptions of products and their Pinterest ID, while <em>fashion.json</em> contains pairings of a scene with a recommended product.</p>&#13;
&#13;
<p>Next, we’ll look at how to recommend multiple new items for a single scene by training an ML model on scene-product pairings.</p>&#13;
&#13;
<p>It<a data-primary="recommendation systems" data-secondary="tips for building" data-type="indexterm" id="id492"/> is generally a good idea to create a random-item recommender the first time you encounter a corpus just so you have an idea of the kind of items in the corpus and you have a baseline to compare to.<a data-primary="" data-startref="CBRran05" data-type="indexterm" id="id493"/><a data-primary="" data-startref="randitem05" data-type="indexterm" id="id494"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Obtaining the STL Dataset Images" data-type="sect1"><div class="sect1" id="id201">&#13;
<h1>Obtaining the STL Dataset Images</h1>&#13;
&#13;
<p>The<a data-primary="content-based recommender" data-secondary="obtaining STL dataset images" data-type="indexterm" id="id495"/> first step in the process of creating a content-based recommender is fetching the content. In this case, the STL dataset’s content is mostly images, with some metadata about the image (like the type of product). We will be using just the image content for this chapter.</p>&#13;
&#13;
<p>You can look at the code in <em>fetch_images.py</em> to see how this is done, by using the Python standard library urllib to fetch the images. Be aware that doing too much fetching on someone else’s website might trigger their bot defenses and cause them to blacklist your IP address, so it might be a wise idea to rate-limit fetches or find some other way to get the data.</p>&#13;
&#13;
<p>We have downloaded thousands of image files and put them together into an archive as a Weights &amp; Biases artifact. Since the archive is already in this artifact, you <span class="keep-together">don’t need</span> to scrape the images yourself, but the code we’ve supplied will allow <span class="keep-together">you to do so.</span></p>&#13;
&#13;
<p>You can read up on artifacts in the <a href="https://oreil.ly/NXTYP">Weights &amp; Biases documentation</a>. Artifacts are an MLOps concept that version and package together archives of data and track producers and consumers of the data.</p>&#13;
&#13;
<p class="less_space pagebreak-before">You can download the image artifact by running the following:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">wandb<code class="w"> </code>artifact<code class="w"> </code>get<code class="w"> </code>building-recsys/recsys-pinterest/shop_the_look:latest<code class="w"/></pre>&#13;
&#13;
<p>The images will then be in the local directory <em>artifacts/shop_the_look:v1</em>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Convolutional Neural Network Definition" data-type="sect1"><div class="sect1" id="id46">&#13;
<h1>Convolutional Neural Network Definition</h1>&#13;
&#13;
<p>Now<a data-primary="content-based recommender" data-secondary="convolutional neural network definition" data-type="indexterm" id="id496"/><a data-primary="convolutional neural networks (CNNs)" data-secondary="defining" data-type="indexterm" id="id497"/> that we have the images, the next step is figuring out how to represent the data. Images come in different sizes and are a complex type of content to analyze. We can use the raw pixels as the representation of our content, but the drawback is that tiny changes in pixel values can cause large differences in the distance between images. We do not want that. Rather, we want to somehow learn what is important in the images and ignore parts of the image, such as the background color, that might not be as important.</p>&#13;
&#13;
<p>For this task, we will use a <a href="https://oreil.ly/r6KpS">convolutional neural network (CNN)</a> to compute an embedding vector for the image. An<a data-primary="embedding vector" data-type="indexterm" id="id498"/> <em>embedding vector</em> is a kind of feature vector for the image that is learned from data and is of fixed size. We use embedding vectors for our representation because we want our database to be small and compact, easy to score over large numbers of images in the corpus, and relevant to the task at hand, which is to match products to a given scene image.</p>&#13;
&#13;
<p>The neural network architecture we use is a variant of<a data-primary="residual networks (Resnet)" data-type="indexterm" id="id499"/> residual networks, or Resnet. Refer to <a href="https://oreil.ly/XQYUh">“Deep Residual Learning for Image Recognition”</a> by Kaiming He et al. for details about the architecture and for references on CNNs. Briefly, a convolution layer repeatedly applies a small filter of typically 3 × 3 size over an image. This results in a feature map of the same resolution as the input if the stride is (1, 1) (which means apply the filter with a 1-pixel step in the x direction and a 1-pixel step in the y direction), or quarter size if the stride is (2, 2). The residual skip connection is just a shortcut from the previous input layer to the next, so in effect, the nonlinear part of the networks learns the residual from the linear skip part, hence the name residual network.</p>&#13;
&#13;
<p>Additionally, we use the<a data-primary="BatchNorm layer" data-type="indexterm" id="id500"/> BatchNorm layer, details of which can be found at <a href="https://oreil.ly/qM-yg">“Batch Normalization: Accelerating Deep Network Training by Reducing Internal Covariate Shift”</a> by Sergey Ioffe and Christian Szegedy, and the <a href="https://oreil.ly/9Zlqb">“Searching for Activation Functions”</a> by Prajit Ramachandran, Barret Zoph, and Quoc V. Le.</p>&#13;
&#13;
<p>Once we specify the model, we also need to optimize it for the task.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Model Training in JAX, Flax, and Optax" data-type="sect1"><div class="sect1" id="id47">&#13;
<h1>Model Training in JAX, Flax, and Optax</h1>&#13;
&#13;
<p>Optimizing<a data-primary="content-based recommender" data-secondary="optimizing" data-type="indexterm" id="CBRopt05"/><a data-primary="optimization" data-secondary="content-based recommender" data-type="indexterm" id="Ocontentbased05"/><a data-primary="JAX framework" data-secondary="optimizing models with" data-type="indexterm" id="JAXopt05"/><a data-primary="Flax framework" data-secondary="optimizing models with" data-type="indexterm" id="FFoptim05"/><a data-primary="Optax library" data-type="indexterm" id="OPToptim05"/> our model should be pretty straightforward in any ML framework. Here we show how to do it easily with <a href="https://oreil.ly/pcmCU">JAX</a>, <a href="https://oreil.ly/RtzDn">Flax</a>, and <a href="https://oreil.ly/vOCvF">Optax</a>. <em>JAX</em> is a lower-level NumPy-like ML library, and <em>Flax</em> is a higher-level neural network library that provides functionality such as neural network modules and embedding layers. <em>Optax</em> is a library that does optimization that we will use to minimize our loss function.</p>&#13;
&#13;
<p>If you are familiar with NumPy, JAX is quite easy to pick up. JAX shares the same API as NumPy but has the capability of running the resulting code on vector processors such as GPUs or TPUs by doing JIT compilation. JAX device arrays and NumPy arrays can be easily converted back and forth, which makes it easy to develop for the GPU and yet easy to debug on the CPU.</p>&#13;
&#13;
<p>In addition to learning how to represent the images, we also need to specify how they are related to one another.</p>&#13;
&#13;
<p>Since the embedding vectors are of fixed dimensions, the easiest similarity score is simply the dot product of the two vectors. See <a data-type="xref" href="ch09.html#sim_measures">“Similarity from Co-occurrence”</a> for other kinds of similarity measures. So, given an image for a scene, we compute the scene embedding and do the same for the product to obtain a product embedding, and take the dot product of the two to obtain a score for the closeness of fit of a scene <math alttext="ModifyingAbove s With right-arrow">&#13;
  <mover accent="true"><mi>s</mi> <mo>→</mo></mover>&#13;
</math> to a product <math alttext="ModifyingAbove p With right-arrow">&#13;
  <mover accent="true"><mi>p</mi> <mo>→</mo></mover>&#13;
</math>:</p>&#13;
<div data-type="equation">&#13;
<math alttext="s c o r e left-parenthesis ModifyingAbove s With right-arrow comma ModifyingAbove p With right-arrow right-parenthesis equals ModifyingAbove s With right-arrow asterisk ModifyingAbove p With right-arrow" display="block">&#13;
  <mrow>&#13;
    <mi>s</mi>&#13;
    <mi>c</mi>&#13;
    <mi>o</mi>&#13;
    <mi>r</mi>&#13;
    <mi>e</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mover accent="true"><mi>s</mi> <mo>→</mo></mover>&#13;
      <mo>,</mo>&#13;
      <mover accent="true"><mi>p</mi> <mo>→</mo></mover>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>=</mo>&#13;
    <mover accent="true"><mi>s</mi> <mo>→</mo></mover>&#13;
    <mo>*</mo>&#13;
    <mover accent="true"><mi>p</mi> <mo>→</mo></mover>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>We use CNNs to obtain the embedding of an image.</p>&#13;
&#13;
<p>We use separate CNNs for the scene and product, however, because they come from different kinds of images. Scenes tend to show the context we’re matching products to and contain people and the setting, whereas products tend to be catalog images of shoes and bags with a blank background, so we need different neural networks to determine what is important in the image.</p>&#13;
&#13;
<p>Once we have the score, that alone is not sufficient, though. We need to make sure that a good match of a scene and product, which we call the<a data-primary="positive product" data-type="indexterm" id="id501"/> <em>positive product</em>, is higher scoring than a negative product. The positive product is a good match for the scene, and the negative product is a not-so-good match for the scene. The positive product comes from the training data, and the negative product comes from randomly sampling the catalog. A loss that can capture the relationship between a positive scene-product pair (A, B) and negative scene-product pair (A, C) is called<a data-primary="triplet loss" data-type="indexterm" id="id502"/> <em>triplet loss</em>. Let’s go into some detail for defining the <a href="https://oreil.ly/alBxu">triplet loss</a>.</p>&#13;
&#13;
<p>Suppose we want the score for the positive scene-product pair to be one more than a negative scene-product pair. We then have the following inequality:</p>&#13;
<div data-type="equation">&#13;
<math alttext="s c o r e left-parenthesis s c e n e comma p o s Subscript p r o d u c t Baseline right-parenthesis greater-than s c o r e left-parenthesis s c e n e comma n e g Subscript p r o d u c t Baseline right-parenthesis plus 1" display="block">&#13;
  <mrow>&#13;
    <mi>s</mi>&#13;
    <mi>c</mi>&#13;
    <mi>o</mi>&#13;
    <mi>r</mi>&#13;
    <mi>e</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>s</mi>&#13;
      <mi>c</mi>&#13;
      <mi>e</mi>&#13;
      <mi>n</mi>&#13;
      <mi>e</mi>&#13;
      <mo>,</mo>&#13;
      <mi>p</mi>&#13;
      <mi>o</mi>&#13;
      <msub><mi>s</mi> <mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>&gt;</mo>&#13;
    <mi>s</mi>&#13;
    <mi>c</mi>&#13;
    <mi>o</mi>&#13;
    <mi>r</mi>&#13;
    <mi>e</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>s</mi>&#13;
      <mi>c</mi>&#13;
      <mi>e</mi>&#13;
      <mi>n</mi>&#13;
      <mi>e</mi>&#13;
      <mo>,</mo>&#13;
      <mi>n</mi>&#13;
      <mi>e</mi>&#13;
      <msub><mi>g</mi> <mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>+</mo>&#13;
    <mn>1</mn>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>The 1 is just an arbitrary constant we use, called a<a data-primary="margin" data-type="indexterm" id="id503"/> <em>margin</em>, to make sure that the positive scene-product score is larger than the negative scene-product score.</p>&#13;
&#13;
<p>Since the process of gradient descent minimizes a function, we then convert the preceding inequality into a loss function by moving all terms to one side:</p>&#13;
<div data-type="equation">&#13;
<math alttext="0 greater-than 1 plus s c o r e left-parenthesis s c e n e comma n e g Subscript p r o d u c t Baseline right-parenthesis minus s c o r e left-parenthesis s c e n e comma p o s Subscript p r o d u c t Baseline right-parenthesis" display="block">&#13;
  <mrow>&#13;
    <mn>0</mn>&#13;
    <mo>&gt;</mo>&#13;
    <mn>1</mn>&#13;
    <mo>+</mo>&#13;
    <mi>s</mi>&#13;
    <mi>c</mi>&#13;
    <mi>o</mi>&#13;
    <mi>r</mi>&#13;
    <mi>e</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>s</mi>&#13;
      <mi>c</mi>&#13;
      <mi>e</mi>&#13;
      <mi>n</mi>&#13;
      <mi>e</mi>&#13;
      <mo>,</mo>&#13;
      <mi>n</mi>&#13;
      <mi>e</mi>&#13;
      <msub><mi>g</mi> <mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>-</mo>&#13;
    <mi>s</mi>&#13;
    <mi>c</mi>&#13;
    <mi>o</mi>&#13;
    <mi>r</mi>&#13;
    <mi>e</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>s</mi>&#13;
      <mi>c</mi>&#13;
      <mi>e</mi>&#13;
      <mi>n</mi>&#13;
      <mi>e</mi>&#13;
      <mo>,</mo>&#13;
      <mi>p</mi>&#13;
      <mi>o</mi>&#13;
      <msub><mi>s</mi> <mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
  </mrow>&#13;
</math>&#13;
</div>&#13;
&#13;
<p>As long as the quantity on the right side is larger than 0, we want to minimize it; but if it is already less than 0, we do not. Therefore, we encode the quantity in a rectified linear unit, which is represented by the function <code>max(0, <em>x</em>)</code>. We can thus write out our loss function as follows:</p>&#13;
<ul class="simplelist">&#13;
<li><math alttext="l o s s left-parenthesis s c e n e comma p o s Subscript p r o d u c t Baseline comma n e g Subscript p r o d u c t Baseline right-parenthesis equals">&#13;
  <mrow>&#13;
    <mi>l</mi>&#13;
    <mi>o</mi>&#13;
    <mi>s</mi>&#13;
    <mi>s</mi>&#13;
    <mo>(</mo>&#13;
    <mi>s</mi>&#13;
    <mi>c</mi>&#13;
    <mi>e</mi>&#13;
    <mi>n</mi>&#13;
    <mi>e</mi>&#13;
    <mo>,</mo>&#13;
    <mi>p</mi>&#13;
    <mi>o</mi>&#13;
    <msub><mi>s</mi> <mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow> </msub>&#13;
    <mo>,</mo>&#13;
    <mi>n</mi>&#13;
    <mi>e</mi>&#13;
    <msub><mi>g</mi> <mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow> </msub>&#13;
    <mo>)</mo>&#13;
    <mo>=</mo>&#13;
  </mrow>&#13;
</math>&#13;
<math alttext="m a x left-parenthesis 0 comma 1 plus s c o r e left-parenthesis s c e n e comma n e g Subscript p r o d u c t Baseline right-parenthesis minus s c o r e left-parenthesis s c e n e comma p o s Subscript p r o d u c t Baseline right-parenthesis right-parenthesis">&#13;
  <mrow>&#13;
    <mi>m</mi>&#13;
    <mi>a</mi>&#13;
    <mi>x</mi>&#13;
    <mo>(</mo>&#13;
    <mn>0</mn>&#13;
    <mo>,</mo>&#13;
    <mn>1</mn>&#13;
    <mo>+</mo>&#13;
    <mi>s</mi>&#13;
    <mi>c</mi>&#13;
    <mi>o</mi>&#13;
    <mi>r</mi>&#13;
    <mi>e</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>s</mi>&#13;
      <mi>c</mi>&#13;
      <mi>e</mi>&#13;
      <mi>n</mi>&#13;
      <mi>e</mi>&#13;
      <mo>,</mo>&#13;
      <mi>n</mi>&#13;
      <mi>e</mi>&#13;
      <msub><mi>g</mi> <mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>-</mo>&#13;
    <mi>s</mi>&#13;
    <mi>c</mi>&#13;
    <mi>o</mi>&#13;
    <mi>r</mi>&#13;
    <mi>e</mi>&#13;
    <mrow>&#13;
      <mo>(</mo>&#13;
      <mi>s</mi>&#13;
      <mi>c</mi>&#13;
      <mi>e</mi>&#13;
      <mi>n</mi>&#13;
      <mi>e</mi>&#13;
      <mo>,</mo>&#13;
      <mi>p</mi>&#13;
      <mi>o</mi>&#13;
      <msub><mi>s</mi> <mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>c</mi><mi>t</mi></mrow> </msub>&#13;
      <mo>)</mo>&#13;
    </mrow>&#13;
    <mo>)</mo>&#13;
  </mrow>&#13;
</math></li>&#13;
</ul>&#13;
<p> </p>&#13;
&#13;
<p>Since we usually minimize loss functions, this ensures that as long as the <code>score(scene, neg_product)</code> is 1 more than <code>score(scene, pos_product)</code>, the optimization procedure will try to minimize the score of the negative pair while increasing the score of the positive pair.</p>&#13;
&#13;
<p>The next example covers the following modules in order so that they make sense as they follow the flow of data from reading to training to making recommendations:</p>&#13;
<dl>&#13;
<dt><em>input__pipeline.py</em></dt>&#13;
<dd>&#13;
<p>How the data is read</p>&#13;
</dd>&#13;
<dt><em>models.py</em></dt>&#13;
<dd>&#13;
<p>How the neural networks are specified</p>&#13;
</dd>&#13;
<dt><em>train_shop_the_look.py</em></dt>&#13;
<dd>&#13;
<p>How the neural network is fit using Optax</p>&#13;
</dd>&#13;
<dt><em>make_embeddings.py</em></dt>&#13;
<dd>&#13;
<p>How to make a compact database of scene and products</p>&#13;
</dd>&#13;
<dt><em>make_recommendations.py</em></dt>&#13;
<dd>&#13;
<p>How to use the compact database of embeddings to create a list of product recommendations per scene<a data-primary="" data-startref="CBRopt05" data-type="indexterm" id="id504"/><a data-primary="" data-startref="JAXopt05" data-type="indexterm" id="id505"/><a data-primary="" data-startref="FFoptim05" data-type="indexterm" id="id506"/><a data-primary="" data-startref="OPToptim05" data-type="indexterm" id="id507"/><a data-primary="" data-startref="Ocontentbased05" data-type="indexterm" id="id508"/></p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Input Pipeline" data-type="sect1"><div class="sect1" id="id48">&#13;
<h1>Input Pipeline</h1>&#13;
&#13;
<p><a data-type="xref" href="#example0502">Example 5-2</a> shows<a data-primary="content-based recommender" data-secondary="input pipeline" data-type="indexterm" id="CBRinput05"/> the code for <em>input_pipeline.py</em>. We<a data-primary="TensorFlow library" data-type="indexterm" id="id509"/> use the ML library <a href="https://oreil.ly/hsqPr">TensorFlow</a> for its data pipeline.</p>&#13;
<div data-type="example" id="example0502">&#13;
<h5><span class="label">Example 5-2. </span>TensorFlow data pipeline</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">tensorflow</code> <code class="k">as</code> <code class="nn">tf</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">normalize_image</code><code class="p">(</code><code class="n">img</code><code class="p">):</code>&#13;
  <code class="n">img</code> <code class="o">=</code> <code class="n">tf</code><code class="o">.</code><code class="n">cast</code><code class="p">(</code><code class="n">img</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">tf</code><code class="o">.</code><code class="n">float32</code><code class="p">)</code>&#13;
  <code class="n">img</code> <code class="o">=</code> <code class="p">(</code><code class="n">img</code> <code class="o">/</code> <code class="mf">255.0</code><code class="p">)</code> <code class="o">-</code> <code class="mf">0.5</code>&#13;
  <code class="k">return</code> <code class="n">img</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">process_image</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>&#13;
  <code class="n">x</code> <code class="o">=</code> <code class="n">tf</code><code class="o">.</code><code class="n">io</code><code class="o">.</code><code class="n">read_file</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>&#13;
  <code class="n">x</code> <code class="o">=</code> <code class="n">tf</code><code class="o">.</code><code class="n">io</code><code class="o">.</code><code class="n">decode_jpeg</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">channels</code><code class="o">=</code><code class="mi">3</code><code class="p">)</code>&#13;
  <code class="n">x</code> <code class="o">=</code> <code class="n">tf</code><code class="o">.</code><code class="n">image</code><code class="o">.</code><code class="n">resize_with_crop_or_pad</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="mi">512</code><code class="p">,</code> <code class="mi">512</code><code class="p">)</code>&#13;
  <code class="n">x</code> <code class="o">=</code> <code class="n">normalize_image</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>&#13;
  <code class="k">return</code> <code class="n">x</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">process_image_with_id</code><code class="p">(</code><code class="nb">id</code><code class="p">):</code>&#13;
  <code class="n">image</code> <code class="o">=</code> <code class="n">process_image</code><code class="p">(</code><code class="nb">id</code><code class="p">)</code>&#13;
  <code class="k">return</code> <code class="nb">id</code><code class="p">,</code> <code class="n">image</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">process_triplet</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>&#13;
  <code class="n">x</code> <code class="o">=</code> <code class="p">(</code><code class="n">process_image</code><code class="p">(</code><code class="n">x</code><code class="p">[</code><code class="mi">0</code><code class="p">]),</code> <code class="n">process_image</code><code class="p">(</code><code class="n">x</code><code class="p">[</code><code class="mi">1</code><code class="p">]),</code> <code class="n">process_image</code><code class="p">(</code><code class="n">x</code><code class="p">[</code><code class="mi">2</code><code class="p">]))</code>&#13;
  <code class="k">return</code> <code class="n">x</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create_dataset</code><code class="p">(</code>&#13;
    <code class="n">triplet</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">[</code><code class="n">Tuple</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="nb">str</code><code class="p">,</code> <code class="nb">str</code><code class="p">]]):</code>&#13;
    <code class="sd">"""Creates a triplet dataset.</code>&#13;
<code class="sd">    Args:</code>&#13;
<code class="sd">      triplet: filenames of scene, positive product, negative product.</code>&#13;
<code class="sd">    """</code>&#13;
    <code class="n">ds</code> <code class="o">=</code> <code class="n">tf</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">Dataset</code><code class="o">.</code><code class="n">from_tensor_slices</code><code class="p">(</code><code class="n">triplet</code><code class="p">)</code>&#13;
    <code class="n">ds</code> <code class="o">=</code> <code class="n">ds</code><code class="o">.</code><code class="n">map</code><code class="p">(</code><code class="n">process_triplet</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">ds</code></pre></div>&#13;
&#13;
<p>You can see that <code>create_dataset</code> takes in three filenames: that of a scene, then a positive match and a negative match. For this example, the negative match is simply selected at random from the catalog. We cover more sophisticated ways of picking the negative in <a data-type="xref" href="ch12.html#LossFunctions">Chapter 12</a>. The image filenames are processed by reading the file, decoding the image, cropping it to a fixed size, and then rescaling the data so that it becomes a floating-point image centered around 0 and with small values between –1 and 1. We do this because most neural networks are initialized with the assumption that the data they get is roughly normally distributed, and so if you pass in too large a value, it would be far out of the norm of the expected input range.</p>&#13;
&#13;
<p><a data-type="xref" href="#example0503">Example 5-3</a> shows how to specify our CNN and STL model with Flax.</p>&#13;
<div data-type="example" id="example0503">&#13;
<h5><span class="label">Example 5-3. </span>Defining the CNN model</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">flax</code> <code class="kn">import</code> <code class="n">linen</code> <code class="k">as</code> <code class="n">nn</code>&#13;
<code class="kn">import</code> <code class="nn">jax.numpy</code> <code class="k">as</code> <code class="nn">jnp</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">CNN</code><code class="p">(</code><code class="n">nn</code><code class="o">.</code><code class="n">Module</code><code class="p">):</code>&#13;
    <code class="sd">"""Simple CNN."""</code>&#13;
    <code class="n">filters</code> <code class="p">:</code> <code class="n">Sequence</code><code class="p">[</code><code class="nb">int</code><code class="p">]</code>&#13;
    <code class="n">output_size</code> <code class="p">:</code> <code class="nb">int</code>&#13;
&#13;
    <code class="nd">@nn</code><code class="o">.</code><code class="n">compact</code>&#13;
    <code class="k">def</code> <code class="fm">__call__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">x</code><code class="p">,</code> <code class="n">train</code><code class="p">:</code> <code class="nb">bool</code> <code class="o">=</code> <code class="kc">True</code><code class="p">):</code>&#13;
        <code class="k">for</code> <code class="nb">filter</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">filters</code><code class="p">:</code>&#13;
            <code class="c1"># Stride 2 downsamples 2x.</code>&#13;
            <code class="n">residual</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">Conv</code><code class="p">(</code><code class="nb">filter</code><code class="p">,</code> <code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="mi">3</code><code class="p">),</code> <code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">2</code><code class="p">))(</code><code class="n">x</code><code class="p">)</code>&#13;
            <code class="n">x</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">Conv</code><code class="p">(</code><code class="nb">filter</code><code class="p">,</code> <code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="mi">3</code><code class="p">),</code> <code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">2</code><code class="p">))(</code><code class="n">x</code><code class="p">)</code>&#13;
            <code class="n">x</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">BatchNorm</code><code class="p">(</code>&#13;
              <code class="n">use_running_average</code><code class="o">=</code><code class="ow">not</code> <code class="n">train</code><code class="p">,</code> <code class="n">use_bias</code><code class="o">=</code><code class="kc">False</code><code class="p">)(</code><code class="n">x</code><code class="p">)</code>&#13;
            <code class="n">x</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">swish</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>&#13;
            <code class="n">x</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">Conv</code><code class="p">(</code><code class="nb">filter</code><code class="p">,</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">))(</code><code class="n">x</code><code class="p">)</code>&#13;
            <code class="n">x</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">BatchNorm</code><code class="p">(</code>&#13;
              <code class="n">use_running_average</code><code class="o">=</code><code class="ow">not</code> <code class="n">train</code><code class="p">,</code> <code class="n">use_bias</code><code class="o">=</code><code class="kc">False</code><code class="p">)(</code><code class="n">x</code><code class="p">)</code>&#13;
            <code class="n">x</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">swish</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>&#13;
            <code class="n">x</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">Conv</code><code class="p">(</code><code class="nb">filter</code><code class="p">,</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code> <code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">))(</code><code class="n">x</code><code class="p">)</code>&#13;
            <code class="n">x</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">BatchNorm</code><code class="p">(</code>&#13;
              <code class="n">use_running_average</code><code class="o">=</code><code class="ow">not</code> <code class="n">train</code><code class="p">,</code> <code class="n">use_bias</code><code class="o">=</code><code class="kc">False</code><code class="p">)(</code><code class="n">x</code><code class="p">)</code>&#13;
            <code class="n">x</code> <code class="o">=</code> <code class="n">x</code> <code class="o">+</code> <code class="n">residual</code>&#13;
            <code class="c1"># Average pool downsamples 2x.</code>&#13;
            <code class="n">x</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">avg_pool</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="mi">3</code><code class="p">),</code> <code class="n">strides</code><code class="o">=</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code> <code class="n">padding</code><code class="o">=</code><code class="s2">"SAME"</code><code class="p">)</code>&#13;
        <code class="n">x</code> <code class="o">=</code> <code class="n">jnp</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">axis</code><code class="o">=</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">))</code>&#13;
        <code class="n">x</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">Dense</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">output_size</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">jnp</code><code class="o">.</code><code class="n">float32</code><code class="p">)(</code><code class="n">x</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">x</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">STLModel</code><code class="p">(</code><code class="n">nn</code><code class="o">.</code><code class="n">Module</code><code class="p">):</code>&#13;
    <code class="sd">"""Shop the look model that takes in a scene</code>&#13;
<code class="sd">        and item and computes a score for them.</code>&#13;
<code class="sd">    """</code>&#13;
    <code class="n">output_size</code> <code class="p">:</code> <code class="nb">int</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">setup</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="n">default_filter</code> <code class="o">=</code> <code class="p">[</code><code class="mi">16</code><code class="p">,</code> <code class="mi">32</code><code class="p">,</code> <code class="mi">64</code><code class="p">,</code> <code class="mi">128</code><code class="p">]</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">scene_cnn</code> <code class="o">=</code> <code class="n">CNN</code><code class="p">(</code>&#13;
          <code class="n">filters</code><code class="o">=</code><code class="n">default_filter</code><code class="p">,</code> <code class="n">output_size</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">output_size</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">product_cnn</code> <code class="o">=</code> <code class="n">CNN</code><code class="p">(</code>&#13;
          <code class="n">filters</code><code class="o">=</code><code class="n">default_filter</code><code class="p">,</code> <code class="n">output_size</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">output_size</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">get_scene_embed</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">scene</code><code class="p">):</code>&#13;
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">scene_cnn</code><code class="p">(</code><code class="n">scene</code><code class="p">,</code> <code class="kc">False</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">get_product_embed</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">product</code><code class="p">):</code>&#13;
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">product_cnn</code><code class="p">(</code><code class="n">product</code><code class="p">,</code> <code class="kc">False</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="fm">__call__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">scene</code><code class="p">,</code> <code class="n">pos_product</code><code class="p">,</code> <code class="n">neg_product</code><code class="p">,</code>&#13;
                 <code class="n">train</code><code class="p">:</code> <code class="nb">bool</code> <code class="o">=</code> <code class="kc">True</code><code class="p">):</code>&#13;
        <code class="n">scene_embed</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">scene_cnn</code><code class="p">(</code><code class="n">scene</code><code class="p">,</code> <code class="n">train</code><code class="p">)</code>&#13;
&#13;
        <code class="n">pos_product_embed</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">product_cnn</code><code class="p">(</code><code class="n">pos_product</code><code class="p">,</code> <code class="n">train</code><code class="p">)</code>&#13;
        <code class="n">pos_score</code> <code class="o">=</code> <code class="n">scene_embed</code> <code class="o">*</code> <code class="n">pos_product_embed</code>&#13;
        <code class="n">pos_score</code> <code class="o">=</code> <code class="n">jnp</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">pos_score</code><code class="p">,</code> <code class="n">axis</code><code class="o">=-</code><code class="mi">1</code><code class="p">)</code>&#13;
&#13;
        <code class="n">neg_product_embed</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">product_cnn</code><code class="p">(</code><code class="n">neg_product</code><code class="p">,</code> <code class="n">train</code><code class="p">)</code>&#13;
        <code class="n">neg_score</code> <code class="o">=</code> <code class="n">scene_embed</code> <code class="o">*</code> <code class="n">neg_product_embed</code>&#13;
        <code class="n">neg_score</code> <code class="o">=</code> <code class="n">jnp</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">neg_score</code><code class="p">,</code> <code class="n">axis</code><code class="o">=-</code><code class="mi">1</code><code class="p">)</code>&#13;
&#13;
        <code class="k">return</code> <code class="n">pos_score</code><code class="p">,</code> <code class="n">neg_score</code><code class="p">,</code> <code class="n">scene_embed</code><code class="p">,</code>&#13;
          <code class="n">pos_product_embed</code><code class="p">,</code> <code class="n">neg_product_embed</code></pre></div>&#13;
&#13;
<p>Here<a data-primary="Flax framework" data-secondary="Module class" data-type="indexterm" id="id510"/><a data-primary="Module class (Flax)" data-type="indexterm" id="id511"/> we use Flax’s neural network class <code>Module</code>. The annotation <code>nn.compact</code> is there so we do not have to specify a setup function for simple neural network architectures like this one and can simply specify the layers in the <code>call</code> function. The <code>call</code> function accepts two parameters, an image <code><em>x</em></code> and a Boolean <code>train</code> that tells the module whether we are calling it in training mode. The reason we need the Boolean training is that the BatchNorm layers are updated only during training and are not updated when the network is fully learned.</p>&#13;
&#13;
<p>If you look at the CNN specification code, you can see how we set up the residual network. We can freely mix neural network functions like <code>swish</code> with JAX functions like <code>mean</code>. The <code>swish</code> function is a nonlinear activation for the neural network that transforms the input in such a way as to weight some values of activation more than others.</p>&#13;
&#13;
<p>The<a data-primary="STL model" data-type="indexterm" id="id512"/> STL model, on the other hand, has a more complicated setup, so we have to specify the setup code to create two CNN towers: one for the scene and another for the product. A<a data-primary="CNN tower" data-type="indexterm" id="id513"/> <em>CNN tower</em> is just a copy of the same architecture but has different weights for different image types. As mentioned earlier, we have a different tower for each type of image because each represents different things; one tower is for the scene (which provides the context to which we are matching products), and a separate tower is for the products. As a result, we add in two different methods for converting scene and product images into scene and product embeddings.</p>&#13;
&#13;
<p class="less_space pagebreak-before">The call is also different. It doesn’t have the annotation compact because we have a more complicated setup. In the call function for the STL model, we first compute the scene embedding, then the positive product embedding, and then the positive score. After that, we do the same for the negative score. We then return the positive score, negative score, and all three embedding vectors. We return the embedding vectors as well as the scores because we want to ensure that the model generalizes to new, unseen data as in a held-out validation set, so we want to make sure the embedding vectors are not too large. The concept of capping their size is called<a data-primary="regularization" data-type="indexterm" id="id514"/> <em>regularization</em>.</p>&#13;
&#13;
<p>Now let’s take a look at <em>train_shop_the_look.py</em> (<a data-type="xref" href="#example0504">Example 5-4</a>). We’ll break it into separate function calls and discuss them one by one.</p>&#13;
<div data-type="example" id="example0504">&#13;
<h5><span class="label">Example 5-4. </span>Generating triplets for training</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">generate_triplets</code><code class="p">(</code>&#13;
    <code class="n">scene_product</code><code class="p">:</code> <code class="n">Sequence</code><code class="p">[</code><code class="n">Tuple</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="nb">str</code><code class="p">]],</code>&#13;
    <code class="n">num_neg</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Sequence</code><code class="p">[</code><code class="n">Tuple</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="nb">str</code><code class="p">,</code> <code class="nb">str</code><code class="p">]]:</code>&#13;
    <code class="sd">"""Generate positive and negative triplets."""</code>&#13;
    <code class="n">count</code> <code class="o">=</code> <code class="nb">len</code><code class="p">(</code><code class="n">scene_product</code><code class="p">)</code>&#13;
    <code class="n">train</code> <code class="o">=</code> <code class="p">[]</code>&#13;
    <code class="n">test</code> <code class="o">=</code> <code class="p">[]</code>&#13;
    <code class="n">key</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">PRNGKey</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">count</code><code class="p">):</code>&#13;
        <code class="n">scene</code><code class="p">,</code> <code class="n">pos</code> <code class="o">=</code> <code class="n">scene_product</code><code class="p">[</code><code class="n">i</code><code class="p">]</code>&#13;
        <code class="n">is_test</code> <code class="o">=</code> <code class="n">i</code> <code class="o">%</code> <code class="mi">10</code> <code class="o">==</code> <code class="mi">0</code>&#13;
        <code class="n">key</code><code class="p">,</code> <code class="n">subkey</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>&#13;
        <code class="n">neg_indices</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">randint</code><code class="p">(</code><code class="n">subkey</code><code class="p">,</code> <code class="p">[</code><code class="n">num_neg</code><code class="p">],</code> <code class="mi">0</code><code class="p">,</code> <code class="n">count</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code>&#13;
        <code class="k">for</code> <code class="n">neg_idx</code> <code class="ow">in</code> <code class="n">neg_indices</code><code class="p">:</code>&#13;
            <code class="n">_</code><code class="p">,</code> <code class="n">neg</code> <code class="o">=</code> <code class="n">scene_product</code><code class="p">[</code><code class="n">neg_idx</code><code class="p">]</code>&#13;
            <code class="k">if</code> <code class="n">is_test</code><code class="p">:</code>&#13;
                <code class="n">test</code><code class="o">.</code><code class="n">append</code><code class="p">((</code><code class="n">scene</code><code class="p">,</code> <code class="n">pos</code><code class="p">,</code> <code class="n">neg</code><code class="p">))</code>&#13;
            <code class="k">else</code><code class="p">:</code>&#13;
                <code class="n">train</code><code class="o">.</code><code class="n">append</code><code class="p">((</code><code class="n">scene</code><code class="p">,</code> <code class="n">pos</code><code class="p">,</code> <code class="n">neg</code><code class="p">))</code>&#13;
    <code class="k">return</code> <code class="n">train</code><code class="p">,</code> <code class="n">test</code>&#13;
&#13;
 <code class="k">def</code> <code class="nf">shuffle_array</code><code class="p">(</code><code class="n">key</code><code class="p">,</code> <code class="n">x</code><code class="p">):</code>&#13;
    <code class="sd">"""Deterministic string shuffle."""</code>&#13;
    <code class="n">num</code> <code class="o">=</code> <code class="nb">len</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>&#13;
    <code class="n">to_swap</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">randint</code><code class="p">(</code><code class="n">key</code><code class="p">,</code> <code class="p">[</code><code class="n">num</code><code class="p">],</code> <code class="mi">0</code><code class="p">,</code> <code class="n">num</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">[</code><code class="n">x</code><code class="p">[</code><code class="n">t</code><code class="p">]</code> <code class="k">for</code> <code class="n">t</code> <code class="ow">in</code> <code class="n">to_swap</code><code class="p">]</code></pre></div>&#13;
&#13;
<p>The code fragment reads in the scene-product JSON database and generates triplets of scene, positive product, and negative products for the input pipeline. The interesting part to note here is how JAX handles random numbers. JAX’s philosophy is functional in nature, meaning that functions are pure and have no side effects. Random-number generators carry state, so in order to make JAX random-number generators function, you have to pass in the state to the random-number generator. The mechanism for this is to have a pseudo random number generator key, PNRGKey, as the object-carrying state. We initialize one arbitrarily from the number 0. Whenever we wish to use the key, though, we have to split it into two by using <code>jax.random.split</code>, then use one to generate the next random number and a subkey to perform the random action. In this case, we use the subkey to select a random negative from the entire corpus of products for our negative. We cover more complex ways to sample the negative in <a data-type="xref" href="ch12.html#LossFunctions">Chapter 12</a>, but randomly selecting a negative is the simplest way to construct the triplet for triplet loss.</p>&#13;
&#13;
<p>Similar to the way the negatives are selected, we again use JAX’s random functionality to generate a list of indices to swap, in order to shuffle the array for the training step. Random shuffling is important in stochastic gradient descent to break up any kind of structure in the training data to ensure that the gradients are stochastic. We use JAX’s random shuffling mechanism for better reproducibility so that experiments are more likely to be the same, given the same initial data and settings.</p>&#13;
&#13;
<p>The next pair of functions we will look at are listed in <a data-type="xref" href="#example0505">Example 5-5</a> and show how the train and eval steps are written. The train step takes the state of the model, which contains the model parameters as well as the gradient information, which varies depending on the optimizer being used. This step also takes in batches of scenes, positive products, and negative products in order to construct the triplet loss. In addition to optimizing for the triplet loss, we want to minimize the size of the embeddings whenever they go outside the unit sphere. The process of minimizing the size of the embeddings is called<a data-primary="regularization" data-type="indexterm" id="id515"/> <em>regularization</em>, so we add it to the triplet loss to obtain the final loss.</p>&#13;
<div data-type="example" id="example0505">&#13;
<h5><span class="label">Example 5-5. </span>Training and evaluation steps</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">train_step</code><code class="p">(</code><code class="n">state</code><code class="p">,</code> <code class="n">scene</code><code class="p">,</code> <code class="n">pos_product</code><code class="p">,</code>&#13;
               <code class="n">neg_product</code><code class="p">,</code> <code class="n">regularization</code><code class="p">,</code> <code class="n">batch_size</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="nf">loss_fn</code><code class="p">(</code><code class="n">params</code><code class="p">):</code>&#13;
        <code class="n">result</code><code class="p">,</code> <code class="n">new_model_state</code> <code class="o">=</code> <code class="n">state</code><code class="o">.</code><code class="n">apply_fn</code><code class="p">(</code>&#13;
            <code class="n">params</code><code class="p">,</code>&#13;
            <code class="n">scene</code><code class="p">,</code> <code class="n">pos_product</code><code class="p">,</code> <code class="n">neg_product</code><code class="p">,</code> <code class="kc">True</code><code class="p">,</code>&#13;
            <code class="n">mutable</code><code class="o">=</code><code class="p">[</code><code class="s1">'batch_stats'</code><code class="p">])</code>&#13;
        <code class="n">triplet_loss</code> <code class="o">=</code> <code class="n">jnp</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">nn</code><code class="o">.</code><code class="n">relu</code><code class="p">(</code><code class="mf">1.0</code> <code class="o">+</code> <code class="n">result</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="o">-</code> <code class="n">result</code><code class="p">[</code><code class="mi">0</code><code class="p">]))</code>&#13;
        <code class="k">def</code> <code class="nf">reg_fn</code><code class="p">(</code><code class="n">embed</code><code class="p">):</code>&#13;
            <code class="k">return</code> <code class="n">nn</code><code class="o">.</code><code class="n">relu</code><code class="p">(</code>&#13;
              <code class="n">jnp</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="n">jnp</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">jnp</code><code class="o">.</code><code class="n">square</code><code class="p">(</code><code class="n">embed</code><code class="p">),</code> <code class="n">axis</code><code class="o">=-</code><code class="mi">1</code><code class="p">))</code> <code class="o">-</code> <code class="mf">1.0</code><code class="p">)</code>&#13;
        <code class="n">reg_loss</code> <code class="o">=</code> <code class="n">reg_fn</code><code class="p">(</code><code class="n">result</code><code class="p">[</code><code class="mi">2</code><code class="p">])</code> <code class="o">+</code>&#13;
                   <code class="n">reg_fn</code><code class="p">(</code><code class="n">result</code><code class="p">[</code><code class="mi">3</code><code class="p">])</code> <code class="o">+</code> <code class="n">reg_fn</code><code class="p">(</code><code class="n">result</code><code class="p">[</code><code class="mi">4</code><code class="p">])</code>&#13;
        <code class="n">reg_loss</code> <code class="o">=</code> <code class="n">jnp</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">reg_loss</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="p">(</code><code class="n">triplet_loss</code> <code class="o">+</code> <code class="n">regularization</code> <code class="o">*</code> <code class="n">reg_loss</code><code class="p">)</code> <code class="o">/</code> <code class="n">batch_size</code>&#13;
&#13;
    <code class="n">grad_fn</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">value_and_grad</code><code class="p">(</code><code class="n">loss_fn</code><code class="p">)</code>&#13;
    <code class="n">loss</code><code class="p">,</code> <code class="n">grads</code> <code class="o">=</code> <code class="n">grad_fn</code><code class="p">(</code><code class="n">state</code><code class="o">.</code><code class="n">params</code><code class="p">)</code>&#13;
    <code class="n">new_state</code> <code class="o">=</code> <code class="n">state</code><code class="o">.</code><code class="n">apply_gradients</code><code class="p">(</code><code class="n">grads</code><code class="o">=</code><code class="n">grads</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">new_state</code><code class="p">,</code> <code class="n">loss</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">eval_step</code><code class="p">(</code><code class="n">state</code><code class="p">,</code> <code class="n">scene</code><code class="p">,</code> <code class="n">pos_product</code><code class="p">,</code> <code class="n">neg_product</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="nf">loss_fn</code><code class="p">(</code><code class="n">params</code><code class="p">):</code>&#13;
        <code class="n">result</code><code class="p">,</code> <code class="n">new_model_state</code> <code class="o">=</code> <code class="n">state</code><code class="o">.</code><code class="n">apply_fn</code><code class="p">(</code>&#13;
            <code class="n">state</code><code class="o">.</code><code class="n">params</code><code class="p">,</code>&#13;
            <code class="n">scene</code><code class="p">,</code> <code class="n">pos_product</code><code class="p">,</code> <code class="n">neg_product</code><code class="p">,</code> <code class="kc">True</code><code class="p">,</code>&#13;
            <code class="n">mutable</code><code class="o">=</code><code class="p">[</code><code class="s1">'batch_stats'</code><code class="p">])</code>&#13;
        <code class="c1"># Use a fixed margin for the eval.</code>&#13;
        <code class="n">triplet_loss</code> <code class="o">=</code> <code class="n">jnp</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">nn</code><code class="o">.</code><code class="n">relu</code><code class="p">(</code><code class="mf">1.0</code> <code class="o">+</code> <code class="n">result</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="o">-</code> <code class="n">result</code><code class="p">[</code><code class="mi">0</code><code class="p">]))</code>&#13;
        <code class="k">return</code> <code class="n">triplet_loss</code></pre></div>&#13;
&#13;
<p>Flax, being written on top of JAX, is also functional in philosophy, so the existing state is used to compute the gradient of the loss function, which when applied returns a new state variable. This ensures that the functions remain pure and the state variables are mutable.</p>&#13;
&#13;
<p>This functional philosophy is what allows JAX to JIT compile or use JIT functions so they run fast on CPU, GPU, or TPU.</p>&#13;
&#13;
<p>The eval step, in comparison, is rather simple. It just computes the triplet loss without the regularization loss as our evaluation metric. Again, we cover more sophisticated evaluation metrics in <a data-type="xref" href="ch11.html#PersonalRecMetrics">Chapter 11</a>.</p>&#13;
&#13;
<p>Finally, let’s take a look at the body of the training program, shown in <a data-type="xref" href="#example0506">Example 5-6</a>. We store our hyperparameters such as learning rate, regularization, and output size in a config dictionary. We do this so we can pass the config dictionary on to the Weights &amp; Biases MLOps service for safekeeping and also so we can do hyperparameter sweeps.</p>&#13;
<div data-type="example" id="example0506">&#13;
<h5><span class="label">Example 5-6. </span>Main body of code for training the model</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">main</code><code class="p">(</code><code class="n">argv</code><code class="p">):</code>&#13;
    <code class="sd">"""Main function."""</code>&#13;
    <code class="k">del</code> <code class="n">argv</code>  <code class="c1"># Unused.</code>&#13;
    <code class="n">config</code> <code class="o">=</code> <code class="p">{</code>&#13;
        <code class="s2">"learning_rate"</code> <code class="p">:</code> <code class="n">_LEARNING_RATE</code><code class="o">.</code><code class="n">value</code><code class="p">,</code>&#13;
        <code class="s2">"regularization"</code> <code class="p">:</code> <code class="n">_REGULARIZATION</code><code class="o">.</code><code class="n">value</code><code class="p">,</code>&#13;
        <code class="s2">"output_size"</code> <code class="p">:</code> <code class="n">_OUTPUT_SIZE</code><code class="o">.</code><code class="n">value</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="n">run</code> <code class="o">=</code> <code class="n">wandb</code><code class="o">.</code><code class="n">init</code><code class="p">(</code>&#13;
        <code class="n">config</code><code class="o">=</code><code class="n">config</code><code class="p">,</code>&#13;
        <code class="n">project</code><code class="o">=</code><code class="s2">"recsys-pinterest"</code>&#13;
    <code class="p">)</code>&#13;
&#13;
    <code class="n">tf</code><code class="o">.</code><code class="n">config</code><code class="o">.</code><code class="n">set_visible_devices</code><code class="p">([],</code> <code class="s1">'GPU'</code><code class="p">)</code>&#13;
    <code class="n">tf</code><code class="o">.</code><code class="n">compat</code><code class="o">.</code><code class="n">v1</code><code class="o">.</code><code class="n">enable_eager_execution</code><code class="p">()</code>&#13;
    <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="s2">"Image dir </code><code class="si">%s</code><code class="s2">, input file </code><code class="si">%s</code><code class="s2">"</code><code class="p">,</code>&#13;
      <code class="n">_IMAGE_DIRECTORY</code><code class="o">.</code><code class="n">value</code><code class="p">,</code> <code class="n">_INPUT_FILE</code><code class="o">.</code><code class="n">value</code><code class="p">)</code>&#13;
    <code class="n">scene_product</code> <code class="o">=</code> <code class="n">pin_util</code><code class="o">.</code><code class="n">get_valid_scene_product</code><code class="p">(</code>&#13;
      <code class="n">_IMAGE_DIRECTORY</code><code class="o">.</code><code class="n">value</code><code class="p">,</code> <code class="n">_INPUT_FILE</code><code class="o">.</code><code class="n">value</code><code class="p">)</code>&#13;
    <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="s2">"Found </code><code class="si">%d</code><code class="s2"> valid scene product pairs."</code> <code class="o">%</code> <code class="nb">len</code><code class="p">(</code><code class="n">scene_product</code><code class="p">))</code>&#13;
&#13;
    <code class="n">train</code><code class="p">,</code> <code class="n">test</code> <code class="o">=</code> <code class="n">generate_triplets</code><code class="p">(</code><code class="n">scene_product</code><code class="p">,</code> <code class="n">_NUM_NEG</code><code class="o">.</code><code class="n">value</code><code class="p">)</code>&#13;
    <code class="n">num_train</code> <code class="o">=</code> <code class="nb">len</code><code class="p">(</code><code class="n">train</code><code class="p">)</code>&#13;
    <code class="n">num_test</code> <code class="o">=</code> <code class="nb">len</code><code class="p">(</code><code class="n">test</code><code class="p">)</code>&#13;
    <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="s2">"Train triplets </code><code class="si">%d</code><code class="s2">"</code><code class="p">,</code> <code class="n">num_train</code><code class="p">)</code>&#13;
    <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="s2">"Test triplets </code><code class="si">%d</code><code class="s2">"</code><code class="p">,</code> <code class="n">num_test</code><code class="p">)</code>&#13;
&#13;
     <code class="c1"># Random shuffle the train.</code>&#13;
    <code class="n">key</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">PRNGKey</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>&#13;
    <code class="n">train</code> <code class="o">=</code> <code class="n">shuffle_array</code><code class="p">(</code><code class="n">key</code><code class="p">,</code> <code class="n">train</code><code class="p">)</code>&#13;
    <code class="n">test</code> <code class="o">=</code> <code class="n">shuffle_array</code><code class="p">(</code><code class="n">key</code><code class="p">,</code> <code class="n">test</code><code class="p">)</code>&#13;
    <code class="n">train</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">train</code><code class="p">)</code>&#13;
    <code class="n">test</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">test</code><code class="p">)</code>&#13;
&#13;
    <code class="n">train_ds</code> <code class="o">=</code> <code class="n">input_pipeline</code><code class="o">.</code><code class="n">create_dataset</code><code class="p">(</code><code class="n">train</code><code class="p">)</code><code class="o">.</code><code class="n">repeat</code><code class="p">()</code>&#13;
    <code class="n">train_ds</code> <code class="o">=</code> <code class="n">train_ds</code><code class="o">.</code><code class="n">batch</code><code class="p">(</code><code class="n">_BATCH_SIZE</code><code class="o">.</code><code class="n">value</code><code class="p">)</code><code class="o">.</code><code class="n">prefetch</code><code class="p">(</code>&#13;
      <code class="n">tf</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">AUTOTUNE</code><code class="p">)</code>&#13;
&#13;
    <code class="n">test_ds</code> <code class="o">=</code> <code class="n">input_pipeline</code><code class="o">.</code><code class="n">create_dataset</code><code class="p">(</code><code class="n">test</code><code class="p">)</code><code class="o">.</code><code class="n">repeat</code><code class="p">()</code>&#13;
    <code class="n">test_ds</code> <code class="o">=</code> <code class="n">test_ds</code><code class="o">.</code><code class="n">batch</code><code class="p">(</code><code class="n">_BATCH_SIZE</code><code class="o">.</code><code class="n">value</code><code class="p">)</code>&#13;
&#13;
    <code class="n">stl</code> <code class="o">=</code> <code class="n">models</code><code class="o">.</code><code class="n">STLModel</code><code class="p">(</code><code class="n">output_size</code><code class="o">=</code><code class="n">wandb</code><code class="o">.</code><code class="n">config</code><code class="o">.</code><code class="n">output_size</code><code class="p">)</code>&#13;
    <code class="n">train_it</code> <code class="o">=</code> <code class="n">train_ds</code><code class="o">.</code><code class="n">as_numpy_iterator</code><code class="p">()</code>&#13;
    <code class="n">test_it</code> <code class="o">=</code> <code class="n">test_ds</code><code class="o">.</code><code class="n">as_numpy_iterator</code><code class="p">()</code>&#13;
    <code class="n">x</code> <code class="o">=</code> <code class="nb">next</code><code class="p">(</code><code class="n">train_it</code><code class="p">)</code>&#13;
    <code class="n">key</code><code class="p">,</code> <code class="n">subkey</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="n">stl</code><code class="o">.</code><code class="n">init</code><code class="p">(</code><code class="n">subkey</code><code class="p">,</code> <code class="n">x</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code> <code class="n">x</code><code class="p">[</code><code class="mi">1</code><code class="p">],</code> <code class="n">x</code><code class="p">[</code><code class="mi">2</code><code class="p">])</code>&#13;
    <code class="n">tx</code> <code class="o">=</code> <code class="n">optax</code><code class="o">.</code><code class="n">adam</code><code class="p">(</code><code class="n">learning_rate</code><code class="o">=</code><code class="n">wandb</code><code class="o">.</code><code class="n">config</code><code class="o">.</code><code class="n">learning_rate</code><code class="p">)</code>&#13;
    <code class="n">state</code> <code class="o">=</code> <code class="n">train_state</code><code class="o">.</code><code class="n">TrainState</code><code class="o">.</code><code class="n">create</code><code class="p">(</code>&#13;
        <code class="n">apply_fn</code><code class="o">=</code><code class="n">stl</code><code class="o">.</code><code class="n">apply</code><code class="p">,</code> <code class="n">params</code><code class="o">=</code><code class="n">params</code><code class="p">,</code> <code class="n">tx</code><code class="o">=</code><code class="n">tx</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="n">_RESTORE_CHECKPOINT</code><code class="o">.</code><code class="n">value</code><code class="p">:</code>&#13;
        <code class="n">state</code> <code class="o">=</code> <code class="n">checkpoints</code><code class="o">.</code><code class="n">restore_checkpoint</code><code class="p">(</code><code class="n">_WORKDIR</code><code class="o">.</code><code class="n">value</code><code class="p">,</code> <code class="n">state</code><code class="p">)</code>&#13;
&#13;
    <code class="n">train_step_fn</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">jit</code><code class="p">(</code><code class="n">train_step</code><code class="p">)</code>&#13;
    <code class="n">eval_step_fn</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">jit</code><code class="p">(</code><code class="n">eval_step</code><code class="p">)</code>&#13;
&#13;
    <code class="n">losses</code> <code class="o">=</code> <code class="p">[]</code>&#13;
    <code class="n">init_step</code> <code class="o">=</code> <code class="n">state</code><code class="o">.</code><code class="n">step</code>&#13;
    <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="s2">"Starting at step </code><code class="si">%d</code><code class="s2">"</code><code class="p">,</code> <code class="n">init_step</code><code class="p">)</code>&#13;
    <code class="n">regularization</code> <code class="o">=</code> <code class="n">wandb</code><code class="o">.</code><code class="n">config</code><code class="o">.</code><code class="n">regularization</code>&#13;
    <code class="n">batch_size</code> <code class="o">=</code> <code class="n">_BATCH_SIZE</code><code class="o">.</code><code class="n">value</code>&#13;
    <code class="n">eval_steps</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">num_test</code> <code class="o">/</code> <code class="n">batch_size</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">init_step</code><code class="p">,</code> <code class="n">_MAX_STEPS</code><code class="o">.</code><code class="n">value</code> <code class="o">+</code> <code class="mi">1</code><code class="p">):</code>&#13;
        <code class="n">batch</code> <code class="o">=</code> <code class="nb">next</code><code class="p">(</code><code class="n">train_it</code><code class="p">)</code>&#13;
        <code class="n">scene</code> <code class="o">=</code> <code class="n">batch</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>&#13;
        <code class="n">pos_product</code> <code class="o">=</code> <code class="n">batch</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>&#13;
        <code class="n">neg_product</code> <code class="o">=</code> <code class="n">batch</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code>&#13;
&#13;
        <code class="n">state</code><code class="p">,</code> <code class="n">loss</code> <code class="o">=</code> <code class="n">train_step_fn</code><code class="p">(</code>&#13;
            <code class="n">state</code><code class="p">,</code> <code class="n">scene</code><code class="p">,</code> <code class="n">pos_product</code><code class="p">,</code> <code class="n">neg_product</code><code class="p">,</code>&#13;
            <code class="n">regularization</code><code class="p">,</code> <code class="n">batch_size</code><code class="p">)</code>&#13;
        <code class="n">losses</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">loss</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="n">i</code> <code class="o">%</code> <code class="n">_CHECKPOINT_EVERY_STEPS</code><code class="o">.</code><code class="n">value</code> <code class="o">==</code> <code class="mi">0</code> <code class="ow">and</code> <code class="n">i</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">:</code>&#13;
            <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="s2">"Saving checkpoint"</code><code class="p">)</code>&#13;
            <code class="n">checkpoints</code><code class="o">.</code><code class="n">save_checkpoint</code><code class="p">(</code>&#13;
              <code class="n">_WORKDIR</code><code class="o">.</code><code class="n">value</code><code class="p">,</code> <code class="n">state</code><code class="p">,</code> <code class="n">state</code><code class="o">.</code><code class="n">step</code><code class="p">,</code> <code class="n">keep</code><code class="o">=</code><code class="mi">3</code><code class="p">)</code>&#13;
        <code class="n">metrics</code> <code class="o">=</code> <code class="p">{</code>&#13;
            <code class="s2">"step"</code> <code class="p">:</code> <code class="n">state</code><code class="o">.</code><code class="n">step</code>&#13;
        <code class="p">}</code>&#13;
        <code class="k">if</code> <code class="n">i</code> <code class="o">%</code> <code class="n">_EVAL_EVERY_STEPS</code><code class="o">.</code><code class="n">value</code> <code class="o">==</code> <code class="mi">0</code> <code class="ow">and</code> <code class="n">i</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">:</code>&#13;
            <code class="n">eval_loss</code> <code class="o">=</code> <code class="p">[]</code>&#13;
            <code class="k">for</code> <code class="n">j</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">eval_steps</code><code class="p">):</code>&#13;
                <code class="n">ebatch</code> <code class="o">=</code> <code class="nb">next</code><code class="p">(</code><code class="n">test_it</code><code class="p">)</code>&#13;
                <code class="n">escene</code> <code class="o">=</code> <code class="n">ebatch</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>&#13;
                <code class="n">epos_product</code> <code class="o">=</code> <code class="n">ebatch</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>&#13;
                <code class="n">eneg_product</code> <code class="o">=</code> <code class="n">ebatch</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code>&#13;
                <code class="n">loss</code> <code class="o">=</code> <code class="n">eval_step_fn</code><code class="p">(</code>&#13;
                  <code class="n">state</code><code class="p">,</code> <code class="n">escene</code><code class="p">,</code> <code class="n">epos_product</code><code class="p">,</code> <code class="n">eneg_product</code><code class="p">)</code>&#13;
                <code class="n">eval_loss</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">loss</code><code class="p">)</code>&#13;
            <code class="n">eval_loss</code> <code class="o">=</code> <code class="n">jnp</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">jnp</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">eval_loss</code><code class="p">))</code> <code class="o">/</code> <code class="n">batch_size</code>&#13;
            <code class="n">metrics</code><code class="o">.</code><code class="n">update</code><code class="p">({</code><code class="s2">"eval_loss"</code> <code class="p">:</code> <code class="n">eval_loss</code><code class="p">})</code>&#13;
        <code class="k">if</code> <code class="n">i</code> <code class="o">%</code> <code class="n">_LOG_EVERY_STEPS</code><code class="o">.</code><code class="n">value</code> <code class="o">==</code> <code class="mi">0</code> <code class="ow">and</code> <code class="n">i</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">:</code>&#13;
            <code class="n">mean_loss</code> <code class="o">=</code> <code class="n">jnp</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="n">jnp</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">losses</code><code class="p">))</code>&#13;
            <code class="n">losses</code> <code class="o">=</code> <code class="p">[]</code>&#13;
            <code class="n">metrics</code><code class="o">.</code><code class="n">update</code><code class="p">({</code><code class="s2">"train_loss"</code> <code class="p">:</code> <code class="n">mean_loss</code><code class="p">})</code>&#13;
            <code class="n">wandb</code><code class="o">.</code><code class="n">log</code><code class="p">(</code><code class="n">metrics</code><code class="p">)</code>&#13;
            <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="n">metrics</code><code class="p">)</code>&#13;
&#13;
    <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="s2">"Saving as </code><code class="si">%s</code><code class="s2">"</code><code class="p">,</code> <code class="n">_MODEL_NAME</code><code class="o">.</code><code class="n">value</code><code class="p">)</code>&#13;
    <code class="n">data</code> <code class="o">=</code> <code class="n">flax</code><code class="o">.</code><code class="n">serialization</code><code class="o">.</code><code class="n">to_bytes</code><code class="p">(</code><code class="n">state</code><code class="p">)</code>&#13;
    <code class="n">metadata</code> <code class="o">=</code> <code class="p">{</code> <code class="s2">"output_size"</code> <code class="p">:</code> <code class="n">wandb</code><code class="o">.</code><code class="n">config</code><code class="o">.</code><code class="n">output_size</code> <code class="p">}</code>&#13;
    <code class="n">artifact</code> <code class="o">=</code> <code class="n">wandb</code><code class="o">.</code><code class="n">Artifact</code><code class="p">(</code>&#13;
        <code class="n">name</code><code class="o">=</code><code class="n">_MODEL_NAME</code><code class="o">.</code><code class="n">value</code><code class="p">,</code>&#13;
        <code class="n">metadata</code><code class="o">=</code><code class="n">metadata</code><code class="p">,</code>&#13;
        <code class="nb">type</code><code class="o">=</code><code class="s2">"model"</code><code class="p">)</code>&#13;
    <code class="k">with</code> <code class="n">artifact</code><code class="o">.</code><code class="n">new_file</code><code class="p">(</code><code class="s2">"pinterest_stl.model"</code><code class="p">,</code> <code class="s2">"wb"</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>&#13;
        <code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>&#13;
    <code class="n">run</code><code class="o">.</code><code class="n">log_artifact</code><code class="p">(</code><code class="n">artifact</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">app</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">main</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>A<a data-primary="hyperparameter sweep" data-type="indexterm" id="id516"/> <em>hyperparameter sweep</em> is a tuning service that helps you find optimal values for hyperparameters such as learning rate by running many trials of different values and searches for the best one. Having the configuration as a dictionary allows us to reproduce the best parameters by running a hyperparameter sweep and then saving the best one for the final model.</p>&#13;
&#13;
<p class="less_space pagebreak-before">In <a data-type="xref" href="#wandb_figure">Figure 5-2</a>, you can see what a Weights &amp; Biases hyperparameter sweep looks like. On the left, we have all the runs in the sweep; each run is trying a different set of values that we have specified in the config dictionary. In the middle, we see how the final evaluation loss changes over time with the number of trials on the sweep. On the right, we have a plot indicating the importance of the hyperparameter in affecting the evaluation loss. Here we can see that the learning rate has the most effect on the eval loss, followed by the regularization amount.</p>&#13;
&#13;
<figure><div class="figure" id="wandb_figure">&#13;
<img alt="brpj 0502" src="assets/brpj_0502.png"/>&#13;
<h6><span class="label">Figure 5-2. </span>Weights &amp; Biases hyperparameter sweep</h6>&#13;
</div></figure>&#13;
&#13;
<p>On the bottom right of the figure, a parallel coordinates plot shows how each parameter affects the evaluation loss. To read the plot, follow each line and see where it ends up on the final evaluation loss. The optimal hyperparameters can be found by tracing the line from the bottom-right target value of evaluation loss back to the left, through the values chosen for the hyperparameters. In this case, the optimal value selected is a <code>learning_rate</code> of 0.0001618, a regularization of 0.2076, and an <code>output_size</code> of 64.</p>&#13;
&#13;
<p>The rest of the code is mostly setting up the model and hooking up the input pipeline to the model. Deciding when to log metrics and model serialization is mostly self-explanatory. The details can be read in the Flax documentation.</p>&#13;
&#13;
<p>In saving the model, notice that two methods are used. One is a checkpoint, and the other is Flax serialization. We have both because the checkpoint is used when training jobs are canceled and we need to recover the step at which the job was canceled so we can resume training. The final serialization is used when the training is done.</p>&#13;
&#13;
<p>We also save a copy of the model as a <a href="https://oreil.ly/gmGGt">Weights &amp; Biases artifact</a>. This way, the Weights &amp; Biases platform can keep track of the hyperparameters that created the model, the exact code and the exact Git hash that generated the model, and the lineage of the model. This lineage consists of upstream artifacts used to generate the model (such as the training data), the state of the job used to create the model, and an added back link to all future jobs that might use the artifact. This makes it easier to reproduce models at a point in time or trace back which model was used and at what time in production. This comes in super handy when you have a larger organization and folks are hunting around for information on how a model was created. By using artifacts, they can simply look in one place for the code and training data artifacts to reproduce a model.</p>&#13;
&#13;
<p>Now that we have trained the models, we want to generate embeddings for the scene and the product database. The nice thing about using the dot product as a scoring function as opposed to using a model is that you can generate scene and product embeddings independently and then scale out these computations at inference time. This kind of scaling will be introduced in <a data-type="xref" href="ch08.html#ch:wikipedia-e2e">Chapter 8</a>, but for now the relevant part of <em>make_embeddings.py</em> is shown in <a data-type="xref" href="#example0507">Example 5-7</a>.</p>&#13;
<div data-type="example" id="example0507">&#13;
<h5><span class="label">Example 5-7. </span>Finding the top-<em>k</em> recommendations</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">    <code class="n">model</code> <code class="o">=</code> <code class="n">models</code><code class="o">.</code><code class="n">STLModel</code><code class="p">(</code><code class="n">output_size</code><code class="o">=</code><code class="n">_OUTPUT_SIZE</code><code class="o">.</code><code class="n">value</code><code class="p">)</code>&#13;
    <code class="n">state</code> <code class="o">=</code> <code class="kc">None</code>&#13;
    <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="s2">"Attempting to read model </code><code class="si">%s</code><code class="s2">"</code><code class="p">,</code> <code class="n">_MODEL_NAME</code><code class="o">.</code><code class="n">value</code><code class="p">)</code>&#13;
    <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">_MODEL_NAME</code><code class="o">.</code><code class="n">value</code><code class="p">,</code> <code class="s2">"rb"</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="n">f</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>&#13;
        <code class="n">state</code> <code class="o">=</code> <code class="n">flax</code><code class="o">.</code><code class="n">serialization</code><code class="o">.</code><code class="n">from_bytes</code><code class="p">(</code><code class="n">model</code><code class="p">,</code> <code class="n">data</code><code class="p">)</code>&#13;
    <code class="k">assert</code><code class="p">(</code><code class="n">state</code> <code class="o">!=</code> <code class="kc">None</code><code class="p">)</code>&#13;
&#13;
    <code class="nd">@jax</code><code class="o">.</code><code class="n">jit</code>&#13;
    <code class="k">def</code> <code class="nf">get_scene_embed</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>&#13;
      <code class="k">return</code> <code class="n">model</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">state</code><code class="p">[</code><code class="s2">"params"</code><code class="p">],</code> <code class="n">x</code><code class="p">,</code> <code class="n">method</code><code class="o">=</code><code class="n">models</code><code class="o">.</code><code class="n">STLModel</code><code class="o">.</code><code class="n">get_scene_embed</code><code class="p">)</code>&#13;
    <code class="nd">@jax</code><code class="o">.</code><code class="n">jit</code>&#13;
    <code class="k">def</code> <code class="nf">get_product_embed</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>&#13;
      <code class="k">return</code> <code class="n">model</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code>&#13;
      <code class="n">state</code><code class="p">[</code><code class="s2">"params"</code><code class="p">],</code>&#13;
      <code class="n">x</code><code class="p">,</code>&#13;
      <code class="n">method</code><code class="o">=</code><code class="n">models</code><code class="o">.</code><code class="n">STLModel</code><code class="o">.</code><code class="n">get_product_embed</code>&#13;
      <code class="p">)</code>&#13;
&#13;
    <code class="n">ds</code> <code class="o">=</code> <code class="n">tf</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">Dataset</code>&#13;
      <code class="o">.</code><code class="n">from_tensor_slices</code><code class="p">(</code><code class="n">unique_scenes</code><code class="p">)</code>&#13;
      <code class="o">.</code><code class="n">map</code><code class="p">(</code><code class="n">input_pipeline</code><code class="o">.</code><code class="n">process_image_with_id</code><code class="p">)</code>&#13;
    <code class="n">ds</code> <code class="o">=</code> <code class="n">ds</code><code class="o">.</code><code class="n">batch</code><code class="p">(</code><code class="n">_BATCH_SIZE</code><code class="o">.</code><code class="n">value</code><code class="p">,</code> <code class="n">drop_remainder</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>&#13;
    <code class="n">it</code> <code class="o">=</code> <code class="n">ds</code><code class="o">.</code><code class="n">as_numpy_iterator</code><code class="p">()</code>&#13;
    <code class="n">scene_dict</code> <code class="o">=</code> <code class="p">{}</code>&#13;
    <code class="n">count</code> <code class="o">=</code> <code class="mi">0</code>&#13;
    <code class="k">for</code> <code class="nb">id</code><code class="p">,</code> <code class="n">image</code> <code class="ow">in</code> <code class="n">it</code><code class="p">:</code>&#13;
      <code class="n">count</code> <code class="o">=</code> <code class="n">count</code> <code class="o">+</code> <code class="mi">1</code>&#13;
      <code class="k">if</code> <code class="n">count</code> <code class="o">%</code> <code class="mi">100</code> <code class="o">==</code> <code class="mi">0</code><code class="p">:</code>&#13;
        <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="s2">"Created </code><code class="si">%d</code><code class="s2"> scene embeddings"</code><code class="p">,</code> <code class="n">count</code> <code class="o">*</code> <code class="n">_BATCH_SIZE</code><code class="o">.</code><code class="n">value</code><code class="p">)</code>&#13;
      <code class="n">result</code> <code class="o">=</code> <code class="n">get_scene_embed</code><code class="p">(</code><code class="n">image</code><code class="p">)</code>&#13;
      <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">_BATCH_SIZE</code><code class="o">.</code><code class="n">value</code><code class="p">):</code>&#13;
        <code class="n">current_id</code> <code class="o">=</code> <code class="nb">id</code><code class="p">[</code><code class="n">i</code><code class="p">]</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s2">"utf-8"</code><code class="p">)</code>&#13;
        <code class="n">tmp</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">result</code><code class="p">[</code><code class="n">i</code><code class="p">])</code>&#13;
        <code class="n">current_result</code> <code class="o">=</code> <code class="p">[</code><code class="nb">float</code><code class="p">(</code><code class="n">tmp</code><code class="p">[</code><code class="n">j</code><code class="p">])</code> <code class="k">for</code> <code class="n">j</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">tmp</code><code class="o">.</code><code class="n">shape</code><code class="p">[</code><code class="mi">0</code><code class="p">])]</code>&#13;
        <code class="n">scene_dict</code><code class="o">.</code><code class="n">update</code><code class="p">({</code><code class="n">current_id</code> <code class="p">:</code> <code class="n">current_result</code><code class="p">})</code>&#13;
    <code class="n">scene_filename</code> <code class="o">=</code> <code class="n">os</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">_OUTDIR</code><code class="o">.</code><code class="n">value</code><code class="p">,</code> <code class="s2">"scene_embed.json"</code><code class="p">)</code>&#13;
    <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">scene_filename</code><code class="p">,</code> <code class="s2">"w"</code><code class="p">)</code> <code class="k">as</code> <code class="n">scene_file</code><code class="p">:</code>&#13;
      <code class="n">json</code><code class="o">.</code><code class="n">dump</code><code class="p">(</code><code class="n">scene_dict</code><code class="p">,</code> <code class="n">scene_file</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>As you can see, we simply use the same Flax serialization library to load the model, and then call the appropriate method of the model by using the <code>apply</code> function. We then save the vectors in a JSON file, since we have already been using JSON for the scene and product databases.</p>&#13;
&#13;
<p>Finally, we’ll use the scoring code in <em>make_recommendations.py</em> to generate product recommendations for sample scenes (<a data-type="xref" href="#example0508">Example 5-8</a>).</p>&#13;
<div data-type="example" id="example0508">&#13;
<h5><span class="label">Example 5-8. </span>Core retrieval definition</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">find_top_k</code><code class="p">(</code>&#13;
  <code class="n">scene_embedding</code><code class="p">,</code>&#13;
  <code class="n">product_embeddings</code><code class="p">,</code>&#13;
  <code class="n">k</code><code class="p">):</code>&#13;
  <code class="sd">"""</code>&#13;
<code class="sd">  Finds the top K nearest product embeddings to the scene embedding.</code>&#13;
<code class="sd">  Args:</code>&#13;
<code class="sd">    scene_embedding: embedding vector for the scene</code>&#13;
<code class="sd">    product_embedding: embedding vectors for the products.</code>&#13;
<code class="sd">    k: number of top results to return.</code>&#13;
<code class="sd">  """</code>&#13;
&#13;
  <code class="n">scores</code> <code class="o">=</code> <code class="n">scene_embedding</code> <code class="o">*</code> <code class="n">product_embeddings</code>&#13;
  <code class="n">scores</code> <code class="o">=</code> <code class="n">jnp</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="n">scores</code><code class="p">,</code> <code class="n">axis</code><code class="o">=-</code><code class="mi">1</code><code class="p">)</code>&#13;
  <code class="n">scores_and_indices</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">lax</code><code class="o">.</code><code class="n">top_k</code><code class="p">(</code><code class="n">scores</code><code class="p">,</code> <code class="n">k</code><code class="p">)</code>&#13;
  <code class="k">return</code> <code class="n">scores_and_indices</code>&#13;
&#13;
<code class="n">top_k_finder</code> <code class="o">=</code> <code class="n">jax</code><code class="o">.</code><code class="n">jit</code><code class="p">(</code><code class="n">find_top_k</code><code class="p">,</code> <code class="n">static_argnames</code><code class="o">=</code><code class="p">[</code><code class="s2">"k"</code><code class="p">])</code></pre></div>&#13;
&#13;
<p>The most relevant code fragment is the scoring code, where we have a scene embedding and want to use JAX to score all the product embeddings instead of a single scene embedding. Here we use Lax, a sublibrary of JAX that supplies direct API calls to XLA, the underlying ML compiler for JAX, in order to access accelerated functions like <code>top_k</code>. In addition, we compile the function <code>find_top_k</code> by using JAX’s JIT. You can pass pure Python functions that contain JAX commands to <code>jax.jit</code> in order to compile them to a specific target architecture such as a GPU using XLA. Notice we have a special argument called <code>static_argnames</code>; this allows us to inform JAX that <code>k</code> is fixed and doesn’t change much so that JAX is able to compile a purpose-built <code>top_k_finder</code> for a fixed value of <code>k</code>.</p>&#13;
&#13;
<p><a data-type="xref" href="#recommended_items_indoor">Figure 5-3</a> shows sample product recommendations for a scene in which a woman is wearing a red shirt. The products recommended include red velvet and dark pants.</p>&#13;
&#13;
<figure><div class="figure" id="recommended_items_indoor">&#13;
<img alt="Recommended items for person wearing a red shirt indoors" src="assets/brpj_0503.png"/>&#13;
<h6><span class="label">Figure 5-3. </span>Recommended items for an indoor scene</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-type="xref" href="#recommmended_items_outdoor">Figure 5-4</a> shows another scene: a woman is wearing a red coat outdoors, and the matching accessories are a yellow handbag and yellow pants.</p>&#13;
&#13;
<p>We have pregenerated some results that are stored as an artifact that you can view by typing in the following command:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">wandb<code class="w"> </code>artifact<code class="w"> </code>get<code class="w"> </code>building-recsys/recsys-pinterest/scene_product_results:v0<code class="w"/></pre>&#13;
&#13;
<p>One thing you may notice is that the yellow bag and pants get recommended a lot. It may be possible that the embedding vector for the yellow bag is large, so it gets matched to a lot of scenes. This is called the <em>popular item problem</em> and is a common issue with recommendation systems. We cover some business logic to handle diversity and popularity in later chapters, but this is a problem that can happen with recommendation systems that you might want to keep an eye out for.</p>&#13;
&#13;
<figure><div class="figure" id="recommmended_items_outdoor">&#13;
<img alt="Recommended items for person wearing a red shirt outdoors" src="assets/brpj_0504.png"/>&#13;
<h6><span class="label">Figure 5-4. </span>Recommended items for an outdoor scene</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id49">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>And with that, we conclude the first “Putting It All Together” chapter.&#13;
We covered how to use JAX and Flax to read real-world data, train a model, and find the top recommended items for a look. If you haven’t played with the code yet, hop on over to the GitHub repo to give it a whirl! We hope that providing a real-world working example of an end-to-end content-based recommender will give you a better feel for how the theory translates into practice. Enjoy playing with the code!<a data-primary="" data-startref="CBRinput05" data-type="indexterm" id="id517"/></p>&#13;
</div></section>&#13;
</div></section></body></html>