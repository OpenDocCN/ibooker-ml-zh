<html><head></head><body><section data-pdf-bookmark="Chapter 4. Missing Data" data-type="chapter" epub:type="chapter"><div class="chapter" id="idm46066913332024">&#13;
<h1><span class="label">Chapter 4. </span>Missing Data</h1>&#13;
&#13;
&#13;
<p><a data-primary="missing data" data-type="indexterm" id="ix_ch04-asciidoc0"/>We need to deal with missing data. The previous chapter showed an example. This chapter will dive into it a bit more. Most algorithms will not work if data is missing. Notable exceptions are the recent boosting libraries: XGBoost, CatBoost, and LightGBM.</p>&#13;
&#13;
<p>As with many things in machine learning, there are no hard answers for how to treat missing data. Also, missing data could represent different situations. Imagine census data coming back and an age feature being reported as missing. Is it because the sample didn’t want to reveal their age? They didn’t know their age? The one asking the questions forgot to even ask about age? Is there a pattern to missing ages? Does it correlate to another feature? Is it completely random?</p>&#13;
&#13;
<p>There are also various ways to handle missing data:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Remove any row with missing data</p>&#13;
</li>&#13;
<li>&#13;
<p>Remove any column with missing data</p>&#13;
</li>&#13;
<li>&#13;
<p>Impute missing values</p>&#13;
</li>&#13;
<li>&#13;
<p>Create an indicator column to signify data was missing</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Examining Missing Data" data-type="sect1"><div class="sect1" id="idm46066902755592">&#13;
<h1>Examining Missing Data</h1>&#13;
&#13;
<p><a data-primary="missing data" data-secondary="examining" data-type="indexterm" id="ix_ch04-asciidoc1"/>Let’s go back to the Titanic data. Because Python treats <code>True</code> and <code>False</code> as <code>1</code> and <code>0</code>, respectively, we can use this trick in pandas to get percent of missing data:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">df</code><code class="o">.</code><code class="n">isnull</code><code class="p">()</code><code class="o">.</code><code class="n">mean</code><code class="p">()</code> <code class="o">*</code> <code class="mi">100</code>&#13;
<code class="go">pclass        0.000000</code>&#13;
<code class="go">survived      0.000000</code>&#13;
<code class="go">name          0.000000</code>&#13;
<code class="go">sex           0.000000</code>&#13;
<code class="go">age          20.091673</code>&#13;
<code class="go">sibsp         0.000000</code>&#13;
<code class="go">parch         0.000000</code>&#13;
<code class="go">ticket        0.000000</code>&#13;
<code class="go">fare          0.076394</code>&#13;
<code class="go">cabin        77.463713</code>&#13;
<code class="go">embarked      0.152788</code>&#13;
<code class="go">boat         62.872422</code>&#13;
<code class="go">body         90.756303</code>&#13;
<code class="go">home.dest    43.086325</code>&#13;
<code class="go">dtype: float64</code></pre>&#13;
&#13;
<p class="pagebreak-before"><a data-primary="missingno" data-secondary="for visualizing patterns in missing data" data-type="indexterm" id="idm46066902749176"/>To visualize patterns in the missing data, use the <a href="https://oreil.ly/rgYJG">missingno library</a>. This library is useful for viewing contiguous areas of missing data, which would indicate that the missing data is not random (see <a data-type="xref" href="#id2">Figure 4-1</a>). The <code>matrix</code> function includes a sparkline along the right side. Patterns here would also indicate nonrandom missing data. You may need to limit the number of samples to be able to see the patterns:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">missingno</code> <code class="kn">as</code> <code class="nn">msno</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ax</code> <code class="o">=</code> <code class="n">msno</code><code class="o">.</code><code class="n">matrix</code><code class="p">(</code><code class="n">orig_df</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="mi">500</code><code class="p">))</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ax</code><code class="o">.</code><code class="n">get_figure</code><code class="p">()</code><code class="o">.</code><code class="n">savefig</code><code class="p">(</code><code class="s">"images/mlpr_0401.png"</code><code class="p">)</code></pre>&#13;
&#13;
<figure><div class="figure" id="id2">&#13;
<img alt="Where data is missing. No clear patterns jump out to the author." src="assets/mlpr_0401.png"/>&#13;
<h6><span class="label">Figure 4-1. </span>Where data is missing. No clear patterns jump out to the author.</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before"><a data-primary="pandas" data-secondary="for missing data bar plot" data-type="indexterm" id="idm46066902579544"/>We can create a bar plot of missing data counts using pandas (see <a data-type="xref" href="#id3">Figure 4-2</a>):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">fig</code><code class="p">,</code> <code class="n">ax</code> <code class="o">=</code> <code class="n">plt</code><code class="o">.</code><code class="n">subplots</code><code class="p">(</code><code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">6</code><code class="p">,</code> <code class="mi">4</code><code class="p">))</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="p">(</code><code class="mi">1</code> <code class="o">-</code> <code class="n">df</code><code class="o">.</code><code class="n">isnull</code><code class="p">()</code><code class="o">.</code><code class="n">mean</code><code class="p">())</code><code class="o">.</code><code class="n">abs</code><code class="p">()</code><code class="o">.</code><code class="n">plot</code><code class="o">.</code><code class="n">bar</code><code class="p">(</code><code class="n">ax</code><code class="o">=</code><code class="n">ax</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">fig</code><code class="o">.</code><code class="n">savefig</code><code class="p">(</code><code class="s">"images/mlpr_0402.png"</code><code class="p">,</code> <code class="n">dpi</code><code class="o">=</code><code class="mi">300</code><code class="p">)</code></pre>&#13;
&#13;
<figure><div class="figure" id="id3">&#13;
<img alt="Percents of nonmissing data with pandas. Boat and body are leaky so we should ignore those. Interesting that some ages are missing." src="assets/mlpr_0402.png"/>&#13;
<h6><span class="label">Figure 4-2. </span>Percents of nonmissing data with pandas. Boat and body are leaky so we should ignore those. Interesting that some ages are missing.</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before"><a data-primary="missingno" data-secondary="for missing data bar plot" data-type="indexterm" id="ix_ch04-asciidoc2"/>Or use the missingno library to create the same plot (see <a data-type="xref" href="#id4">Figure 4-3</a>):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ax</code> <code class="o">=</code> <code class="n">msno</code><code class="o">.</code><code class="n">bar</code><code class="p">(</code><code class="n">orig_df</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="mi">500</code><code class="p">))</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ax</code><code class="o">.</code><code class="n">get_figure</code><code class="p">()</code><code class="o">.</code><code class="n">savefig</code><code class="p">(</code><code class="s">"images/mlpr_0403.png"</code><code class="p">)</code></pre>&#13;
&#13;
<figure><div class="figure" id="id4">&#13;
<img alt="Percents of nonmissing data with missingno." src="assets/mlpr_0403.png"/>&#13;
<h6><span class="label">Figure 4-3. </span>Percents of nonmissing data with missingno.</h6>&#13;
</div></figure>&#13;
&#13;
<p>We can create a heat map showing if there are correlations where data is&#13;
missing (see <a data-type="xref" href="#id5">Figure 4-4</a>). In this case, it doesn’t look like the locations where data are missing are correlated:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ax</code> <code class="o">=</code> <code class="n">msno</code><code class="o">.</code><code class="n">heatmap</code><code class="p">(</code><code class="n">df</code><code class="p">,</code> <code class="n">figsize</code><code class="o">=</code><code class="p">(</code><code class="mi">6</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ax</code><code class="o">.</code><code class="n">get_figure</code><code class="p">()</code><code class="o">.</code><code class="n">savefig</code><code class="p">(</code><code class="s">"/tmp/mlpr_0404.png"</code><code class="p">)</code></pre>&#13;
&#13;
<figure><div class="figure" id="id5">&#13;
<img alt="Correlations of missing data with missingno." src="assets/mlpr_0404.png"/>&#13;
<h6><span class="label">Figure 4-4. </span>Correlations of missing data with missingno.</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-primary="dendrograms" data-type="indexterm" id="idm46066902391912"/>We can create a dendrogram showing the clusterings of where data is&#13;
missing (see <a data-type="xref" href="#id6">Figure 4-5</a>). Leaves that are at the same level predict one another’s presence&#13;
(empty or filled). The vertical arms are used to indicate how different clusters are. Short arms mean that branches are similar<a data-startref="ix_ch04-asciidoc2" data-type="indexterm" id="idm46066902390040"/>:<a data-startref="ix_ch04-asciidoc1" data-type="indexterm" id="idm46066902389240"/></p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ax</code> <code class="o">=</code> <code class="n">msno</code><code class="o">.</code><code class="n">dendrogram</code><code class="p">(</code><code class="n">df</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ax</code><code class="o">.</code><code class="n">get_figure</code><code class="p">()</code><code class="o">.</code><code class="n">savefig</code><code class="p">(</code><code class="s">"images/mlpr_0405.png"</code><code class="p">)</code></pre>&#13;
&#13;
<figure><div class="figure" id="id6">&#13;
<img alt="Dendrogram of missing data with missingno. We can see the columns without missing data on the upper right." src="assets/mlpr_0405.png"/>&#13;
<h6><span class="label">Figure 4-5. </span>Dendrogram of missing data with missingno. We can see the columns without missing data on the upper right.</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Dropping Missing Data" data-type="sect1"><div class="sect1" id="idm46066902754968">&#13;
<h1>Dropping Missing Data</h1>&#13;
&#13;
<p><a data-primary="missing data" data-secondary="dropping rows with" data-type="indexterm" id="idm46066902337192"/><a data-primary="pandas" data-secondary="dropping rows with missing data" data-type="indexterm" id="idm46066902336216"/>The pandas library can drop all rows with missing data with the <code>.dropna</code> method:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">df1</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">dropna</code><code class="p">()</code></pre>&#13;
&#13;
<p>To drop columns, we can note what columns are missing and use the <code>.drop</code> method. We can pass in a list of column names or a single column name:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">df1</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">drop</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="s">"cabin"</code><code class="p">)</code></pre>&#13;
&#13;
<p>Alternatively, we can use the <code>.dropna</code> method and set <code>axis=1</code> (drop along the column axis):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">df1</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">dropna</code><code class="p">(</code><code class="n">axis</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code></pre>&#13;
&#13;
<p>Be careful about dropping data. I typically view this as a last resort option.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Imputing Data" data-type="sect1"><div class="sect1" id="idm46066902256600">&#13;
<h1>Imputing Data</h1>&#13;
&#13;
<p><a data-primary="imputing data" data-type="indexterm" id="idm46066902255448"/><a data-primary="missing data" data-secondary="imputing" data-type="indexterm" id="idm46066902254856"/>Once you have a tool for predicting data, you can use that to predict missing data. The general task of defining values for missing values is called <em>imputation</em>.</p>&#13;
&#13;
<p><a data-primary="pipelines" data-secondary="imputing data with" data-type="indexterm" id="idm46066902327560"/>If you are imputing data, you will need to build up a pipeline and use the same imputation logic during model creation and prediction time. The <code>SimpleImputer</code> class in scikit-learn will handle mean, median, and most frequent feature values.</p>&#13;
&#13;
<p>The default behavior is to calculate the mean:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">sklearn.impute</code> <code class="kn">import</code> <code class="n">SimpleImputer</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">num_cols</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">select_dtypes</code><code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="n">include</code><code class="o">=</code><code class="s">"number"</code>&#13;
<code class="gp">... </code><code class="p">)</code><code class="o">.</code><code class="n">columns</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">im</code> <code class="o">=</code> <code class="n">SimpleImputer</code><code class="p">()</code>  <code class="c"># mean</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">imputed</code> <code class="o">=</code> <code class="n">im</code><code class="o">.</code><code class="n">fit_transform</code><code class="p">(</code><code class="n">df</code><code class="p">[</code><code class="n">num_cols</code><code class="p">])</code></pre>&#13;
&#13;
<p>Provide <code>strategy='median'</code> or <code>strategy='most_frequent'</code> to change the replaced value to median or most common, respectively. If you wish to fill with a constant value, say <code>-1</code>, use  <span class="keep-together"><code>strategy</code></span><code>='constant'</code> in combination with <code>fill_value=-1</code>.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p><a data-primary="pandas" data-secondary="imputing missing values with" data-type="indexterm" id="idm46066902170360"/>You can use the <code>.fillna</code> method in pandas to impute missing values as well. Make sure that you do not leak data though. If you are filling in with the mean value, make sure you use the same mean value during model creation and model prediction time.</p>&#13;
</div>&#13;
&#13;
<p>The most frequent and constant strategies may be used with numeric or string data. The mean and median require numeric data.</p>&#13;
&#13;
<p><a data-primary="fancyimpute" data-type="indexterm" id="idm46066902167656"/>The fancyimpute library implements many algorithms and follows the scikit-learn interface. <a data-primary="transductive algorithms" data-type="indexterm" id="idm46066902166488"/>Sadly, most of the algorithms are <em>transductive</em>, meaning that you can’t call the <code>.transform</code> method by itself after fitting the algorithm. The <code>IterativeImputer</code> is <em>inductive</em> (has since been migrated from fancyimpute to scikit-learn) and supports transforming after fitting.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Adding Indicator Columns" data-type="sect1"><div class="sect1" id="idm46066902163912">&#13;
<h1>Adding Indicator Columns</h1>&#13;
&#13;
<p><a data-primary="missing data" data-secondary="indicator columns for" data-type="indexterm" id="idm46066902162744"/><a data-primary="pandas" data-secondary="for indicator columns" data-type="indexterm" id="idm46066902161768"/>The lack of data in and of itself may provide some signal to a model. The pandas library can add a new column to indicate that a value was missing:<a data-startref="ix_ch04-asciidoc0" data-type="indexterm" id="idm46066902160536"/></p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="k">def</code> <code class="nf">add_indicator</code><code class="p">(</code><code class="n">col</code><code class="p">):</code>&#13;
<code class="gp">... </code>    <code class="k">def</code> <code class="nf">wrapper</code><code class="p">(</code><code class="n">df</code><code class="p">):</code>&#13;
<code class="gp">... </code>        <code class="k">return</code> <code class="n">df</code><code class="p">[</code><code class="n">col</code><code class="p">]</code><code class="o">.</code><code class="n">isna</code><code class="p">()</code><code class="o">.</code><code class="n">astype</code><code class="p">(</code><code class="nb">int</code><code class="p">)</code>&#13;
<code class="gp">...</code>&#13;
<code class="gp">... </code>    <code class="k">return</code> <code class="n">wrapper</code>&#13;
&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">df1</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">assign</code><code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="n">cabin_missing</code><code class="o">=</code><code class="n">add_indicator</code><code class="p">(</code><code class="s">"cabin"</code><code class="p">)</code>&#13;
<code class="gp">... </code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>