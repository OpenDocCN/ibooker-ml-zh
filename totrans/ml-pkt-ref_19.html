<html><head></head><body><section data-pdf-bookmark="Chapter 19. Pipelines" data-type="chapter" epub:type="chapter"><div class="chapter" id="idm46066880655224">&#13;
<h1><span class="label">Chapter 19. </span>Pipelines</h1>&#13;
&#13;
&#13;
<p><a data-primary="pipelines" data-type="indexterm" id="ix_ch19-asciidoc0"/><a data-primary="scikit-learn" data-secondary="pipelines" data-type="indexterm" id="ix_ch19-asciidoc1"/>Scikit-learn uses the notion of a pipeline. Using the <code>Pipeline</code> class, you can chain together transformers and models, and treat the whole process like a scikit-learn model. You can even insert custom logic.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Classification Pipeline" data-type="sect1"><div class="sect1" id="idm46066879911928">&#13;
<h1>Classification Pipeline</h1>&#13;
&#13;
<p><a data-primary="classification" data-secondary="pipelines for" data-type="indexterm" id="ix_ch19-asciidoc2"/><a data-primary="pipelines" data-secondary="classification" data-type="indexterm" id="ix_ch19-asciidoc3"/>Here is an example using the <code>tweak_titanic</code> function inside of a pipeline:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">sklearn.base</code> <code class="kn">import</code> <code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="n">BaseEstimator</code><code class="p">,</code>&#13;
<code class="gp">... </code>    <code class="n">TransformerMixin</code><code class="p">,</code>&#13;
<code class="gp">... </code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">sklearn.pipeline</code> <code class="kn">import</code> <code class="n">Pipeline</code>&#13;
&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">def</code> <code class="nf">tweak_titanic</code><code class="p">(</code><code class="n">df</code><code class="p">):</code>&#13;
<code class="gp">... </code>    <code class="n">df</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">drop</code><code class="p">(</code>&#13;
<code class="gp">... </code>        <code class="n">columns</code><code class="o">=</code><code class="p">[</code>&#13;
<code class="gp">... </code>            <code class="s">"name"</code><code class="p">,</code>&#13;
<code class="gp">... </code>            <code class="s">"ticket"</code><code class="p">,</code>&#13;
<code class="gp">... </code>            <code class="s">"home.dest"</code><code class="p">,</code>&#13;
<code class="gp">... </code>            <code class="s">"boat"</code><code class="p">,</code>&#13;
<code class="gp">... </code>            <code class="s">"body"</code><code class="p">,</code>&#13;
<code class="gp">... </code>            <code class="s">"cabin"</code><code class="p">,</code>&#13;
<code class="gp">... </code>        <code class="p">]</code>&#13;
<code class="gp">... </code>    <code class="p">)</code><code class="o">.</code><code class="n">pipe</code><code class="p">(</code><code class="n">pd</code><code class="o">.</code><code class="n">get_dummies</code><code class="p">,</code> <code class="n">drop_first</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
<code class="gp">... </code>    <code class="k">return</code> <code class="n">df</code>&#13;
&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">class</code> <code class="nc">TitanicTransformer</code><code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="n">BaseEstimator</code><code class="p">,</code> <code class="n">TransformerMixin</code>&#13;
<code class="gp">... </code><code class="p">):</code>&#13;
<code class="gp">... </code>    <code class="k">def</code> <code class="nf">transform</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">X</code><code class="p">):</code>&#13;
<code class="gp">... </code>        <code class="c"># assumes X is output</code>&#13;
<code class="gp">... </code>        <code class="c"># from reading Excel file</code>&#13;
<code class="gp">... </code>        <code class="n">X</code> <code class="o">=</code> <code class="n">tweak_titanic</code><code class="p">(</code><code class="n">X</code><code class="p">)</code>&#13;
<code class="gp">... </code>        <code class="n">X</code> <code class="o">=</code> <code class="n">X</code><code class="o">.</code><code class="n">drop</code><code class="p">(</code><code class="n">column</code><code class="o">=</code><code class="s">"survived"</code><code class="p">)</code>&#13;
<code class="gp">... </code>        <code class="k">return</code> <code class="n">X</code>&#13;
<code class="gp">...</code>&#13;
<code class="gp">... </code>    <code class="k">def</code> <code class="nf">fit</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">X</code><code class="p">,</code> <code class="n">y</code><code class="p">):</code>&#13;
<code class="gp">... </code>        <code class="k">return</code> <code class="bp">self</code>&#13;
&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">pipe</code> <code class="o">=</code> <code class="n">Pipeline</code><code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="p">[</code>&#13;
<code class="gp">... </code>        <code class="p">(</code><code class="s">"titan"</code><code class="p">,</code> <code class="n">TitanicTransformer</code><code class="p">()),</code>&#13;
<code class="gp">... </code>        <code class="p">(</code><code class="s">"impute"</code><code class="p">,</code> <code class="n">impute</code><code class="o">.</code><code class="n">IterativeImputer</code><code class="p">()),</code>&#13;
<code class="gp">... </code>        <code class="p">(</code>&#13;
<code class="gp">... </code>            <code class="s">"std"</code><code class="p">,</code>&#13;
<code class="gp">... </code>            <code class="n">preprocessing</code><code class="o">.</code><code class="n">StandardScaler</code><code class="p">(),</code>&#13;
<code class="gp">... </code>        <code class="p">),</code>&#13;
<code class="gp">... </code>        <code class="p">(</code><code class="s">"rf"</code><code class="p">,</code> <code class="n">RandomForestClassifier</code><code class="p">()),</code>&#13;
<code class="gp">... </code>    <code class="p">]</code>&#13;
<code class="gp">... </code><code class="p">)</code></pre>&#13;
&#13;
<p>With a pipeline in hand, we can call <code>.fit</code> and <code>.score</code> on it:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">sklearn.model_selection</code> <code class="kn">import</code> <code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="n">train_test_split</code><code class="p">,</code>&#13;
<code class="gp">... </code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">X_train2</code><code class="p">,</code> <code class="n">X_test2</code><code class="p">,</code> <code class="n">y_train2</code><code class="p">,</code> <code class="n">y_test2</code> <code class="o">=</code> <code class="n">train_test_split</code><code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="n">orig_df</code><code class="p">,</code>&#13;
<code class="gp">... </code>    <code class="n">orig_df</code><code class="o">.</code><code class="n">survived</code><code class="p">,</code>&#13;
<code class="gp">... </code>    <code class="n">test_size</code><code class="o">=</code><code class="mf">0.3</code><code class="p">,</code>&#13;
<code class="gp">... </code>    <code class="n">random_state</code><code class="o">=</code><code class="mi">42</code><code class="p">,</code>&#13;
<code class="gp">... </code><code class="p">)</code>&#13;
&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">pipe</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">X_train2</code><code class="p">,</code> <code class="n">y_train2</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">pipe</code><code class="o">.</code><code class="n">score</code><code class="p">(</code><code class="n">X_test2</code><code class="p">,</code> <code class="n">y_test2</code><code class="p">)</code>&#13;
<code class="go">0.7913486005089059</code></pre>&#13;
&#13;
<p><a data-primary="grid search" data-type="indexterm" id="idm46066879681048"/>Pipelines can be used in grid search. Our <code>param_grid</code> needs to have the parameters prefixed by the name of the pipe stage, followed by two underscores. In the example below, we add some parameters for the random forest stage:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">params</code> <code class="o">=</code> <code class="p">{</code>&#13;
<code class="gp">... </code>    <code class="s">"rf__max_features"</code><code class="p">:</code> <code class="p">[</code><code class="mf">0.4</code><code class="p">,</code> <code class="s">"auto"</code><code class="p">],</code>&#13;
<code class="gp">... </code>    <code class="s">"rf__n_estimators"</code><code class="p">:</code> <code class="p">[</code><code class="mi">15</code><code class="p">,</code> <code class="mi">200</code><code class="p">],</code>&#13;
<code class="gp">... </code><code class="p">}</code>&#13;
&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">grid</code> <code class="o">=</code> <code class="n">model_selection</code><code class="o">.</code><code class="n">GridSearchCV</code><code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="n">pipe</code><code class="p">,</code> <code class="n">cv</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code> <code class="n">param_grid</code><code class="o">=</code><code class="n">params</code>&#13;
<code class="gp">... </code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">grid</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">orig_df</code><code class="p">,</code> <code class="n">orig_df</code><code class="o">.</code><code class="n">survived</code><code class="p">)</code></pre>&#13;
&#13;
<p>Now we can pull out the best parameters and train the final model. (In this case the random forest doesnâ€™t improve after grid search.)</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">grid</code><code class="o">.</code><code class="n">best_params_</code>&#13;
<code class="go">{'rf__max_features': 0.4, 'rf__n_estimators': 15}</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">pipe</code><code class="o">.</code><code class="n">set_params</code><code class="p">(</code><code class="o">**</code><code class="n">grid</code><code class="o">.</code><code class="n">best_params_</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">pipe</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">X_train2</code><code class="p">,</code> <code class="n">y_train2</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">pipe</code><code class="o">.</code><code class="n">score</code><code class="p">(</code><code class="n">X_test2</code><code class="p">,</code> <code class="n">y_test2</code><code class="p">)</code>&#13;
<code class="go">0.7913486005089059</code></pre>&#13;
&#13;
<p>We can use the pipeline where we use scikit-learn models:<a data-startref="ix_ch19-asciidoc3" data-type="indexterm" id="idm46066879449816"/><a data-startref="ix_ch19-asciidoc2" data-type="indexterm" id="idm46066879468280"/></p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">metrics</code><code class="o">.</code><code class="n">roc_auc_score</code><code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="n">y_test2</code><code class="p">,</code> <code class="n">pipe</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">X_test2</code><code class="p">)</code>&#13;
<code class="gp">... </code><code class="p">)</code>&#13;
<code class="go">0.7813688715131023</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Regression Pipeline" data-type="sect1"><div class="sect1" id="idm46066879399624">&#13;
<h1>Regression Pipeline</h1>&#13;
&#13;
<p><a data-primary="pipelines" data-secondary="regression" data-type="indexterm" id="idm46066879406152"/><a data-primary="regression" data-secondary="pipelines for" data-type="indexterm" id="idm46066879405208"/>Here is an example of a pipeline that performs linear regression on the Boston dataset:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">sklearn.pipeline</code> <code class="kn">import</code> <code class="n">Pipeline</code>&#13;
&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">reg_pipe</code> <code class="o">=</code> <code class="n">Pipeline</code><code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="p">[</code>&#13;
<code class="gp">... </code>        <code class="p">(</code>&#13;
<code class="gp">... </code>            <code class="s">"std"</code><code class="p">,</code>&#13;
<code class="gp">... </code>            <code class="n">preprocessing</code><code class="o">.</code><code class="n">StandardScaler</code><code class="p">(),</code>&#13;
<code class="gp">... </code>        <code class="p">),</code>&#13;
<code class="gp">... </code>        <code class="p">(</code><code class="s">"lr"</code><code class="p">,</code> <code class="n">LinearRegression</code><code class="p">()),</code>&#13;
<code class="gp">... </code>    <code class="p">]</code>&#13;
<code class="gp">... </code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">reg_pipe</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">bos_X_train</code><code class="p">,</code> <code class="n">bos_y_train</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">reg_pipe</code><code class="o">.</code><code class="n">score</code><code class="p">(</code><code class="n">bos_X_test</code><code class="p">,</code> <code class="n">bos_y_test</code><code class="p">)</code>&#13;
<code class="go">0.7112260057484934</code></pre>&#13;
&#13;
<p>If we want to pull parts out of the pipeline to examine their properties, we can do that with the <code>.named_steps</code> attribute:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">reg_pipe</code><code class="o">.</code><code class="n">named_steps</code><code class="p">[</code><code class="s">"lr"</code><code class="p">]</code><code class="o">.</code><code class="n">intercept_</code>&#13;
<code class="go">23.01581920903956</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">reg_pipe</code><code class="o">.</code><code class="n">named_steps</code><code class="p">[</code><code class="s">"lr"</code><code class="p">]</code><code class="o">.</code><code class="n">coef_</code>&#13;
<code class="go">array([-1.10834602,  0.80843998,  0.34313466,</code>&#13;
<code class="go">        0.81386426, -1.79804295,  2.913858  ,</code>&#13;
<code class="go">        -0.29893918, -2.94251148,  2.09419303,</code>&#13;
<code class="go">        -1.44706731, -2.05232232,  1.02375187,</code>&#13;
<code class="go">        -3.88579002])_</code></pre>&#13;
&#13;
<p>We can use the pipeline in metric calculations as well:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">sklearn</code> <code class="kn">import</code> <code class="n">metrics</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">metrics</code><code class="o">.</code><code class="n">mean_squared_error</code><code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="n">bos_y_test</code><code class="p">,</code> <code class="n">reg_pipe</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">bos_X_test</code><code class="p">)</code>&#13;
<code class="gp">... </code><code class="p">)</code>&#13;
<code class="go">21.517444231177205</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="PCA Pipeline" data-type="sect1"><div class="sect1" id="idm46066879246296">&#13;
<h1>PCA Pipeline</h1>&#13;
&#13;
<p><a data-primary="pipelines" data-secondary="PCA" data-type="indexterm" id="idm46066879179528"/><a data-primary="principal component analysis (PCA)" data-secondary="pipelines for" data-type="indexterm" id="idm46066879178552"/>Scikit-learn pipelines can also be used for PCA.</p>&#13;
&#13;
<p>Here we standardize the Titanic dataset and perform PCA on it:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">pca_pipe</code> <code class="o">=</code> <code class="n">Pipeline</code><code class="p">(</code>&#13;
<code class="gp">... </code>    <code class="p">[</code>&#13;
<code class="gp">... </code>        <code class="p">(</code>&#13;
<code class="gp">... </code>            <code class="s">"std"</code><code class="p">,</code>&#13;
<code class="gp">... </code>            <code class="n">preprocessing</code><code class="o">.</code><code class="n">StandardScaler</code><code class="p">(),</code>&#13;
<code class="gp">... </code>        <code class="p">),</code>&#13;
<code class="gp">... </code>        <code class="p">(</code><code class="s">"pca"</code><code class="p">,</code> <code class="n">PCA</code><code class="p">()),</code>&#13;
<code class="gp">... </code>    <code class="p">]</code>&#13;
<code class="gp">... </code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">X_pca</code> <code class="o">=</code> <code class="n">pca_pipe</code><code class="o">.</code><code class="n">fit_transform</code><code class="p">(</code><code class="n">X</code><code class="p">)</code></pre>&#13;
&#13;
<p>Using the <code>.named_steps</code> attribute, we can pull properties off of the&#13;
PCA portion of the pipeline:<a data-startref="ix_ch19-asciidoc1" data-type="indexterm" id="idm46066879117112"/><a data-startref="ix_ch19-asciidoc0" data-type="indexterm" id="idm46066879116504"/></p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">pca_pipe</code><code class="o">.</code><code class="n">named_steps</code><code class="p">[</code>&#13;
<code class="gp">... </code>    <code class="s">"pca"</code>&#13;
<code class="gp">... </code><code class="p">]</code><code class="o">.</code><code class="n">explained_variance_ratio_</code>&#13;
<code class="go">array([0.23917891, 0.21623078, 0.19265028,</code>&#13;
<code class="go">       0.10460882, 0.08170342, 0.07229959,</code>&#13;
<code class="go">       0.05133752, 0.04199068])</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">pca_pipe</code><code class="o">.</code><code class="n">named_steps</code><code class="p">[</code><code class="s">"pca"</code><code class="p">]</code><code class="o">.</code><code class="n">components_</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>&#13;
<code class="go">array([-0.63368693,  0.39682566,  0.00614498,</code>&#13;
<code class="go">        0.11488415,  0.58075352, -0.19046812,</code>&#13;
<code class="go">        -0.21190808, -0.09631388])</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>