<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 23. Saving, Loading, and Serving &#10;Trained Models" data-type="chapter" epub:type="chapter"><div class="chapter" id="saving-loading-and-serving-trained-models">
<h1><span class="label">Chapter 23. </span>Saving, Loading, and Serving 
<span class="keep-together">Trained Models</span></h1>
<section data-pdf-bookmark="23.0 Introduction" data-type="sect1"><div class="sect1" id="id863">
<h1>23.0 Introduction</h1>
<p>In the last 22 chapters and around 200 recipes, we have covered how to
take raw data and use machine learning to create well-performing
predictive models. However, for all our work to be worthwhile, we
eventually need to <em>do something</em> with our model, such as integrate it with an existing software application. To accomplish this goal, we need to be able to save our models after training, load them when they are needed by an application, and then make requests to that application to get predictions.</p>
<p>ML models are typically deployed in simple web servers and designed to take input data and return predictions. This makes the model available to any client on the same network, so other services (such as UIs, users, etc.) can use the ML model to make predictions wherever they are in real time. An example use case would be using ML for item search on an ecommerce website, where an ML model would be served that takes in data about users and listings, and returns a likelihood of the user purchasing that listing. The search results need to be available in real time and available to the ecommerce application that is responsible for taking user searches and coordinating results for the user.</p>
</div></section>
<section data-pdf-bookmark="23.1 Saving and Loading a scikit-learn Model" data-type="sect1"><div class="sect1" id="saving-and-loading-a-scikit-learn-model">
<h1>23.1 Saving and Loading a scikit-learn Model</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id440">
<h2>Problem</h2>
<p>You have a <a data-primary="saving and loading models" data-type="indexterm" id="ix_save_load_mod2"/><a data-primary="loading and saving models" data-type="indexterm" id="ix_load_save_mod2"/><a data-primary="scikit-learn library" data-secondary="saving and loading a model" data-type="indexterm" id="ix_scikit_save_load"/>trained scikit-learn model and want to save it and load it
elsewhere.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id441">
<h2>Solution</h2>
<p>Save the <a data-primary="pickle file" data-type="indexterm" id="ix_pickle_file"/>model as a pickle file:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Load libraries</code>
<code class="kn">import</code> <code class="nn">joblib</code>
<code class="kn">from</code> <code class="nn">sklearn.ensemble</code> <code class="kn">import</code> <code class="n">RandomForestClassifier</code>
<code class="kn">from</code> <code class="nn">sklearn</code> <code class="kn">import</code> <code class="n">datasets</code>

<code class="c1"># Load data</code>
<code class="n">iris</code> <code class="o">=</code> <code class="n">datasets</code><code class="o">.</code><code class="n">load_iris</code><code class="p">()</code>
<code class="n">features</code> <code class="o">=</code> <code class="n">iris</code><code class="o">.</code><code class="n">data</code>
<code class="n">target</code> <code class="o">=</code> <code class="n">iris</code><code class="o">.</code><code class="n">target</code>

<code class="c1"># Create decision tree classifer object</code>
<code class="n">classifer</code> <code class="o">=</code> <code class="n">RandomForestClassifier</code><code class="p">()</code>

<code class="c1"># Train model</code>
<code class="n">model</code> <code class="o">=</code> <code class="n">classifer</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">features</code><code class="p">,</code> <code class="n">target</code><code class="p">)</code>

<code class="c1"># Save model as pickle file</code>
<code class="n">joblib</code><code class="o">.</code><code class="n">dump</code><code class="p">(</code><code class="n">model</code><code class="p">,</code> <code class="s2">"model.pkl"</code><code class="p">)</code></pre>
<pre data-type="programlisting">['model.pkl']</pre>
<p>Once the model is saved, we can use scikit-learn in our destination
application (e.g., web application) to load the model:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Load model from file</code>
<code class="n">classifer</code> <code class="o">=</code> <code class="n">joblib</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="s2">"model.pkl"</code><code class="p">)</code></pre>
<p>And use it to make predictions:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Create new observation</code>
<code class="n">new_observation</code> <code class="o">=</code> <code class="p">[[</code> <code class="mf">5.2</code><code class="p">,</code>  <code class="mf">3.2</code><code class="p">,</code>  <code class="mf">1.1</code><code class="p">,</code>  <code class="mf">0.1</code><code class="p">]]</code>

<code class="c1"># Predict observation's class</code>
<code class="n">classifer</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">new_observation</code><code class="p">)</code></pre>
<pre data-type="programlisting">array([0])</pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id442">
<h2>Discussion</h2>
<p>The first step in using a <a data-primary="joblib library" data-type="indexterm" id="id2092"/>model in production is to save that model as a
file that can be loaded by another application or workflow. We can
accomplish this by saving the model as a pickle file, a Python-specific data format that enables us to serialize Python objects and write them out to files. Specifically, to save the model we use <code>joblib</code>, which is a library extending pickle for cases when we have large NumPy arrays—​a common occurrence for trained models in scikit-learn.</p>
<p>When saving scikit-learn models, be aware that saved models might not be compatible between versions of scikit-learn; therefore, it can
be helpful to include the version of scikit-learn used in the model in
the filename:<a data-primary="" data-startref="ix_pickle_file" data-type="indexterm" id="id2093"/><a data-primary="" data-startref="ix_scikit_save_load" data-type="indexterm" id="id2094"/></p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Import library</code>
<code class="kn">import</code> <code class="nn">sklearn</code>

<code class="c1"># Get scikit-learn version</code>
<code class="n">scikit_version</code> <code class="o">=</code> <code class="n">sklearn</code><code class="o">.</code><code class="n">__version__</code>

<code class="c1"># Save model as pickle file</code>
<code class="n">joblib</code><code class="o">.</code><code class="n">dump</code><code class="p">(</code><code class="n">model</code><code class="p">,</code> <code class="s2">"model_</code><code class="si">{version}</code><code class="s2">.pkl"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">version</code><code class="o">=</code><code class="n">scikit_version</code><code class="p">))</code></pre>
<pre data-type="programlisting">['model_1.2.0.pkl']</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="23.2 Saving and Loading a TensorFlow Model" data-type="sect1"><div class="sect1" id="saving-and-loading-a-tensorflow-model">
<h1>23.2 Saving and Loading a TensorFlow Model</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id443">
<h2>Problem</h2>
<p>You have a trained <a data-primary="TensorFlow" data-type="indexterm" id="id2095"/>TensorFlow model and want to save it and load it
elsewhere.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id444">
<h2>Solution</h2>
<p>Save the <a data-primary="saved_model format, TensorFlow" data-type="indexterm" id="id2096"/>model using the TensorFlow <code>saved_model</code> format:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Load libraries</code>
<code class="kn">import</code> <code class="nn">numpy</code> <code class="k">as</code> <code class="nn">np</code>
<code class="kn">from</code> <code class="nn">tensorflow</code> <code class="kn">import</code> <code class="n">keras</code>

<code class="c1"># Set random seed</code>
<code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>

<code class="c1"># Create model with one hidden layer</code>
<code class="n">input_layer</code> <code class="o">=</code> <code class="n">keras</code><code class="o">.</code><code class="n">Input</code><code class="p">(</code><code class="n">shape</code><code class="o">=</code><code class="p">(</code><code class="mi">10</code><code class="p">,))</code>
<code class="n">hidden_layer</code> <code class="o">=</code> <code class="n">keras</code><code class="o">.</code><code class="n">layers</code><code class="o">.</code><code class="n">Dense</code><code class="p">(</code><code class="mi">10</code><code class="p">)(</code><code class="n">input_layer</code><code class="p">)</code>
<code class="n">output_layer</code> <code class="o">=</code> <code class="n">keras</code><code class="o">.</code><code class="n">layers</code><code class="o">.</code><code class="n">Dense</code><code class="p">(</code><code class="mi">1</code><code class="p">)(</code><code class="n">input_layer</code><code class="p">)</code>
<code class="n">model</code> <code class="o">=</code> <code class="n">keras</code><code class="o">.</code><code class="n">Model</code><code class="p">(</code><code class="n">input_layer</code><code class="p">,</code> <code class="n">output_layer</code><code class="p">)</code>
<code class="n">model</code><code class="o">.</code><code class="n">compile</code><code class="p">(</code><code class="n">optimizer</code><code class="o">=</code><code class="s2">"adam"</code><code class="p">,</code> <code class="n">loss</code><code class="o">=</code><code class="s2">"mean_squared_error"</code><code class="p">)</code>

<code class="c1"># Train the model</code>
<code class="n">x_train</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">((</code><code class="mi">1000</code><code class="p">,</code> <code class="mi">10</code><code class="p">))</code>
<code class="n">y_train</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">((</code><code class="mi">1000</code><code class="p">,</code> <code class="mi">1</code><code class="p">))</code>
<code class="n">model</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">x_train</code><code class="p">,</code> <code class="n">y_train</code><code class="p">)</code>

<code class="c1"># Save the model to a directory called `save_model`</code>
<code class="n">model</code><code class="o">.</code><code class="n">save</code><code class="p">(</code><code class="s2">"saved_model"</code><code class="p">)</code></pre>
<pre data-type="programlisting">32/32 [==============================] - 1s 8ms/step - loss: 0.2056
INFO:tensorflow:Assets written to: saved_model/assets</pre>
<p>We can then load the model either in another application or for
additional training:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Load neural network</code>
<code class="n">model</code> <code class="o">=</code>  <code class="n">keras</code><code class="o">.</code><code class="n">models</code><code class="o">.</code><code class="n">load_model</code><code class="p">(</code><code class="s2">"saved_model"</code><code class="p">)</code></pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id445">
<h2>Discussion</h2>
<p>Although we didn’t use <a data-primary="PB (protocol buffer) format, TensorFlow" data-type="indexterm" id="id2097"/><a data-primary="protocol buffer (PB) format, TensorFlow" data-type="indexterm" id="id2098"/>TensorFlow significantly throughout the course of this book, it is useful to know how to save and load TensorFlow models. Unlike scikit-learn, which uses the Python-native <code>pickle</code> format, TensorFlow provides its own method of saving and loading models. The <code>saved_model</code> format creates a directory that stores the model and all information necessary to load it back in and make predictions in protocol buffer format (which uses the <em>.pb</em> file extension):</p>
<pre data-code-language="bash" data-type="programlisting">ls<code class="w"> </code>saved_model<code class="w"/></pre>
<pre data-type="programlisting">assets	fingerprint.pb	keras_metadata.pb  saved_model.pb  variables</pre>
<p>While we won’t go into this format in depth, it is the standard way of saving, loading, and serving models trained in TensorFlow.</p>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="id2099">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/CDPvo">Serialization and Saving Keras Models</a></p>
</li>
<li>
<p><a href="https://oreil.ly/StpSL">TensorFlow Saved Model Format</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="23.3 Saving and Loading a PyTorch Model" data-type="sect1"><div class="sect1" id="saving-and-loading-a-pytorch-model">
<h1>23.3 Saving and Loading a PyTorch Model</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id574">
<h2>Problem</h2>
<p>You have a trained <a data-primary="PyTorch" data-secondary="saving and loading a model" data-type="indexterm" id="ix_pyt_save_load"/>PyTorch model and want to save it and load it
elsewhere.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id2100">
<h2>Solution</h2>
<p>Use the <code>torch.save</code> and <code>torch.load</code> functions:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Load libraries</code>
<code class="kn">import</code> <code class="nn">torch</code>
<code class="kn">import</code> <code class="nn">torch.nn</code> <code class="k">as</code> <code class="nn">nn</code>
<code class="kn">import</code> <code class="nn">numpy</code> <code class="k">as</code> <code class="nn">np</code>
<code class="kn">from</code> <code class="nn">torch.utils.data</code> <code class="kn">import</code> <code class="n">DataLoader</code><code class="p">,</code> <code class="n">TensorDataset</code>
<code class="kn">from</code> <code class="nn">torch.optim</code> <code class="kn">import</code> <code class="n">RMSprop</code>
<code class="kn">from</code> <code class="nn">sklearn.datasets</code> <code class="kn">import</code> <code class="n">make_classification</code>
<code class="kn">from</code> <code class="nn">sklearn.model_selection</code> <code class="kn">import</code> <code class="n">train_test_split</code>

<code class="c1"># Create training and test sets</code>
<code class="n">features</code><code class="p">,</code> <code class="n">target</code> <code class="o">=</code> <code class="n">make_classification</code><code class="p">(</code><code class="n">n_classes</code><code class="o">=</code><code class="mi">2</code><code class="p">,</code> <code class="n">n_features</code><code class="o">=</code><code class="mi">10</code><code class="p">,</code>
    <code class="n">n_samples</code><code class="o">=</code><code class="mi">1000</code><code class="p">)</code>
<code class="n">features_train</code><code class="p">,</code> <code class="n">features_test</code><code class="p">,</code> <code class="n">target_train</code><code class="p">,</code> <code class="n">target_test</code> <code class="o">=</code> <code class="n">train_test_split</code><code class="p">(</code>
    <code class="n">features</code><code class="p">,</code> <code class="n">target</code><code class="p">,</code> <code class="n">test_size</code><code class="o">=</code><code class="mf">0.1</code><code class="p">,</code> <code class="n">random_state</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code>

<code class="c1"># Set random seed</code>
<code class="n">torch</code><code class="o">.</code><code class="n">manual_seed</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="n">np</code><code class="o">.</code><code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>

<code class="c1"># Convert data to PyTorch tensors</code>
<code class="n">x_train</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">from_numpy</code><code class="p">(</code><code class="n">features_train</code><code class="p">)</code><code class="o">.</code><code class="n">float</code><code class="p">()</code>
<code class="n">y_train</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">from_numpy</code><code class="p">(</code><code class="n">target_train</code><code class="p">)</code><code class="o">.</code><code class="n">float</code><code class="p">()</code><code class="o">.</code><code class="n">view</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
<code class="n">x_test</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">from_numpy</code><code class="p">(</code><code class="n">features_test</code><code class="p">)</code><code class="o">.</code><code class="n">float</code><code class="p">()</code>
<code class="n">y_test</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">from_numpy</code><code class="p">(</code><code class="n">target_test</code><code class="p">)</code><code class="o">.</code><code class="n">float</code><code class="p">()</code><code class="o">.</code><code class="n">view</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>

<code class="c1"># Define a neural network using `Sequential`</code>
<code class="k">class</code> <code class="nc">SimpleNeuralNet</code><code class="p">(</code><code class="n">nn</code><code class="o">.</code><code class="n">Module</code><code class="p">):</code>
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="nb">super</code><code class="p">(</code><code class="n">SimpleNeuralNet</code><code class="p">,</code> <code class="bp">self</code><code class="p">)</code><code class="o">.</code><code class="fm">__init__</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">sequential</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Sequential</code><code class="p">(</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Linear</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">16</code><code class="p">),</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">ReLU</code><code class="p">(),</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Linear</code><code class="p">(</code><code class="mi">16</code><code class="p">,</code><code class="mi">16</code><code class="p">),</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">ReLU</code><code class="p">(),</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Linear</code><code class="p">(</code><code class="mi">16</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Dropout</code><code class="p">(</code><code class="mf">0.1</code><code class="p">),</code> <code class="c1"># Drop 10% of neurons</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Sigmoid</code><code class="p">(),</code>
        <code class="p">)</code>

    <code class="k">def</code> <code class="nf">forward</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">x</code><code class="p">):</code>
        <code class="n">x</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">sequential</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
        <code class="k">return</code> <code class="n">x</code>

<code class="c1"># Initialize neural network</code>
<code class="n">network</code> <code class="o">=</code> <code class="n">SimpleNeuralNet</code><code class="p">()</code>

<code class="c1"># Define loss function, optimizer</code>
<code class="n">criterion</code> <code class="o">=</code> <code class="n">nn</code><code class="o">.</code><code class="n">BCELoss</code><code class="p">()</code>
<code class="n">optimizer</code> <code class="o">=</code> <code class="n">RMSprop</code><code class="p">(</code><code class="n">network</code><code class="o">.</code><code class="n">parameters</code><code class="p">())</code>

<code class="c1"># Define data loader</code>
<code class="n">train_data</code> <code class="o">=</code> <code class="n">TensorDataset</code><code class="p">(</code><code class="n">x_train</code><code class="p">,</code> <code class="n">y_train</code><code class="p">)</code>
<code class="n">train_loader</code> <code class="o">=</code> <code class="n">DataLoader</code><code class="p">(</code><code class="n">train_data</code><code class="p">,</code> <code class="n">batch_size</code><code class="o">=</code><code class="mi">100</code><code class="p">,</code> <code class="n">shuffle</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>

<code class="c1"># Compile the model using torch 2.0's optimizer</code>
<code class="n">network</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">compile</code><code class="p">(</code><code class="n">network</code><code class="p">)</code>

<code class="c1"># Train neural network</code>
<code class="n">epochs</code> <code class="o">=</code> <code class="mi">5</code>
<code class="k">for</code> <code class="n">epoch</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">epochs</code><code class="p">):</code>
    <code class="k">for</code> <code class="n">batch_idx</code><code class="p">,</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">target</code><code class="p">)</code> <code class="ow">in</code> <code class="nb">enumerate</code><code class="p">(</code><code class="n">train_loader</code><code class="p">):</code>
        <code class="n">optimizer</code><code class="o">.</code><code class="n">zero_grad</code><code class="p">()</code>
        <code class="n">output</code> <code class="o">=</code> <code class="n">network</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>
        <code class="n">loss</code> <code class="o">=</code> <code class="n">criterion</code><code class="p">(</code><code class="n">output</code><code class="p">,</code> <code class="n">target</code><code class="p">)</code>
        <code class="n">loss</code><code class="o">.</code><code class="n">backward</code><code class="p">()</code>
        <code class="n">optimizer</code><code class="o">.</code><code class="n">step</code><code class="p">()</code>

<code class="c1"># Save the model after it's been trained</code>
<code class="n">torch</code><code class="o">.</code><code class="n">save</code><code class="p">(</code>
    <code class="p">{</code>
        <code class="s1">'epoch'</code><code class="p">:</code> <code class="n">epoch</code><code class="p">,</code>
        <code class="s1">'model_state_dict'</code><code class="p">:</code> <code class="n">network</code><code class="o">.</code><code class="n">state_dict</code><code class="p">(),</code>
        <code class="s1">'optimizer_state_dict'</code><code class="p">:</code> <code class="n">optimizer</code><code class="o">.</code><code class="n">state_dict</code><code class="p">(),</code>
        <code class="s1">'loss'</code><code class="p">:</code> <code class="n">loss</code><code class="p">,</code>
    <code class="p">},</code>
    <code class="s2">"model.pt"</code>
<code class="p">)</code>

<code class="c1"># Reinitialize neural network</code>
<code class="n">network</code> <code class="o">=</code> <code class="n">SimpleNeuralNet</code><code class="p">()</code>
<code class="n">state_dict</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">load</code><code class="p">(</code>
    <code class="s2">"model.pt"</code><code class="p">,</code>
    <code class="n">map_location</code><code class="o">=</code><code class="n">torch</code><code class="o">.</code><code class="n">device</code><code class="p">(</code><code class="s1">'cpu'</code><code class="p">)</code>
    <code class="p">)[</code><code class="s2">"model_state_dict"</code><code class="p">]</code>
<code class="n">network</code><code class="o">.</code><code class="n">load_state_dict</code><code class="p">(</code><code class="n">state_dict</code><code class="p">,</code> <code class="n">strict</code><code class="o">=</code><code class="kc">False</code><code class="p">)</code>
<code class="n">network</code><code class="o">.</code><code class="n">eval</code><code class="p">()</code></pre>
<pre data-type="programlisting">SimpleNeuralNet(
  (sequential): Sequential(
    (0): Linear(in_features=10, out_features=16, bias=True)
    (1): ReLU()
    (2): Linear(in_features=16, out_features=16, bias=True)
    (3): ReLU()
    (4): Linear(in_features=16, out_features=1, bias=True)
    (5): Dropout(p=0.1, inplace=False)
    (6): Sigmoid()
  )
)</pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id446">
<h2>Discussion</h2>
<p>Though we used a similar formula in <a data-type="xref" href="ch21.xhtml#neural-networks">Chapter 21</a> to checkpoint our training progress, here we see how the same approach can be used to load a model back into memory to make predictions. The <code>model.pt</code> that we save the model in is actually just a dictionary that contains the model parameters. We saved the model state in the dictionary key <code>model_state_dict</code>; to load the model back in, we re-initialize our network and load the state of the model using <code>network.load_state_dict</code>.<a data-primary="" data-startref="ix_load_save_mod2" data-type="indexterm" id="id2101"/><a data-primary="" data-startref="ix_save_load_mod2" data-type="indexterm" id="id2102"/><a data-primary="" data-startref="ix_pyt_save_load" data-type="indexterm" id="id2103"/></p>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="id2104">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/WO3X1">PyTorch tutorial: Saving and Loading Models</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="23.4 Serving scikit-learn Models" data-type="sect1"><div class="sect1" id="id867">
<h1>23.4 Serving scikit-learn Models</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id447">
<h2>Problem</h2>
<p>You want to <a data-primary="serving models" data-type="indexterm" id="ix_serv_mod_ch23"/><a data-primary="scikit-learn library" data-secondary="serving a model" data-type="indexterm" id="ix_scikit_serve_mod"/>serve your trained scikit-learn model using a web server.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id2105">
<h2>Solution</h2>
<p>Build a Python Flask application that loads the model trained earlier in this chapter:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Import libraries</code>
<code class="kn">import</code> <code class="nn">joblib</code>
<code class="kn">from</code> <code class="nn">flask</code> <code class="kn">import</code> <code class="n">Flask</code><code class="p">,</code> <code class="n">request</code>

<code class="c1"># Instantiate a flask app</code>
<code class="n">app</code> <code class="o">=</code> <code class="n">Flask</code><code class="p">(</code><code class="vm">__name__</code><code class="p">)</code>

<code class="c1"># Load the model from disk</code>
<code class="n">model</code> <code class="o">=</code> <code class="n">joblib</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="s2">"model.pkl"</code><code class="p">)</code>

<code class="c1"># Create a predict route that takes JSON data, makes predictions, and</code>
<code class="c1"># returns them</code>
<code class="nd">@app</code><code class="o">.</code><code class="n">route</code><code class="p">(</code><code class="s2">"/predict"</code><code class="p">,</code> <code class="n">methods</code> <code class="o">=</code> <code class="p">[</code><code class="s2">"POST"</code><code class="p">])</code>
<code class="k">def</code> <code class="nf">predict</code><code class="p">():</code>
    <code class="nb">print</code><code class="p">(</code><code class="n">request</code><code class="o">.</code><code class="n">json</code><code class="p">)</code>
    <code class="n">inputs</code> <code class="o">=</code> <code class="n">request</code><code class="o">.</code><code class="n">json</code><code class="p">[</code><code class="s2">"inputs"</code><code class="p">]</code>
    <code class="n">prediction</code> <code class="o">=</code> <code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">inputs</code><code class="p">)</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="s2">"prediction"</code> <code class="p">:</code> <code class="n">prediction</code><code class="o">.</code><code class="n">tolist</code><code class="p">()</code>
    <code class="p">}</code>

 <code class="c1"># Run the app</code>
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>
    <code class="n">app</code><code class="o">.</code><code class="n">run</code><code class="p">()</code></pre>
<p>Make sure you have Flask installed:</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">python3</code> <code class="o">-</code><code class="n">m</code> <code class="n">pip</code> <code class="n">install</code> <code class="n">flask</code><code class="o">==</code><code class="mf">2.2.3</code> <code class="n">joblib</code><code class="o">==</code><code class="mf">1.2.0</code> <code class="n">scikit</code><code class="o">-</code><code class="n">learn</code><code class="o">==</code><code class="mf">1.2.0</code></pre>
<p>And then run the application:</p>
<pre data-code-language="bash" data-type="programlisting">python3<code class="w"> </code>app.py<code class="w"/></pre>
<pre data-type="programlisting"> * Serving Flask app 'app'
 * Debug mode: off
WARNING: This is a development server. Do not use it in a production deployment.
    Use a production WSGI server instead.
 * Running on http://127.0.0.1:5000
Press CTRL+C to quit</pre>
<p>Now, we can make predictions to the application and get results by submitting data points to the endpoints using <code>curl</code>:</p>
<pre data-code-language="bash" data-type="programlisting">curl<code class="w"> </code>-X<code class="w"> </code>POST<code class="w"> </code>http://127.0.0.1:5000/predict<code class="w">  </code>-H<code class="w"> </code><code class="s1">'Content-Type: application/json'</code><code class="w"/>
<code class="w">    </code>-d<code class="w"> </code><code class="s1">'{"inputs":[[5.1, 3.5, 1.4, 0.2]]}'</code><code class="w"/></pre>
<pre data-type="programlisting">{"prediction":[0]}</pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id448">
<h2>Discussion</h2>
<p>In this example, we used <a data-primary="Flask application" data-type="indexterm" id="id2106"/><a data-primary="Python Flask application" data-type="indexterm" id="id2107"/>Flask, a popular open source library for building web frameworks in Python. We define one route, <code>/predict</code>, that takes JSON data in a POST request and returns a dictionary containing the predictions. Though this server is not production-ready (see the Flask warning about using a development server), we can easily extend and serve this code with a more production-ready web framework to move it to production.<a data-primary="" data-startref="ix_scikit_serve_mod" data-type="indexterm" id="id2108"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="23.5 Serving TensorFlow Models" data-type="sect1"><div class="sect1" id="id868">
<h1>23.5 Serving TensorFlow Models</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id449">
<h2>Problem</h2>
<p>You want to serve your trained <a data-primary="TensorFlow" data-type="indexterm" id="ix_tensorflow_ch23"/>TensorFlow model using a web server.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id450">
<h2>Solution</h2>
<p>Use the <a data-primary="TensorFlow Serving framework" data-type="indexterm" id="ix_tf_serving_ch23"/><a data-primary="Docker" data-type="indexterm" id="ix_Docker_ch23"/>open source TensorFlow Serving framework and Docker:</p>
<pre data-code-language="bash" data-type="programlisting">docker<code class="w"> </code>run<code class="w"> </code>-p<code class="w"> </code><code class="m">8501</code>:8501<code class="w"> </code>-p<code class="w"> </code><code class="m">8500</code>:8500<code class="w"> </code><code class="se">\</code>
--mount<code class="w"> </code><code class="nv">type</code><code class="o">=</code>bind,source<code class="o">=</code><code class="k">$(</code><code class="nb">pwd</code><code class="k">)</code>/saved_model,target<code class="o">=</code>/models/saved_model/1<code class="w"> </code><code class="se">\</code>
-e<code class="w"> </code><code class="nv">MODEL_NAME</code><code class="o">=</code>saved_model<code class="w"> </code>-t<code class="w"> </code>tensorflow/serving<code class="w"/></pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id451">
<h2>Discussion</h2>
<p>TensorFlow Serving is an open source serving solution optimized for TensorFlow models. By simply providing the model path, we get an HTTP and gRPC server out of the box with additional useful features for developers.</p>
<p>The <code>docker run</code> command runs a container using the public <code>tensorflow/serving</code> image and mounts the <code>saved_model</code> path of our current working directory (<code>$(pwd)/saved_model</code>) to <code>/models/saved_model/1</code> inside our container. This automatically loads the model we saved earlier in this chapter into a running Docker container we can send prediction queries to.</p>
<p>If you go to <a class="bare" href="http://localhost:8501/v1/models/saved_model"><em class="hyperlink">http://localhost:8501/v1/models/saved_model</em></a> in your web browser, you should see the JSON result shown here:</p>
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"model_version_status"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>
<code class="w">        </code><code class="p">{</code><code class="w"/>
<code class="w">            </code><code class="nt">"version"</code><code class="p">:</code><code class="w"> </code><code class="s2">"1"</code><code class="p">,</code><code class="w"/>
<code class="w">            </code><code class="nt">"state"</code><code class="p">:</code><code class="w"> </code><code class="s2">"AVAILABLE"</code><code class="p">,</code><code class="w"/>
<code class="w">            </code><code class="nt">"status"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">                </code><code class="nt">"error_code"</code><code class="p">:</code><code class="w"> </code><code class="s2">"OK"</code><code class="p">,</code><code class="w"/>
<code class="w">                </code><code class="nt">"error_message"</code><code class="p">:</code><code class="w"> </code><code class="s2">""</code><code class="w"/>
<code class="w">            </code><code class="p">}</code><code class="w"/>
<code class="w">        </code><code class="p">}</code><code class="w"/>
<code class="w">    </code><code class="p">]</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>The <code>/metadata</code> route at <a class="bare" href="http://localhost:8501/v1/models/saved_model/metadata"><em class="hyperlink">http://localhost:8501/v1/models/saved_model/metadata</em></a> will return more information about the model:</p>
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>
<code class="nt">"model_spec"</code><code class="p">:{</code><code class="w"/>
<code class="w"> </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"saved_model"</code><code class="p">,</code><code class="w"/>
<code class="w"> </code><code class="nt">"signature_name"</code><code class="p">:</code><code class="w"> </code><code class="s2">""</code><code class="p">,</code><code class="w"/>
<code class="w"> </code><code class="nt">"version"</code><code class="p">:</code><code class="w"> </code><code class="s2">"1"</code><code class="w"/>
<code class="p">}</code><code class="w"/>
<code class="p">,</code><code class="w"/>
<code class="nt">"metadata"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="nt">"signature_def"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w"> </code><code class="nt">"signature_def"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="nt">"serving_default"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">   </code><code class="nt">"inputs"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"input_8"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">     </code><code class="nt">"dtype"</code><code class="p">:</code><code class="w"> </code><code class="s2">"DT_FLOAT"</code><code class="p">,</code><code class="w"/>
<code class="w">     </code><code class="nt">"tensor_shape"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="nt">"dim"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>
<code class="w">       </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nt">"size"</code><code class="p">:</code><code class="w"> </code><code class="s2">"-1"</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">""</code><code class="w"/>
<code class="w">       </code><code class="p">},</code><code class="w"/>
<code class="w">       </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nt">"size"</code><code class="p">:</code><code class="w"> </code><code class="s2">"10"</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">""</code><code class="w"/>
<code class="w">       </code><code class="p">}</code><code class="w"/>
<code class="w">      </code><code class="p">],</code><code class="w"/>
<code class="w">      </code><code class="nt">"unknown_rank"</code><code class="p">:</code><code class="w"> </code><code class="kc">false</code><code class="w"/>
<code class="w">     </code><code class="p">},</code><code class="w"/>
<code class="w">     </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"serving_default_input_8:0"</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">   </code><code class="p">},</code><code class="w"/>
<code class="w">   </code><code class="nt">"outputs"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"dense_11"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">     </code><code class="nt">"dtype"</code><code class="p">:</code><code class="w"> </code><code class="s2">"DT_FLOAT"</code><code class="p">,</code><code class="w"/>
<code class="w">     </code><code class="nt">"tensor_shape"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="nt">"dim"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>
<code class="w">       </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nt">"size"</code><code class="p">:</code><code class="w"> </code><code class="s2">"-1"</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">""</code><code class="w"/>
<code class="w">       </code><code class="p">},</code><code class="w"/>
<code class="w">       </code><code class="p">{</code><code class="w"/>
<code class="w">        </code><code class="nt">"size"</code><code class="p">:</code><code class="w"> </code><code class="s2">"1"</code><code class="p">,</code><code class="w"/>
<code class="w">        </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">""</code><code class="w"/>
<code class="w">       </code><code class="p">}</code><code class="w"/>
<code class="w">      </code><code class="p">],</code><code class="w"/>
<code class="w">      </code><code class="nt">"unknown_rank"</code><code class="p">:</code><code class="w"> </code><code class="kc">false</code><code class="w"/>
<code class="w">     </code><code class="p">},</code><code class="w"/>
<code class="w">     </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"StatefulPartitionedCall:0"</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">   </code><code class="p">},</code><code class="w"/>
<code class="w">   </code><code class="nt">"method_name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"tensorflow/serving/predict"</code><code class="w"/>
<code class="w">  </code><code class="p">},</code><code class="w"/>
<code class="w">  </code><code class="nt">"__saved_model_init_op"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">   </code><code class="nt">"inputs"</code><code class="p">:</code><code class="w"> </code><code class="p">{},</code><code class="w"/>
<code class="w">   </code><code class="nt">"outputs"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"__saved_model_init_op"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">     </code><code class="nt">"dtype"</code><code class="p">:</code><code class="w"> </code><code class="s2">"DT_INVALID"</code><code class="p">,</code><code class="w"/>
<code class="w">     </code><code class="nt">"tensor_shape"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="nt">"dim"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>
<code class="w">      </code><code class="nt">"unknown_rank"</code><code class="p">:</code><code class="w"> </code><code class="kc">true</code><code class="w"/>
<code class="w">     </code><code class="p">},</code><code class="w"/>
<code class="w">     </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"NoOp"</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">   </code><code class="p">},</code><code class="w"/>
<code class="w">   </code><code class="nt">"method_name"</code><code class="p">:</code><code class="w"> </code><code class="s2">""</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="w"> </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre>
<p>We can make predictions to the REST endpoint using <code>curl</code> and passing the variables (this neural network takes 10 features):<a data-primary="" data-startref="ix_Docker_ch23" data-type="indexterm" id="id2109"/><a data-primary="" data-startref="ix_tensorflow_ch23" data-type="indexterm" id="id2110"/><a data-primary="" data-startref="ix_tf_serving_ch23" data-type="indexterm" id="id2111"/></p>
<pre data-code-language="bash" data-type="programlisting">curl<code class="w"> </code>-X<code class="w"> </code>POST<code class="w"> </code>http://localhost:8501/v1/models/saved_model:predict<code class="w"/>
<code class="w">    </code>-d<code class="w"> </code><code class="s1">'{"inputs":[[1,2,3,4,5,6,7,8,9,10]]}'</code><code class="w"/></pre>
<pre data-type="programlisting">{
    "outputs": [
        [
            5.59353495
        ]
    ]
}</pre>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="id2112">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/5ZEQo">TensorFlow documentation: Serving Models</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="23.6 Serving PyTorch Models in Seldon" data-type="sect1"><div class="sect1" id="id869">
<h1>23.6 Serving PyTorch Models in Seldon</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id2113">
<h2>Problem</h2>
<p>You want to serve a trained PyTorch model for real-time predictions.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id452">
<h2>Solution</h2>
<p>Serve the model using the <a data-primary="Seldon Core Python wrapper" data-type="indexterm" id="ix_seldon_python"/>Seldon Core Python wrapper:</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Import libraries</code>
<code class="kn">import</code> <code class="nn">torch</code>
<code class="kn">import</code> <code class="nn">torch.nn</code> <code class="k">as</code> <code class="nn">nn</code>
<code class="kn">import</code> <code class="nn">logging</code>

<code class="c1"># Create a PyTorch model class</code>
<code class="k">class</code> <code class="nc">SimpleNeuralNet</code><code class="p">(</code><code class="n">nn</code><code class="o">.</code><code class="n">Module</code><code class="p">):</code>
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="nb">super</code><code class="p">(</code><code class="n">SimpleNeuralNet</code><code class="p">,</code> <code class="bp">self</code><code class="p">)</code><code class="o">.</code><code class="fm">__init__</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">sequential</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Sequential</code><code class="p">(</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Linear</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code> <code class="mi">16</code><code class="p">),</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">ReLU</code><code class="p">(),</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Linear</code><code class="p">(</code><code class="mi">16</code><code class="p">,</code><code class="mi">16</code><code class="p">),</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">ReLU</code><code class="p">(),</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Linear</code><code class="p">(</code><code class="mi">16</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Dropout</code><code class="p">(</code><code class="mf">0.1</code><code class="p">),</code> <code class="c1"># Drop 10% of neurons</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Sigmoid</code><code class="p">(),</code>

        <code class="p">)</code>
<code class="c1"># Create a Seldon model object with the name `MyModel`</code>
<code class="k">class</code> <code class="nc">MyModel</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>

    <code class="c1"># Loads the model</code>
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">network</code> <code class="o">=</code> <code class="n">SimpleNeuralNet</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">network</code><code class="o">.</code><code class="n">load_state_dict</code><code class="p">(</code>
            <code class="n">torch</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="s2">"model.pt"</code><code class="p">)[</code><code class="s2">"model_state_dict"</code><code class="p">],</code>
            <code class="n">strict</code><code class="o">=</code><code class="kc">False</code>
        <code class="p">)</code>
        <code class="n">logging</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">network</code><code class="o">.</code><code class="n">eval</code><code class="p">())</code>

    <code class="c1"># Makes a prediction</code>
    <code class="k">def</code> <code class="nf">predict</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">X</code><code class="p">,</code> <code class="n">features_names</code><code class="o">=</code><code class="kc">None</code><code class="p">):</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">network</code><code class="o">.</code><code class="n">forward</code><code class="p">(</code><code class="n">X</code><code class="p">)</code></pre>
<p>And run it with Docker:</p>
<pre data-code-language="bash" data-type="programlisting">docker<code class="w"> </code>run<code class="w"> </code>-it<code class="w"> </code>-v<code class="w"> </code><code class="k">$(</code><code class="nb">pwd</code><code class="k">)</code>:/app<code class="w"> </code>-p<code class="w"> </code><code class="m">9000</code>:9000<code class="w"> </code>kylegallatin/seldon-example<code class="w"/>
<code class="w">    </code>seldon-core-microservice<code class="w"> </code>MyModel<code class="w"> </code>--service-type<code class="w"> </code>MODEL<code class="w"/></pre>
<pre data-type="programlisting">2023-03-11 14:40:52,277 - seldon_core.microservice:main:578 -
    INFO:  Starting microservice.py:main
2023-03-11 14:40:52,277 - seldon_core.microservice:main:579 -
    INFO:  Seldon Core version: 1.15.0
2023-03-11 14:40:52,279 - seldon_core.microservice:main:602 -
    INFO:  Parse JAEGER_EXTRA_TAGS []
2023-03-11 14:40:52,287 - seldon_core.microservice:main:605 -
    INFO:  Annotations: {}
2023-03-11 14:40:52,287 - seldon_core.microservice:main:609 -
    INFO:  Importing MyModel
2023-03-11 14:40:55,901 - root:__init__:25 - INFO:  SimpleNeuralNet(
  (sequential): Sequential(
    (0): Linear(in_features=10, out_features=16, bias=True)
    (1): ReLU()
    (2): Linear(in_features=16, out_features=16, bias=True)
    (3): ReLU()
    (4): Linear(in_features=16, out_features=1, bias=True)
    (5): Dropout(p=0.1, inplace=False)
    (6): Sigmoid()
  )
)
2023-03-11 14:40:56,024 - seldon_core.microservice:main:640 -
    INFO:  REST gunicorn microservice running on port 9000
2023-03-11 14:40:56,028 - seldon_core.microservice:main:655 -
    INFO:  REST metrics microservice running on port 6000
2023-03-11 14:40:56,029 - seldon_core.microservice:main:665 -
    INFO:  Starting servers
2023-03-11 14:40:56,029 - seldon_core.microservice:start_servers:80 -
    INFO:  Using standard multiprocessing library
2023-03-11 14:40:56,049 - seldon_core.microservice:server:432 -
    INFO:  Gunicorn Config:  {'bind': '0.0.0.0:9000', 'accesslog': None,
    'loglevel': 'info', 'timeout': 5000, 'threads': 1, 'workers': 1,
    'max_requests': 0, 'max_requests_jitter': 0, 'post_worker_init':
    &lt;function post_worker_init at 0x7f5aee2c89d0&gt;, 'worker_exit':
    functools.partial(&lt;function worker_exit at 0x7f5aee2ca170&gt;,
    seldon_metrics=&lt;seldon_core.metrics.SeldonMetrics object at
    0x7f5a769f0b20&gt;), 'keepalive': 2}
2023-03-11 14:40:56,055 - seldon_core.microservice:server:504 -
    INFO:  GRPC Server Binding to 0.0.0.0:5000 with 1 processes.
2023-03-11 14:40:56,090 - seldon_core.wrapper:_set_flask_app_configs:225 -
    INFO:  App Config:  &lt;Config {'ENV': 'production', 'DEBUG': False,
    'TESTING': False, 'PROPAGATE_EXCEPTIONS': None, 'SECRET_KEY': None,
    'PERMANENT_SESSION_LIFETIME': datetime.timedelta(days=31),
    'USE_X_SENDFILE': False, 'SERVER_NAME': None, 'APPLICATION_ROOT': '/',
    'SESSION_COOKIE_NAME': 'session', 'SESSION_COOKIE_DOMAIN': None,
    'SESSION_COOKIE_PATH': None, 'SESSION_COOKIE_HTTPONLY': True,
    'SESSION_COOKIE_SECURE': False, 'SESSION_COOKIE_SAMESITE': None,
    'SESSION_REFRESH_EACH_REQUEST': True, 'MAX_CONTENT_LENGTH': None,
    'SEND_FILE_MAX_AGE_DEFAULT': None, 'TRAP_BAD_REQUEST_ERRORS': None,
    'TRAP_HTTP_EXCEPTIONS': False, 'EXPLAIN_TEMPLATE_LOADING': False,
    'PREFERRED_URL_SCHEME': 'http', 'JSON_AS_ASCII': None,
    'JSON_SORT_KEYS': None, 'JSONIFY_PRETTYPRINT_REGULAR': None,
    'JSONIFY_MIMETYPE': None, 'TEMPLATES_AUTO_RELOAD': None,
    'MAX_COOKIE_SIZE': 4093}&gt;
2023-03-11 14:40:56,091 - seldon_core.wrapper:_set_flask_app_configs:225 -
    INFO:  App Config:  &lt;Config {'ENV': 'production', 'DEBUG': False,
    'TESTING': False, 'PROPAGATE_EXCEPTIONS': None, 'SECRET_KEY': None,
    'PERMANENT_SESSION_LIFETIME': datetime.timedelta(days=31),
    'USE_X_SENDFILE': False, 'SERVER_NAME': None, 'APPLICATION_ROOT': '/',
    'SESSION_COOKIE_NAME': 'session', 'SESSION_COOKIE_DOMAIN': None,
    'SESSION_COOKIE_PATH': None, 'SESSION_COOKIE_HTTPONLY': True,
    'SESSION_COOKIE_SECURE': False, 'SESSION_COOKIE_SAMESITE': None,
    'SESSION_REFRESH_EACH_REQUEST': True, 'MAX_CONTENT_LENGTH': None,
    'SEND_FILE_MAX_AGE_DEFAULT': None, 'TRAP_BAD_REQUEST_ERRORS': None,
    'TRAP_HTTP_EXCEPTIONS': False, 'EXPLAIN_TEMPLATE_LOADING': False,
    'PREFERRED_URL_SCHEME': 'http', 'JSON_AS_ASCII': None,
    'JSON_SORT_KEYS': None, 'JSONIFY_PRETTYPRINT_REGULAR': None,
    'JSONIFY_MIMETYPE': None, 'TEMPLATES_AUTO_RELOAD': None,
    'MAX_COOKIE_SIZE': 4093}&gt;
2023-03-11 14:40:56,096 - seldon_core.microservice:_run_grpc_server:466 - INFO:
    Starting new GRPC server with 1 threads.
[2023-03-11 14:40:56 +0000] [23] [INFO] Starting gunicorn 20.1.0
[2023-03-11 14:40:56 +0000] [23] [INFO] Listening at: http://0.0.0.0:6000 (23)
[2023-03-11 14:40:56 +0000] [23] [INFO] Using worker: sync
[2023-03-11 14:40:56 +0000] [30] [INFO] Booting worker with pid: 30
[2023-03-11 14:40:56 +0000] [1] [INFO] Starting gunicorn 20.1.0
[2023-03-11 14:40:56 +0000] [1] [INFO] Listening at: http://0.0.0.0:9000 (1)
[2023-03-11 14:40:56 +0000] [1] [INFO] Using worker: sync
[2023-03-11 14:40:56 +0000] [34] [INFO] Booting worker with pid: 34
2023-03-11 14:40:56,217 - seldon_core.gunicorn_utils:load:103 - INFO:
    Tracing not active</pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id453">
<h2>Discussion</h2>
<p>While <a data-primary="seldon-core-microservice command" data-type="indexterm" id="id2114"/>there are many different ways we can serve a PyTorch model, here we choose the Seldon Core Python wrapper. Seldon Core is a popular framework for serving models in production and has a number of useful features that make it easier to use and more scalable than a Flask application. It allows us to write a simple class (above we use <code>MyModel</code>), while the Python library takes care of all the server components and endpoints. We can then run the service using the <code>seldon-core-microservice</code> command, which starts a REST server, gRPC server, and even exposes a metrics endpoint.<a data-primary="" data-startref="ix_serv_mod_ch23" data-type="indexterm" id="id2115"/><a data-primary="" data-startref="ix_seldon_python" data-type="indexterm" id="id2116"/> To make a prediction to the service, we can call the service with the following endpoint on port 9000:</p>
<pre data-code-language="bash" data-type="programlisting">curl<code class="w"> </code>-X<code class="w"> </code>POST<code class="w"> </code>http://127.0.0.1:9000/predict<code class="w">  </code>-H<code class="w"> </code><code class="s1">'Content-Type: application/json'</code><code class="w"/>
<code class="w">    </code>-d<code class="w"> </code><code class="s1">'{"data": {"ndarray":[[0, 0, 0, 0, 0, 0, 0, 0, 0]]}}'</code><code class="w"/></pre>
<p>You should see the following output:</p>
<pre data-code-language="bash" data-type="programlisting"><code class="o">{</code><code class="s2">"data"</code>:<code class="o">{</code><code class="s2">"names"</code>:<code class="o">[</code><code class="s2">"t:0"</code>,<code class="s2">"t:1"</code>,<code class="s2">"t:2"</code>,<code class="s2">"t:3"</code>,<code class="s2">"t:4"</code>,<code class="s2">"t:5"</code>,<code class="s2">"t:6"</code>,<code class="s2">"t:7"</code>,<code class="s2">"t:8"</code><code class="o">]</code>,<code class="w"/>
<code class="w">    </code><code class="s2">"ndarray"</code>:<code class="o">[[</code><code class="m">0</code>,0,0,0,0,0,0,0,0<code class="o">]]}</code>,<code class="s2">"meta"</code>:<code class="o">{}}</code><code class="w"/></pre>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="id2117">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/FTofY">Seldon Core Python Package</a></p>
</li>
<li>
<p><a href="https://oreil.ly/fjmrE">TorchServe documentation</a></p>
</li>
</ul>
</div></section>
</div></section>
</div></section></div></body></html>