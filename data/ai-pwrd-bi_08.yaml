- en: Chapter 8\. AI-Powered Prescriptive Analytics
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第 8 章\. 基于 AI 的预测分析
- en: Now that you have learned how to leverage AI to analyze data from the past and
    make predictions about the future, it’s time to discuss recommended actions! In
    this chapter, you will learn how to support data-driven decision making by letting
    an algorithm suggest the best option out of a range of possible actions. Let’s
    go!
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您已经学会如何利用 AI 分析过去的数据并对未来进行预测，现在是讨论推荐行动的时候了！在本章中，您将学习如何通过让算法建议在一系列可能行动中选择最佳选项来支持数据驱动的决策。让我们开始吧！
- en: 'Use Case: Next Best Action Recommendation'
  id: totrans-2
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用案例：下一步最佳行动建议
- en: For this use case, we are building on the suggestions of a predictive model
    and selecting the best option for a specific customer.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这个使用案例，我们建立在预测模型建议的基础上，并选择特定客户的最佳选项。
- en: Problem Statement
  id: totrans-4
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 问题陈述
- en: We are working on the BI team of a large telco provider. The company sells various
    products, such as monthly or yearly cable and cell phone subscriptions, and has
    millions of active customers each year. The company is facing an increasing problem
    of churning customers.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 我们正在一家大型电信提供商的 BI 团队工作。该公司销售各种产品，如月度或年度的有线电视和手机订阅，并且每年有数百万活跃客户。公司面临越来越多的客户流失问题。
- en: 'The data scientists on the team have successfully built a customer churn model
    that predicts the likelihood of single customers to churn by the end of the current
    quarter. The churn predictions have been calculated as a churn score: 100 means
    highest churn probability, and 0 means lowest churn probability. While the churn
    predictor has proven quite accurate and useful in identifying those customers
    who are likely to cancel their subscription with the company, the business still
    struggles with the right measures to counter churn. The BI team has incorporated
    a churn prevention dashboard, shown in [Figure 8-1](#baseline_churn_prevention_dashboard).'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 团队的数据科学家们成功地构建了一个客户流失模型，预测了单个客户在当前季度末流失的可能性。流失预测已计算为流失分数：100 表示最高的流失概率，0 表示最低的流失概率。虽然流失预测器在识别那些可能取消订阅的客户方面非常准确和有用，但业务仍然在寻找正确的措施来对抗流失。BI
    团队已经整合了一个流失预防仪表板，如 [图 8-1](#baseline_churn_prevention_dashboard) 所示。
- en: '![Baseline churn prevention dashboard](Images/apbi_0801.png)'
  id: totrans-7
  prefs: []
  type: TYPE_IMG
  zh: '![基准流失预防仪表板](Images/apbi_0801.png)'
- en: Figure 8-1\. Baseline churn prevention dashboard
  id: totrans-8
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-1\. 基准流失预防仪表板
- en: The dashboard shows a scatterplot at the top left, comparing churn score against
    monthly revenues. In the upper-right quadrant are customers who are on an expensive
    monthly plan and at the same time have a high churn likelihood, which makes them
    a particularly relevant target group for churn prevention measures.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 仪表板在左上角显示了散点图，比较了流失分数与月收入。在右上象限中，是那些月费用高且流失可能性也高的客户，这使得他们成为特别相关的流失预防措施的目标群体。
- en: Currently, all customers that are labeled as Churn get the same retention offer.
    On average, this offer is accepted by 31% of the customers, depicted by the respective
    dots in the scatterplot. These 31% accepted offers translated to a defended revenue
    of $94,670\. Sales staff members have indicated that they could provide other
    offers but were unsure of which offer to show customers. Simple A/B testing has
    proven to be ineffective because of the large variety of customer segments and
    offer types.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 目前，所有标记为流失的客户都获得相同的留存优惠。平均而言，这一优惠被 31% 的客户接受，这些接受的优惠反映在散点图中的相应点上。这 31% 的接受优惠转化为了
    $94,670 的维护收入。销售人员表示他们可以提供其他优惠，但不确定应向客户展示哪种优惠。由于客户群体和优惠类型的多样性，简单的 A/B 测试被证明效果不佳。
- en: The head of the analytics department suggests following a data-driven approach
    to find out which retention offer should be shown to the various customer segments.
    Our goal is to come up with an approach that at least beats the existing baseline
    and supports the ability to experiment with new offer types in real time.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 分析部门的负责人建议采用数据驱动方法，找出应向各种客户群体展示哪种留存优惠。我们的目标是制定一种至少能超过现有基准线的方法，并支持实时尝试新的优惠类型。
- en: Solution Overview
  id: totrans-12
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 解决方案概述
- en: '[Figure 8-2](#next_best_offer_use_case_architecture) shows our use case architecture
    for tackling this problem.'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 8-2](#next_best_offer_use_case_architecture) 展示了我们用于解决这一问题的使用案例架构。'
- en: As you can see, the heavy lifting will be done in the data layer. That’s because
    we are relying on an out-of-the-box AI service in the analysis layer to predict
    the best offers for us.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 正如您所见，繁重的工作将在数据层完成。这是因为在分析层我们依赖于现成的 AI 服务来预测最佳的推荐。
- en: '![Next Best Offer use case architecture](Images/apbi_0802.png)'
  id: totrans-15
  prefs: []
  type: TYPE_IMG
  zh: '![Next Best Offer use case architecture](Images/apbi_0802.png)'
- en: Figure 8-2\. Next Best Offer use case architecture
  id: totrans-16
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-2\. Next Best Offer 使用案例架构
- en: The AI service is using an approach called *reinforcement learning*. By experimenting
    with different offers for different customer groups, the reinforcement model will
    finally figure out which offer to show to which customer group. The model will
    learn based on a reward system. If a customer accepts the offer, the model will
    get a reward; if not, the model will be penalized. We will use a Microsoft AI
    service called *Azure Personalizer* to run and maintain the model.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: AI 服务采用一种称为 *强化学习* 的方法。通过为不同的客户群体尝试不同的推荐，强化模型最终将找出向哪些客户群体展示哪些推荐。该模型将基于奖励系统进行学习。如果客户接受推荐，模型将获得奖励；如果不接受，则模型将受到惩罚。我们将使用
    Microsoft 的 AI 服务 *Azure Personalizer* 运行和维护该模型。
- en: However, in order for this service to work, we need to provide user interaction
    data. And since we don’t want to send out offers to clients in this example, we
    are going to simulate user behavior based on a rule table that contains the user
    preferences. In a real-world setting, we naturally don’t know these user preferences
    and have to find them out through experimentation, but for the sake of our simulation,
    we will keep the ground truth stored in a plain JSON file. Of course, the model
    will not have access to this file and needs to find the patterns alone.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，为了使此服务正常运行，我们需要提供用户互动数据。由于在这个示例中我们不希望向客户发送推荐，因此我们将基于包含用户偏好的规则表来模拟用户行为。在现实世界的设置中，我们自然不知道这些用户偏好，必须通过实验来找出它们，但是为了我们的模拟，我们将保留真实数据存储在一个普通的
    JSON 文件中。当然，模型将无法访问此文件，需要单独找出这些模式。
- en: A small script running inside an Azure notebook will mimic offer proposals to
    users with the help of the Personalizer service and generate rewards based on
    the users’ (hidden) preferences. The results of our simulation will be logged
    using a CSV file and stored in Azure Blob Storage so we can access them later
    through Power BI for further analysis.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Azure 笔记本中运行的一个小脚本将利用个性化服务模拟向用户提供推荐，并根据用户的（隐藏）偏好生成奖励。我们的模拟结果将使用 CSV 文件记录，并存储在
    Azure Blob Storage 中，以便稍后通过 Power BI 进行进一步分析。
- en: Finally, we will use Power BI to monitor our model performance and get an overview
    of which offers are going to be recommended for which user cohorts. With this
    approach, we should be able to see how much better our personalized recommendation
    is compared to the baseline recommendation.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们将使用 Power BI 监控我们模型的性能，并了解哪些推荐适合哪些用户群体。通过这种方法，我们应该能够看到我们的个性化推荐与基线推荐相比有多大的改进。
- en: Setting Up the AI Service
  id: totrans-21
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置 AI 服务
- en: Navigate to your Azure dashboard by visiting *[portal.azure.com](http://portal.azure.com)*.
    Type `**Personalizer**` in the search bar at the top and choose Personalizers
    under Services. Click Create, which brings you to the Create Personalizer form
    ([Figure 8-3](#creating_a_personalizer_form)). Choose the resource group you created
    in [Chapter 4](ch04.xhtml#prototyping) and give your recommendation service a
    name such as `**offer-engine**`. Choose the Free F0 pricing tier. Click “Review
    + create.” After the final validation passes, confirm with Create. The deployment
    might take a few minutes to complete.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 访问 *[portal.azure.com](http://portal.azure.com)* 进入 Azure 仪表板。在顶部的搜索栏中输入 `**Personalizer**`，选择服务中的
    Personalizers。点击“创建”，将您带到创建个性化推荐表单的页面（见 [Figure 8-3](#creating_a_personalizer_form)）。选择您在
    [第四章](ch04.xhtml#prototyping) 中创建的资源组，并为您的推荐服务取一个名字，例如 `**offer-engine**`。选择 Free
    F0 定价层。点击“审核 + 创建”。通过最终验证后，确认创建。部署可能需要几分钟完成。
- en: '![Creating a Personalizer form](Images/apbi_0803.png)'
  id: totrans-23
  prefs: []
  type: TYPE_IMG
  zh: '![创建个性化推荐表单](Images/apbi_0803.png)'
- en: Figure 8-3\. Creating a Personalizer form
  id: totrans-24
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-3\. 创建个性化推荐表单
- en: Once the deployment of your Personalizer service is finished, navigate to the
    service by clicking “Go to resource.” Let’s head over there to see what’s going
    on. On the service home page, you should be greeted with a quick start that looks
    like [Figure 8-4](#personalizer_service_quick_start).
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦您的 Personalizer 服务部署完成，请点击“Go to resource”导航至服务页面。让我们前往那里看看发生了什么。在服务首页，您会看到一个快速开始，看起来像
    [Figure 8-4](#personalizer_service_quick_start)。
- en: '![Personalizer service quick start](Images/apbi_0804.png)'
  id: totrans-26
  prefs: []
  type: TYPE_IMG
  zh: '![Personalizer service quick start](Images/apbi_0804.png)'
- en: Figure 8-4\. Personalizer service quick start
  id: totrans-27
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-4\. Personalizer 服务快速开始
- en: This interface can be a bit overwhelming at first, but we don’t need to do very
    much here. First, click Configuration in the left menu pane to review your model
    settings. This is the place where you can tweak the learning behavior of your
    model. Which time to choose here depends on the data you work with. It is usually
    OK to start with the standard settings and see how quickly the model picks up
    any patterns. But for our use case, because we are going to simulate user interactions,
    we want to keep the wait and model update cycles short. Set the “Reward wait time”
    to 10 minutes and the “Model update frequency” to 1 minute, as shown in [Figure 8-5](#personalizer_learning_configuration).
    Also, we can lower the exploration percentage to 15%, because we know that the
    user preferences are not changing during our experiments.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 这个界面一开始可能有点令人不知所措，但我们在这里不需要做太多事情。首先，在左侧菜单中点击“Configuration”以查看您的模型设置。这是您可以调整模型学习行为的地方。选择这里的时间取决于您处理的数据。通常可以从标准设置开始，并查看模型如何迅速捕捉任何模式。但对于我们的用例，因为我们将模拟用户交互，我们希望保持等待和模型更新周期短。将“奖励等待时间”设置为
    10 分钟，将“模型更新频率”设置为 1 分钟，如 [Figure 8-5](#personalizer_learning_configuration) 所示。此外，我们可以将探索百分比降低到
    15%，因为我们知道在我们的实验过程中用户偏好不会改变。
- en: '![Personalizer learning configuration](Images/apbi_0805.png)'
  id: totrans-29
  prefs: []
  type: TYPE_IMG
  zh: '![Personalizer learning configuration](Images/apbi_0805.png)'
- en: Figure 8-5\. Personalizer learning configuration
  id: totrans-30
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-5\. Personalizer 学习配置
- en: Don’t forget to save your changes by clicking the small disk icon at the top
    and verify that the settings have been applied by refreshing the page.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 不要忘记通过点击顶部的小磁盘图标保存您的更改，并通过刷新页面验证设置是否已应用。
- en: Next, check out the “Learning behavior” tab. This is a practical feature for
    real-world settings. Here you can adjust whether the service should immediately
    deliver the predicted result or should run in *apprentice mode*, which means serving
    a baseline prediction and collecting data until this baseline can be topped. You
    can find more information about the learning behavior of the Personalizer service
    by looking at the Microsoft document [“Configure the Personalizer Learner Behavior”](https://oreil.ly/ndze1).
    For our setting, we will leave everything as it is and stay with “Return the best
    action, learn online.”
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，查看“Learning behavior”选项卡。这是一个实际设置中的实用功能。在这里，您可以调整服务是立即交付预测结果还是运行在 *学徒模式*，这意味着提供基线预测并收集数据，直到此基线可以超越。您可以通过查看微软文档
    [“配置 Personalizer 学习行为”](https://oreil.ly/ndze1) 获取有关 Personalizer 服务学习行为的更多信息。对于我们的设置，我们将保持一切不变，并选择“返回最佳操作，实时学习”。
- en: To access the model and send requests to it, we need both the unique model URL
    and the corresponding access keys. You can find both by clicking the “Keys and
    Endpoint” menu in the navigation pane on the left to access the screen shown in
    [Figure 8-6](#access_keys_and_url_to_personalizer_ser).
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 要访问模型并向其发送请求，我们需要独特的模型 URL 和相应的访问密钥。您可以通过在左侧导航窗格中点击“Keys and Endpoint”菜单来找到它们，以访问如下所示的屏幕：[Figure 8-6](#access_keys_and_url_to_personalizer_ser)。
- en: '![Access keys and URL to Personalizer service](Images/apbi_0806.png)'
  id: totrans-34
  prefs: []
  type: TYPE_IMG
  zh: '![Access keys and URL to Personalizer service](Images/apbi_0806.png)'
- en: Figure 8-6\. Access keys and URL to Personalizer service
  id: totrans-35
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-6\. 访问 Personalizer 服务的快捷键和 URL
- en: This screen is showing you two essential pieces of information. First, it gives
    you two access keys that you need to authenticate against the API so you are allowed
    to make rank and reward requests. And second, you will find the URL that you will
    need to access the model. Leave this page open for later, because we will need
    this information when we interact with the model.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 此屏幕显示了两个重要信息。首先，它为您提供了两个访问密钥，您需要使用它们进行 API 验证，以便允许您进行排名和奖励请求。其次，您会找到访问模型所需的
    URL。将此页面保持打开，因为在与模型交互时，我们将需要这些信息。
- en: How Reinforcement Learning Works with the Personalizer Service
  id: totrans-37
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 强化学习如何与 Personalizer 服务配合工作
- en: Now that we have set up our model and have the credentials to use it, it is
    a good time to review how the process of learning actually happens and how the
    model works. [Figure 8-7](#conceptual_flow_of_personalizer_service) shows this
    conceptually.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经设置了我们的模型并获得了使用它的凭据，现在是时候回顾学习过程实际上是如何发生的，以及模型的工作原理了。[Figure 8-7](#conceptual_flow_of_personalizer_service)在概念上展示了这一点。
- en: 'A typical request to the model incorporates both a rank and a reward call.
    Together, this is referred to as a *learning loop*: the rank function suggests
    something to the user and decides whether the model should *exploit* (show the
    best action based on past data) or *explore* (select a different action to see
    if the overall recommendation result can be still improved).'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 模型的典型请求同时包含排名和奖励调用。这两者共同被称为*学习循环*：排名函数向用户建议某些内容，并决定模型是否*利用*（根据过去的数据显示最佳行动）或*探索*（选择不同的行动以查看是否可以改善总体推荐结果）。
- en: '![Conceptual flow of Personalizer service interacting with an application](Images/apbi_0807.png)'
  id: totrans-40
  prefs: []
  type: TYPE_IMG
  zh: '![个性化服务与应用程序的概念流程交互](Images/apbi_0807.png)'
- en: Figure 8-7\. Conceptual flow of Personalizer service interacting with an application
  id: totrans-41
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: Figure 8-7\. 个性化服务与应用程序的概念流程交互
- en: After the service has suggested an action to the user, the model expects a reward.
    This can be anything from a simple flag such as `0` for “not successful” or `1`
    for “successful” (in our case, indicating whether an offer was accepted), or it
    can be a continuous value that can represent anything from the scroll depth of
    news articles to profit won from a stock trade. Reinforcement learning is a pretty
    universal concept that can be applied in any scenario where the system follows
    a defined set of rules.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 当服务向用户建议行动后，模型期望得到一个奖励。这可以是一个简单的标志，比如`0`表示“不成功”，或`1`表示“成功”（在我们的案例中，表示是否接受了一项提议），或者可以是一个连续的值，可以代表从新闻文章的滚动深度到股票交易赢利的任何内容。强化学习是一个非常通用的概念，可以应用于系统遵循一组定义好的规则的任何场景。
- en: 'In the case of Azure Personalizer, the service works as follows, as you can
    see in [Figure 8-7](#conceptual_flow_of_personalizer_service):'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 在Azure Personalizer的情况下，服务的工作方式如下，如您在[Figure 8-7](#conceptual_flow_of_personalizer_service)中所见：
- en: Information about the user (context features) and about the available actions
    to choose from is sent to the Personalizer service over the Rank API.
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 关于用户的信息（上下文特征）和可供选择的行动的信息通过Rank API发送到Personalizer服务。
- en: The service will do its magic and send a rank response back. The rank response
    returns a ranked list of actions by their highest chance of receiving a reward
    (if running in exploit mode).
  id: totrans-45
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 服务将通过神奇之处并将一个排名响应返回。排名响应通过它们最有可能获得奖励的概率排列的行动列表（如果在利用模式下运行）。
- en: Depending on which action the user takes, a result score is calculated by the
    application and sent back to the service using the Reward API. The model will
    take this feedback and update itself according to the learning policies that were
    defined up front.
  id: totrans-46
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 根据用户采取的行动，应用程序计算结果分数并通过奖励API发送回服务。模型将接收此反馈，并根据预先定义的学习策略进行更新。
- en: Equipped with this new knowledge about reinforcement learning, let’s move on
    to get some hands-on experience about how a learning loop looks in practice and
    how we can utilize this in our BI.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 有了这些关于强化学习的新知识，让我们继续获得一些实际操作经验，看看学习循环在实践中是如何工作的，以及我们如何在我们的BI中利用这一点。
- en: Setting Up Azure Notebooks
  id: totrans-48
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置Azure笔记本
- en: To simulate user interactions with our offers, we need to run some code outside
    of Power BI. To run the code, we will use Azure Notebooks. This service offers
    a quick way to execute Python or R code without having to install any software
    on your machine.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 要模拟用户与我们的优惠互动，我们需要在Power BI之外运行一些代码。要运行代码，我们将使用Azure笔记本。这项服务提供了一种快速执行Python或R代码的方式，无需在您的计算机上安装任何软件。
- en: To set up Azure Notebooks, navigate to *[ml.azure.com](http://ml.azure.com)*,
    choose your preferred workspace, and navigate to Notebooks, as shown in [Figure 8-8](#azure_notebooks).
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 要设置Azure笔记本，请转到*[ml.azure.com](http://ml.azure.com)*，选择您喜欢的工作区，并导航到笔记本，如[Figure 8-8](#azure_notebooks)所示。
- en: '![Azure Notebooks](Images/apbi_0808.png)'
  id: totrans-51
  prefs: []
  type: TYPE_IMG
  zh: '![Azure Notebooks](Images/apbi_0808.png)'
- en: Figure 8-8\. Azure Notebooks
  id: totrans-52
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: Figure 8-8\. Azure笔记本
- en: 'Choose Upload → Upload files, as shown in [Figure 8-9](#creating_a_new_azure_notebook).
    Select the following files:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 选择上传 → 上传文件，如[Figure 8-9](#creating_a_new_azure_notebook)所示。选择以下文件：
- en: '*user-simulations.ipynb*'
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*user-simulations.ipynb*'
- en: '*customer-information.csv*'
  id: totrans-55
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*customer-information.csv*'
- en: '*preferences.json*'
  id: totrans-56
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*preferences.json*'
- en: '*offers.json*'
  id: totrans-57
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*offers.json*'
- en: You can find all the files on the [book’s website](https://oreil.ly/aLTWS).
    Check the “I trust the contents of this file” option and click Upload.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在[书籍网站](https://oreil.ly/aLTWS)上找到所有文件。选择“我信任此文件的内容”选项并点击上传。
- en: '![Creating a new Azure notebook](Images/apbi_0809.png)'
  id: totrans-59
  prefs: []
  type: TYPE_IMG
  zh: '![创建新的Azure笔记本](Images/apbi_0809.png)'
- en: Figure 8-9\. Creating a new Azure notebook
  id: totrans-60
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-9\. 创建新的Azure笔记本
- en: Click the *user-simulations.ipynb* file. You should see the notebook on the
    right side of the screen and all files on the left, as shown in [Figure 8-10](#azure_notebooks_interface).
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 点击 *user-simulations.ipynb* 文件。您应该会在屏幕右侧看到笔记本，左侧则显示所有文件，如[图 8-10](#azure_notebooks_interface)所示。
- en: '![Azure Notebooks interface](Images/apbi_0810.png)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
  zh: '![Azure笔记本界面](Images/apbi_0810.png)'
- en: Figure 8-10\. Azure Notebooks interface
  id: totrans-63
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-10\. Azure笔记本界面
- en: Before we can run our code, we need to provision a compute resource where the
    code is actually being executed. If you have not created a compute resource yet,
    refer to [“Create an Azure Compute Resource”](ch04.xhtml#create_an_azure_compute_resource).
    If the resource is stopped, start the resource for this exercise. Otherwise, select
    the compute resource from the drop-down menu and click “Start compute,” as highlighted
    in [Figure 8-10](#azure_notebooks_interface).
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们运行代码之前，我们需要为代码实际执行的计算资源进行配置。如果您尚未创建计算资源，请参阅[“创建Azure计算资源”](ch04.xhtml#create_an_azure_compute_resource)。如果资源已停止，请为本练习启动资源。否则，请从下拉菜单中选择计算资源，然后点击“启动计算”，如[图 8-10](#azure_notebooks_interface)中所示。
- en: Once the compute resource has started and connected to this notebook for the
    first time, you should see a notification prompting you to authenticate your Azure
    compute resource. Click the authentication button, and as a result, you should
    see a green badge ([Figure 8-11](#authentication_in_azure_notebooks)). This authentication
    process makes it much easier to access Azure resources from within Azure Notebooks.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦计算资源启动并首次连接到此笔记本，您应该会看到一条通知，提示您对Azure计算资源进行身份验证。点击身份验证按钮，结果会显示一个绿色徽章（[图 8-11](#authentication_in_azure_notebooks)）。这一身份验证过程大大简化了从Azure笔记本中访问Azure资源的流程。
- en: '![Authentication in Azure Notebooks](Images/apbi_0811.png)'
  id: totrans-66
  prefs: []
  type: TYPE_IMG
  zh: '![Azure笔记本中的身份验证](Images/apbi_0811.png)'
- en: Figure 8-11\. Authentication in Azure Notebooks
  id: totrans-67
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-11\. Azure笔记本中的身份验证
- en: From the top right, you can now choose which programming language you would
    like to use. To follow along with the code example, choose “Python 3.6 - Azure
    ML” (or newer), as shown in [Figure 8-12](#switching_programming_languages_in_azur).
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您可以从右上角选择您想要使用的编程语言。为了跟随代码示例，请选择“Python 3.6 - Azure ML”（或更新版本），如[图 8-12](#switching_programming_languages_in_azur)所示。
- en: '![Switching programming languages in Azure Notebooks](Images/apbi_0812.png)'
  id: totrans-69
  prefs: []
  type: TYPE_IMG
  zh: '![在Azure笔记本中切换编程语言](Images/apbi_0812.png)'
- en: Figure 8-12\. Switching programming languages in Azure Notebooks
  id: totrans-70
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-12\. 在Azure笔记本中切换编程语言
- en: Note
  id: totrans-71
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 注意
- en: We will use some Azure packages needed in this code for authentication and blob
    storage that are currently not supported in R. While it is still possible to execute
    this workflow in R, it would be very heavy. So in this case, I provide only the
    Python version. All R users, please follow along here.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在此代码中使用一些Azure包进行身份验证和Blob存储，目前这些功能在R中还不受支持。虽然仍然可以在R中执行此工作流程，但会非常繁重。因此，在这种情况下，我只提供Python版本。所有R用户，请跟随这里的内容。
- en: Simulating User Interactions
  id: totrans-73
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 模拟用户交互
- en: Let’s finally simulate some user interactions with offers. For this, we will
    make two assumptions. First, we define a finite set of offer possibilities with
    a rather simple complexity. And second, we assume that we know which user segment
    accepts which offer. With this information, we can let our model start to randomly
    suggest offers to various customer segments, and it should pick up the underlying
    patterns through exploration.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 最后让我们模拟一些用户与优惠的交互。为此，我们会做出两个假设。首先，我们定义了一组有限的优惠可能性，具有相当简单的复杂性。其次，我们假设我们知道哪个用户分段接受哪个优惠。有了这些信息，我们可以让我们的模型开始随机向各种客户段推荐优惠，并通过探索捕捉到底层模式。
- en: 'We also keep the complexity of the user segments relatively low because we
    don’t want to exceed the 50,000 API calls of our free tier. Remember, we need
    one call each for each rank and reward function, and a typical reinforcement model
    needs a couple thousand iterations to start learning meaningful patterns. Therefore,
    we’ll keep the complexity low at the beginning so we can get good learning results
    with fewer learning loops (and you stay within the free credits). However, we
    will adhere to one principle: the model does not know which customer segment prefers
    which offer type, and it has to find this out on its own.'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还保持用户细分复杂性相对较低，因为我们不想超过免费层的50,000个API调用。请记住，我们每个等级和奖励函数都需要一次调用，而典型的强化模型需要几千次迭代才能开始学习有意义的模式。因此，我们将在开始时保持复杂性低，这样我们就可以在较少的学习循环中获得良好的学习结果（并且您可以保持在免费学分范围内）。但是，我们将坚持一个原则：模型不知道哪个客户段偏好哪种优惠类型，它必须自己找出答案。
- en: Don’t be limited by this example. You can freely add more context features about
    customer segments or action features or new offers if you’d like to shoot for
    higher goals.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 不要被此示例限制。如果您希望追求更高的目标，可以自由添加关于客户细分或行动特征或新优惠的更多上下文特征。
- en: 'For our simulation, we need four components:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的模拟，我们需要四个组件：
- en: Information about the available offer types and offer attributes
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 关于可用优惠类型和优惠属性的信息
- en: Information about customers (context features)
  id: totrans-79
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 关于客户的信息（上下文特征）
- en: Information about customers’ true preferences (ground truth) to calculate the
    reward offline
  id: totrans-80
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 有关客户真实偏好（基本真相）以计算离线奖励
- en: A place where we can store the interaction data so we can analyze it later through
    Power BI
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个可以存储互动数据的地方，以便稍后通过Power BI进行分析
- en: 'The first component is contained in the *offers.json* file, which lists the
    available offers and the corresponding features. Three offers are available to
    prevent churn: Free Month, Free Upgrade, and Cash Discount. To be fair, we assume
    that all of these offers have the same value, so there isn’t any offer that is
    a bigger bargain than the others. It’s purely a question of preference.'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 第一个组件包含在*offers.json*文件中，该文件列出了可用的优惠及其相应的特征。为了公平起见，我们假设所有这些优惠的价值相同，因此没有比其他优惠更划算的优惠。这纯粹是偏好的问题。
- en: The second part is the information about customers (context features). This
    information is contained in the *customer-information.csv* file. As mentioned
    before, we keep the complexity low by considering only the variables “Senior citizen”
    and “Contract,” but of course the Personalizer service can handle a lot more features.
    In fact, the more features we provide about the offer context, the better—given
    we have enough time and credits to learn.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 第二部分是关于客户的信息（上下文特征）。这些信息包含在*customer-information.csv*文件中。正如前面提到的，我们通过仅考虑“老年人”和“合同”这两个变量来保持复杂性低，但当然，Personalizer服务可以处理更多的特征。事实上，我们提供的优惠环境特征越多，效果就越好——只要我们有足够的时间和学分来学习。
- en: The third component is in *preferences.json*. It includes the information about
    which customer segment prefers which offer type. [Table 8-1](#table_eight_onedotrule_table_with_custo)
    shows this information in tabular form. These are the patterns that are unknown
    to our model, and that we want the model to pick up automatically.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 第三个部分在*preferences.json*中。它包括关于哪个客户段偏好哪种优惠类型的信息。[表 8-1](#table_eight_onedotrule_table_with_custo)以表格形式显示这些信息。这些是我们模型未知的模式，我们希望模型能够自动学习。
- en: Table 8-1\. Rule table with customer preferences
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 表 8-1\. 带有客户偏好的规则表
- en: '| Senior citizen | Contract | Preferred offer |'
  id: totrans-86
  prefs: []
  type: TYPE_TB
  zh: '| 老年人 | 合同 | 首选优惠 |'
- en: '| --- | --- | --- |'
  id: totrans-87
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| Yes | Month to month | Cash Discount (offer 1) |'
  id: totrans-88
  prefs: []
  type: TYPE_TB
  zh: '| 是 | 按月 | 现金折扣（优惠1） |'
- en: '| Yes | One year | Free Month (offer 2) |'
  id: totrans-89
  prefs: []
  type: TYPE_TB
  zh: '| 是 | 一年 | 免费一个月（优惠2） |'
- en: '| Yes | Two years | Free Month (offer 2) |'
  id: totrans-90
  prefs: []
  type: TYPE_TB
  zh: '| 是 | 两年 | 免费一个月（优惠2） |'
- en: '| No | Month to month | Performance (offer 3) |'
  id: totrans-91
  prefs: []
  type: TYPE_TB
  zh: '| 否 | 按月 | 业绩奖励（优惠3） |'
- en: '| No | One year | Performance (offer 2) |'
  id: totrans-92
  prefs: []
  type: TYPE_TB
  zh: '| 否 | 一年 | 业绩奖励（优惠2） |'
- en: '| No | Two years | Cash Discount (offer 1) |'
  id: totrans-93
  prefs: []
  type: TYPE_TB
  zh: '| 否 | 两年 | 现金折扣（优惠1） |'
- en: And finally, we will need a place to store the results of our simulation. To
    keep this example simple (and maintain accessibility via Power BI), we will save
    the results as a plain CSV file. To provide a bit more real-world experience,
    we will write the outputs to Azure Blob Storage (created in [Chapter 4](ch04.xhtml#prototyping))
    and load it from there into Power BI.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们需要一个地方来存储仿真结果。为了保持示例简单（并通过 Power BI 保持可访问性），我们将结果保存为普通的 CSV 文件。为了提供更多实际的体验，我们将输出写入
    Azure Blob Storage（在[第四章](ch04.xhtml#prototyping)中创建），然后从那里加载到 Power BI 中。
- en: Running the Simulation with Python
  id: totrans-95
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用 Python 运行仿真
- en: In Azure Notebooks, take a look at the code in front of you. My goal is for
    you to understand what this code is doing, even if you are not familiar with Python,
    so let’s walk through it.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Azure Notebooks 中，仔细看看你面前的代码。我的目标是让你理解这段代码在做什么，即使你对 Python 不熟悉，所以让我们来逐步走过它。
- en: 'The code consists of five sections. The first is called User Inputs, and you’ll
    need to customize some options:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 代码由五个部分组成。第一个称为用户输入，您需要自定义一些选项：
- en: '`OFFERS_FILE_PATH`'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: '`OFFERS_FILE_PATH`'
- en: The filepath where the *offers.json* file is located.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: '*offers.json* 文件所在的文件路径。'
- en: '`PREFERENCES_FILE_PATH`'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: '`PREFERENCES_FILE_PATH`'
- en: The filepath where the *preferences.json* file is located.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: '*preferences.json* 文件所在的文件路径。'
- en: '`USER_TABLE_FILE_PATH`'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: '`USER_TABLE_FILE_PATH`'
- en: The filepath where the *user-information.csv* file is located.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: '*user-information.csv* 文件所在的文件路径。'
- en: '`PERSONALIZATION_BASE_URL`'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: '`PERSONALIZATION_BASE_URL`'
- en: The endpoint shown on the Keys and Endpoint screen in the Azure portal.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Azure 门户中的 Keys 和 Endpoint 屏幕上显示的终结点。
- en: '`KEY`'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: '`KEY`'
- en: One of the access keys from the same page in the Azure portal (it does not matter
    which key). Make sure you replace this key if you decide to regenerate it.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 门户页面上的访问密钥之一（具体哪个密钥无关紧要）。如果决定重新生成密钥，请确保替换此密钥。
- en: '`AZURE_CONNECTION_STRING`'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: '`AZURE_CONNECTION_STRING`'
- en: The Azure connection string to authorize for the blob storage, which will be
    ignored if empty.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 用于授权 blob 存储的 Azure 连接字符串，如果为空将被忽略。
- en: '`AZURE_CONTAINER_NAME`'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: '`AZURE_CONTAINER_NAME`'
- en: The name of the Azure blob container, which will be ignored if empty.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: Azure blob 容器的名称，如果为空将被忽略。
- en: If you uploaded the files to Azure Notebooks as shown previously, you can leave
    the filepaths as they are.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 如果按照前面展示的方式将文件上传到 Azure Notebooks，可以将文件路径保留原样。
- en: Replace the `*xxxxxxxxx*` values in this section with your custom variables
    for the Personalizer URL, the Personalizer key, and the Azure connection string
    from your Azure Blob Storage account. Also, double-check that you created a storage
    container called *simulation*, as explained in [Chapter 4](ch04.xhtml#prototyping).
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中用你的自定义变量替换 `*xxxxxxxxx*` 值，包括 Personalizer URL、Personalizer 密钥和 Azure 连接字符串。还要确保你创建了一个名为
    *simulation* 的存储容器，如第四章中所述。
- en: That’s all you have to customize for this script. The rest is just reading and
    understanding before we run the whole script at once.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 这个脚本只需要你自定义这些内容。剩下的就是在我们一次性运行整个脚本之前进行阅读和理解。
- en: The second code section, called Dependencies, loads all required packages for
    this script. All these packages should be preinstalled with the “Python 3.6 -
    Azure ML” kernel we just selected.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个代码部分叫做 Dependencies，加载了此脚本所需的所有包。所有这些包应该已经预装在我们刚选择的“Python 3.6 - Azure ML”内核中。
- en: 'The third section, called Functions, contains four main functions:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 第三部分称为 Functions，包含四个主要函数：
- en: '`add_event_id`'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: '`add_event_id`'
- en: This function generates a unique ID for each rank call. The ID is used to identify
    the rank and reward call information. This value could come from a business process
    such as a web view ID or transaction ID.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 此函数为每个 rank 调用生成一个唯一的 ID。该 ID 用于标识 rank 和奖励调用信息。此值可以来自业务流程，如 Web 视图 ID 或事务 ID。
- en: '`add_action_features`'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: '`add_action_features`'
- en: This function adds the entire list of offers to the JSON object to send to the
    rank request.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 此函数将所有优惠列表添加到要发送给 rank 请求的 JSON 对象中。
- en: '`get_reward_from_preferences`'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: '`get_reward_from_preferences`'
- en: This function is called after the Rank API is called, for each iteration. It
    compares the user’s preference for an offer, based on their seniority and contract
    type, with the Personalizer’s suggestion for the user for those filters. If the
    recommendation is correct, a reward of `1` is returned; otherwise, the reward
    is `0`.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 此函数在调用 Rank API 后被调用，用于比较用户对某个优惠的偏好（基于其资历和合同类型）与 Personalizer 根据这些过滤器为用户提供的建议是否正确。如果推荐正确，则返回
    `1` 的奖励；否则为 `0`。
- en: '`loop_through_user_table`'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: '`loop_through_user_table`'
- en: This function contains the main work of the script. It will iterate through
    each line of the provided user table, request a personalized offer from the API,
    compare to the actual user preferences, and calculate a reward score that is then
    sent back to the Personalizer service. All results will be collected in a list
    called `results`, and this will be returned by the function upon completion.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 此函数包含脚本的主要工作。它将迭代提供的用户表的每一行，从 API 请求个性化优惠，与实际用户偏好进行比较，并计算一个奖励分数，然后将其发送回 Personalizer
    服务。所有结果将在名为 `results` 的列表中收集，并在函数完成时返回。
- en: The fourth section, called Execution, will invoke these functions and run the
    actual workflow.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 第四部分称为 Execution，将调用这些函数并运行实际的工作流程。
- en: The fifth section, Export, will persist the results by saving locally to a flat
    file called *results.csv*. If Azure storage credentials were provided, the results
    file will also be uploaded to Azure Blob Storage.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 第五部分 Export，将通过保存到名为 *results.csv* 的平面文件持久保存结果。如果提供了 Azure 存储凭据，则结果文件也将上传到 Azure
    Blob 存储。
- en: Verify again that you have customized all the inputs in the first code section.
    Now, run the code by selecting “Restart kernel and run all cells,” as shown in
    [Figure 8-13](#running_the_entire_azure_notebook).
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 再次验证您是否已经在第一个代码部分自定义了所有输入。现在，通过选择“重新启动内核并运行所有单元格”来运行代码，如 [图 8-13](#running_the_entire_azure_notebook)
    所示。
- en: '![Running the entire Azure notebook](Images/apbi_0813.png)'
  id: totrans-128
  prefs: []
  type: TYPE_IMG
  zh: '![运行整个 Azure 笔记本](Images/apbi_0813.png)'
- en: Figure 8-13\. Running the entire Azure notebook
  id: totrans-129
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-13\. 运行整个 Azure 笔记本
- en: An iteration over the whole customer table should take roughly 10 minutes. When
    the process is completed, you should see the new file *results.csv* being created
    on the file tree on the left. This is basically the artifact of our experiment
    (and would be the log files of a real-world scenario). If you specified an Azure
    connection string and a valid container name in the inputs, this file will automatically
    be uploaded to your Azure container. If something fails with the upload, make
    sure that you don’t run the whole script again, but only the last code cell of
    the script that handles the file upload.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 对整个客户表的迭代大约需要 10 分钟。当进程完成时，您应该会在左侧的文件树上看到新文件 *results.csv* 被创建。这基本上是我们实验的产物（也会是实际场景的日志文件）。如果在输入中指定了
    Azure 连接字符串和有效的容器名称，该文件将自动上传到您的 Azure 容器。如果上传失败，请确保您不要重新运行整个脚本，而只需运行处理文件上传的脚本最后一个代码单元。
- en: Evaluate Model Performance in Azure Portal
  id: totrans-131
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在 Azure 门户中评估模型性能
- en: To quickly get a glimpse of how the model is working, we can check the model
    performance in the Azure portal. Navigate to your Personalizer resource and select
    Evaluations from the menu on the left side. Scroll down and you should see the
    average reward score, as shown in [Figure 8-14](#personalizer_evaluation).
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 为了快速了解模型的工作情况，我们可以在 Azure 门户中检查模型的性能。导航至您的 Personalizer 资源，并从左侧菜单中选择 Evaluations。向下滚动，您应该可以看到平均奖励分数，如
    [图 8-14](#personalizer_evaluation) 所示。
- en: In this example, you can interpret this number as a percentage of how often
    the model chose the correct offer for a customer. At this time, the reward score
    should still be relatively low.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 在本示例中，您可以将这个数字解释为模型为客户选择正确优惠的百分比。此时，奖励分数应该还相对较低。
- en: '![Personalizer evaluation](Images/apbi_0814.png)'
  id: totrans-134
  prefs: []
  type: TYPE_IMG
  zh: '![Personalizer 评估](Images/apbi_0814.png)'
- en: Figure 8-14\. Personalizer evaluation
  id: totrans-135
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-14\. Personalizer 评估
- en: Remember that we started with a naive model making random guesses and figuring
    out potential patterns only after a couple thousand experiments. Personalization
    services typically require tens of thousands of examples to really perform well
    in real-world scenarios. If you run the preceding simulation code two or three
    more times, you should consequently see this number increasing. If this is not
    the case, it’s a clear sign that something is going wrong with the learning behavior
    of the model. You can check the [Microsoft FAQ](https://oreil.ly/dojWy) to troubleshoot
    errors in model learning.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，我们从一个天真的模型开始，通过几千次实验才找出潜在的模式。个性化服务通常需要成千上万个示例才能在实际场景中表现良好。如果您运行前述的模拟代码两到三次，您应该会看到此数字随之增加。如果不是这种情况，这清楚地表明模型学习行为出现了问题。您可以查看
    [Microsoft FAQ](https://oreil.ly/dojWy) 来解决模型学习中的错误。
- en: 'We can still do one thing to improve the performance without having to run
    through the whole dataset again: *offline evaluation*. This technique allows you
    to use existing data and retrain your model with various learning policies to
    find out which one works best for your data. Let’s try this out to see if we can
    get an even better model than the one we trained so far. From the top menu, choose
    “Offline evaluations,” as shown in [Figure 8-15](#creating_an_offline_evaluation).'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以通过*离线评估*来提高性能，而无需重新运行整个数据集。这种技术允许您使用现有数据，并通过各种学习策略重新训练模型，找出哪种策略最适合您的数据。让我们试试这个方法，看看是否能比我们迄今为止训练的模型效果更好。从顶部菜单中选择“离线评估”，如[图 8-15](#creating_an_offline_evaluation)所示。
- en: '![Creating an offline evaluation](Images/apbi_0815.png)'
  id: totrans-138
  prefs: []
  type: TYPE_IMG
  zh: '![创建离线评估](Images/apbi_0815.png)'
- en: Figure 8-15\. Creating an offline evaluation
  id: totrans-139
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-15\. 创建离线评估
- en: Double-check that the date range matches the day that you ran the simulation
    experiment and leave all other settings as they are. Click OK to start the offline
    evaluation, as shown in [Figure 8-16](#offline_evaluation_form).
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 双检查日期范围是否与您运行模拟实验的日期匹配，并将所有其他设置保持不变。单击“确定”以启动离线评估，如[图 8-16](#offline_evaluation_form)所示。
- en: '![Offline evaluation form](Images/apbi_0816.png)'
  id: totrans-141
  prefs: []
  type: TYPE_IMG
  zh: '![离线评估表单](Images/apbi_0816.png)'
- en: Figure 8-16\. Offline evaluation form
  id: totrans-142
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-16\. 离线评估表单
- en: The evaluation process takes a couple of minutes. Once it is completed, select
    the evaluation from the list to see further details. Click the link “Compare the
    score of your application with other potential learning settings” to see the evaluation
    metrics, shown in [Figure 8-17](#offline_evaluation_results).
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 评估过程大约需要几分钟时间。完成后，从列表中选择评估以查看更多详细信息。点击链接“与其他潜在学习设置比较您应用程序的分数”以查看评估指标，如[图 8-17](#offline_evaluation_results)所示。
- en: '![Offline evaluation results](Images/apbi_0817.png)'
  id: totrans-144
  prefs: []
  type: TYPE_IMG
  zh: '![离线评估结果](Images/apbi_0817.png)'
- en: Figure 8-17\. Offline evaluation results
  id: totrans-145
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-17\. 离线评估结果
- en: As you can see, from the offline evaluation we learned that we can improve our
    model from a 0.5363 average reward (Online as of Evaluation) to a 0.5775 average
    reward if we apply the learning setting Hyper1\. This is closer to the ideal scenario
    of 0.85, considering that we leave 15% out for exploration. Choose a new learning
    setting by clicking the Apply button next to it. This will retrain your model
    and deploy it with the new learning setting.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 正如您可以看到的，从离线评估中，我们了解到如果应用Hyper1学习设置，我们可以将我们的模型从0.5363的平均奖励（作为评估结果）提高到0.5775。考虑到我们留出15%用于探索，这更接近理想情况下的0.85。通过单击旁边的“应用”按钮选择新的学习设置。这将重新训练您的模型，并使用新的学习设置部署它。
- en: You could now go back to your code and run the simulation again to see how the
    model improves. But first we want to incorporate our AI recommendations into our
    BI dashboard. Let’s explore this in the last step of this use case.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 您现在可以回到代码中，再次运行模拟以查看模型的改进。但首先，我们希望将我们的AI建议整合到我们的BI仪表板中。让我们在此使用案例的最后一步中探索这一点。
- en: Model Inference with Power BI Walk-Through
  id: totrans-148
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Power BI中的模型推断演示
- en: As you might remember, our use case scenario already provides a BI dashboard
    that shows the current customer churn prediction as well as the overall acceptance
    rate of the standard offer, indicating the success of our customer retention strategy.
    What we want to do now is blend this information with insights on how our Personalization
    service is performing and see if our initiative leads to more customers accepting
    offers.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 正如您可能记得的那样，我们的使用案例场景已经提供了一个BI仪表板，显示了当前客户流失预测以及标准报价的整体接受率，表明我们客户保留策略的成功。现在我们想做的是将这些信息与我们的个性化服务的绩效见解结合起来，看看我们的举措是否导致更多客户接受报价。
- en: To start, open the Power BI workbook *Offer_Recommendation.pbix* from the [book’s
    website](https://oreil.ly/aLTWS) and head over to the data model. You should see
    the existing table structure here for the churn predictions. Let’s add the results
    from our model by importing the result CSV file that we created during the simulation.
    If you decided earlier to save the CSV file locally, choose Get data → Import
    Text/CSV and find the CSV file on your local computer.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，从[书的网站](https://oreil.ly/aLTWS)打开Power BI工作簿*Offer_Recommendation.pbix*，然后转到数据模型。您应该在这里看到用于客户流失预测的现有表结构。让我们通过导入模拟过程中创建的结果CSV文件，将我们的模型结果添加进去。如果您之前决定将CSV文件保存到本地，请选择获取数据
    → 导入文本/CSV，并找到本地计算机上的CSV文件。
- en: If you decide to save the file in Azure Blob Storage, choose Get data → Azure
    → Azure Blob Storage. Provide the name of your storage account that you provided
    earlier. In the next step, paste your access key that you got from the Azure portal.
    After you confirm these options, you should see a list with all containers and
    files on your blob storage, as shown in [Figure 8-18](#accessing_azure_blob_storage_from_power).
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 如果决定将文件保存在 Azure Blob 存储中，请选择“获取数据”→“Azure”→“Azure Blob 存储”。提供之前提供的存储帐户名称。在下一步中，粘贴从
    Azure 门户获取的访问密钥。确认这些选项后，您应该看到显示所有容器和文件的列表，如 [图 8-18](#accessing_azure_blob_storage_from_power)
    所示。
- en: '![Accessing Azure Blob Storage from Power BI](Images/apbi_0818.png)'
  id: totrans-152
  prefs: []
  type: TYPE_IMG
  zh: '![从 Power BI 访问 Azure Blob 存储](Images/apbi_0818.png)'
- en: Figure 8-18\. Accessing Azure Blob Storage from Power BI
  id: totrans-153
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-18\. 从 Power BI 访问 Azure Blob 存储
- en: Choose the container with your simulation data. But don’t load the file yet!
    Instead, click the Transform Data button. This will allow you to use Power Query
    to extract the actual contents of the CSV file. Otherwise, you would see only
    the CSV metadata such as its filename, creation date, and size.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 选择带有您的模拟数据的容器。但不要加载文件！而是点击“转换数据”按钮。这将允许您使用 Power Query 提取 CSV 文件的实际内容。否则，您将只看到
    CSV 的元数据，如文件名、创建日期和大小。
- en: In the Power Query Editor, click the Binary data link, as shown in [Figure 8-19](#accessing_blob_files_with_power_query_e).
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Power Query 编辑器中，单击二进制数据链接，如 [图 8-19](#accessing_blob_files_with_power_query_e)
    所示。
- en: '![Accessing blob files with Power Query Editor](Images/apbi_0819.png)'
  id: totrans-156
  prefs: []
  type: TYPE_IMG
  zh: '![使用 Power Query 编辑器访问 blob 文件](Images/apbi_0819.png)'
- en: Figure 8-19\. Accessing blob files with Power Query Editor
  id: totrans-157
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-19\. 使用 Power Query 编辑器访问 blob 文件
- en: This will bring you to the contents of the CSV file; the conversion from binary
    to tabular data is shown as a processing step in the Applied Steps pane on the
    right ([Figure 8-20](#importing_table_data_from_blob_storage)).
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 这将带您进入 CSV 文件的内容；将二进制数据转换为表格数据显示为“应用步骤”面板中的处理步骤（见右侧）（[图 8-20](#importing_table_data_from_blob_storage)）。
- en: '![Importing table data from blob storage](Images/apbi_0820.png)'
  id: totrans-159
  prefs: []
  type: TYPE_IMG
  zh: '![从 blob 存储导入表格数据](Images/apbi_0820.png)'
- en: Figure 8-20\. Importing table data from blob storage
  id: totrans-160
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-20\. 从 blob 存储导入表格数据
- en: Confirm the transformation by selecting Close & Apply from the top menu. The
    contents of the new CSV file will be added to your data model. Power BI will automatically
    generate the relationship between the Churntable and the simulation data models
    based the field CustomerID, as shown in [Figure 8-21](#data_relationship_in_power_bi).
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 通过从顶部菜单选择“关闭并应用”确认转换。新 CSV 文件的内容将添加到您的数据模型中。Power BI 将基于字段 CustomerID 自动为 Churntable
    和模拟数据模型生成关系，如 [图 8-21](#data_relationship_in_power_bi) 所示。
- en: '![Data relationship in Power BI](Images/apbi_0821.png)'
  id: totrans-162
  prefs: []
  type: TYPE_IMG
  zh: '![Power BI 中的数据关系](Images/apbi_0821.png)'
- en: Figure 8-21\. Data relationship in Power BI
  id: totrans-163
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-21\. Power BI 中的数据关系
- en: Building the AI-Powered Dashboard in Power BI
  id: totrans-164
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在 Power BI 中构建 AI 动力仪表板
- en: 'Head over to the BI report page and let’s do some modifications to include
    our new AI-based recommendations. Make the following changes to the report:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 转到 BI 报告页面，我们需要做一些修改，以包含我们的新基于 AI 的建议。对报告进行以下更改：
- en: 'Update the scatterplot visual:'
  id: totrans-166
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更新散点图视觉：
- en: 'Legend field: replace “Offer accepted?” with “Reward” from the simulation data
    model.'
  id: totrans-167
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 图例字段：从模拟数据模型中用“奖励”替换“接受报价？”。
- en: 'Change the color scheme under formatting and data colors: set Blank to gray,
    0 to red, and 1 to blue.'
  id: totrans-168
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 更改格式和数据颜色下的颜色方案：将空白设置为灰色，0 设置为红色，1 设置为蓝色。
- en: 'Update the gauge visual:'
  id: totrans-169
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更新仪表盘表：
- en: Replace “Average Offer accepted” with “Reward” from the “simulation” table.
    Apply the calculation “Average” to “Reward.”
  id: totrans-170
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将“平均接受报价”替换为“模拟”表中的“奖励”。将“奖励”应用于“平均”计算。
- en: 'Update the metric visual for the defended revenue:'
  id: totrans-171
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更新防御收入指标视觉：
- en: Add Reward = 1 to the visual filter.
  id: totrans-172
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将奖励 = 1添加到视觉筛选器中。
- en: Delete “Offer Accepted” from the visual filter.
  id: totrans-173
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从视觉筛选器中删除“接受报价”。
- en: 'Update the treemap visual:'
  id: totrans-174
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更新树状图表：
- en: Replace “Displayed offer” with “Prediction” in the group field. Adjust data
    colors in the formatting pane so that Blank matches gray, and all offers match
    shades of blue.
  id: totrans-175
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在组字段中，将“显示的报价”替换为“预测”。在格式设置窗格中调整数据颜色，以便空白匹配灰色，所有报价匹配蓝色的色调。
- en: The final dashboard should now look similar to [Figure 8-22](#ai_powered_recommendation_dashboard).
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 最终的仪表板现在应该看起来类似于 [图 8-22](#ai_powered_recommendation_dashboard)。
- en: '![AI-powered recommendation dashboard](Images/apbi_0822.png)'
  id: totrans-177
  prefs: []
  type: TYPE_IMG
  zh: '![AI 动力推荐仪表板](Images/apbi_0822.png)'
- en: Figure 8-22\. AI-powered recommendation dashboard
  id: totrans-178
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 8-22\. AI 动力推荐仪表板
- en: Let’s briefly compare this dashboard to the original one from the beginning
    of this chapter ([Figure 8-1](#baseline_churn_prevention_dashboard)). You will
    notice two major changes.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们简要比较这个仪表板与本章开头的原始仪表板（见[图8-1](#baseline_churn_prevention_dashboard)）。你会注意到两个主要变化。
- en: First, the gauge has increased from 0.31 to 0.54, an increase of 23 percentage
    points in accuracy compared to our existing baseline. This means that by using
    the AI-based approach, we could convince more customers to accept our retention
    offers. The defended monthly revenue consequently increased as well, to 154.38K,
    which is a plus of almost $60,000.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，与我们现有的基准相比，准确率从0.31上升到0.54，提高了23个百分点。这意味着通过使用基于AI的方法，我们可以说服更多客户接受我们的留存优惠。因此，捍卫的月收入也相应增加到了154.38K，几乎增加了6万美元。
- en: Second, we can see that the proportions of offers increased. The former most
    popular Offer 1 (Cash offer) is now only rarely happening. Most customers accepted
    Offer 3—the higher performance.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 其次，我们可以看到优惠的比例增加了。以前最受欢迎的优惠1（现金优惠）现在几乎不再发生。大多数客户接受了优惠3——更高的性能。
- en: Can we improve these KPIs even more? Remember that we tweaked our model through
    an offline evaluation previously. But we haven’t applied the new model yet.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以进一步改善这些KPI吗？记住，我们之前通过离线评估调整了我们的模型。但我们尚未应用新模型。
- en: Go back to the simulation code and rerun it once again without making any changes.
    After another 10 minutes, the code will have gone through the dataset once so
    the Personalizer service could use the updated learning settings. The *results.csv*
    file in your Azure Blob Storage should have been automatically updated. Therefore,
    all we need to do in Power BI is go to the data model and hit “Refresh data” for
    the “simulation” table, as shown in [Figure 8-23](#refreshing_the_data).
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 返回模拟代码，再次运行而不做任何更改。再过10分钟，代码将会处理一次数据集，因此个性化服务可以使用更新的学习设置。你的Azure Blob Storage中的*results.csv*文件应该已自动更新。因此，我们在Power
    BI中所需做的一切就是进入数据模型并点击“刷新数据”，如[图8-23](#refreshing_the_data)所示。
- en: '![Refreshing the data](Images/apbi_0823.png)'
  id: totrans-184
  prefs: []
  type: TYPE_IMG
  zh: '![刷新数据](Images/apbi_0823.png)'
- en: Figure 8-23\. Refreshing the data
  id: totrans-185
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图8-23\. 刷新数据
- en: After a few seconds, Power BI has fetched the updated data. If we go back to
    the report, we can see the updated recommendations in action ([Figure 8-24](#ai_powered_dashboard_after_the_data_ref)).
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 几秒钟后，Power BI已获取更新的数据。如果我们返回报告，我们可以看到更新的推荐实施情况（见[图8-24](#ai_powered_dashboard_after_the_data_ref)）。
- en: '![AI-powered dashboard after the data refresh](Images/apbi_0824.png)'
  id: totrans-187
  prefs: []
  type: TYPE_IMG
  zh: '![数据更新后的AI驱动仪表板](Images/apbi_0824.png)'
- en: Figure 8-24\. AI-powered dashboard after the data refresh
  id: totrans-188
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图8-24\. 数据更新后的AI驱动仪表板
- en: Iterating through the dataset once more with the updated learning settings has
    improved our recommendations by another 5 percentage points, hitting an accuracy
    of 59% now. The defended revenue has increased by another $17,680.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 通过更新的学习设置再次迭代数据集，我们的推荐又提高了5个百分点，现在达到了59%的准确率。捍卫的收入又增加了$17,680。
- en: For a real-world scenario, imagine that you are not iterating over the same
    dataset over and over again but over new customer data for each quarter, month,
    or day, depending on your business. This way, you can monitor how your recommendation
    model is performing and you can decide whether it is good enough to be released
    into production. At least the dashboard will give you a solid guideline to assess
    business value of the AI-backed recommendation service, in contrast to your existing
    baseline.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 对于实际场景，想象一下，你不是反复迭代相同的数据集，而是每个季度、月份或者每天都处理新的客户数据，这取决于你的业务。这样，你可以监控你的推荐模型的表现，并决定它是否足够好以投入生产。至少仪表板将为你提供一个坚实的指导，评估基于AI的推荐服务的业务价值，与你现有的基准进行对比。
- en: You can download the final Power BI file *Offer_Recommendation_AI-Powered.pbix*
    from the [book’s website](https://oreil.ly/aLTWS).
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以从[书籍网站](https://oreil.ly/aLTWS)下载最终的Power BI文件*Offer_Recommendation_AI-Powered.pbix*。
- en: Cleaning Up Resources
  id: totrans-192
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 清理资源
- en: 'Consider stopping or deleting the following resources we have used in this
    chapter to avoid any ongoing charges:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑停止或删除我们在本章中使用的以下资源，以避免任何持续的费用：
- en: Stop the compute instance.
  id: totrans-194
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 停止计算实例。
- en: Delete the Azure Personalizer Service resource.
  id: totrans-195
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 删除Azure Personalizer服务资源。
- en: Delete the CSV files in Azure Blob Storage.
  id: totrans-196
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 删除Azure Blob Storage中的CSV文件。
- en: We will still use some of these resources for the other chapters. If you don’t
    plan to do the use cases in the following chapters, you can delete all resources
    at once. Select “Resource groups” in your Azure portal, select the resource group
    that you created, and choose “Delete resource group.” Confirm the resource group
    name. Then click Delete.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 我们仍将在其他章节中使用这些资源。如果您不打算在接下来的章节中执行这些用例，可以一次性删除所有资源。在您的Azure门户中选择“资源组”，选择您创建的资源组，然后选择“删除资源组”。确认资源组名称，然后点击删除。
- en: Summary
  id: totrans-198
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: I hope you can see from this use case how we can utilize AI to turn predictions
    into actions and how to find out which actions fit in a given context. While Azure
    Personalizer is only one of many services, the ideas and principles behind these
    reinforcement learning–based recommendation engines are similar, and you should
    find it easy to pick up other services as well if needed. Also, with Azure Blob
    Storage, you learned a way to monitor model updates in real time and bring them
    into your BI without too much friction.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 我希望您能从这个用例中看到，我们如何利用AI将预测转化为行动，以及如何找出哪些行动适合特定的情境。虽然Azure Personalizer只是众多服务中的一个，但基于强化学习的推荐引擎背后的思想和原则是相似的，如果需要，您也会发现学习其他服务非常容易。此外，通过Azure
    Blob Storage，您学会了实时监控模型更新并将其无缝集成到您的BI中，过程也不会太过复杂。
- en: In the next chapter, we will tackle unstructured data and see how to leverage
    AI on images, documents, and audio files to analyze their content in our regular
    BI workflow and blend it with existing information from the business.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将处理非结构化数据，看看如何利用AI分析图像、文档和音频文件的内容，并将其融入我们常规的BI工作流程中，与来自业务的现有信息进行整合。
